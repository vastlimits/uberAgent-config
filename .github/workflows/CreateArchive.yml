name: Create config archive

on:
  push:
    branches-ignore:
    - "main"
    - "version/7.0"
    - "version/6.2"
    paths-ignore:
    - "config-dist/**"    # avoid recursion
    
env:
  SOURCE_DIR_PATH:  config/
  TARGET_DIR_PATH:  config-dist/
  TARGET_FILE:      uberAgent.uAConfig
  
jobs:
  create-archive:
    runs-on: ubuntu-latest
    steps:
    - name: Check out repo
      uses: actions/checkout@v3
      with:
        ref: ${{ github.ref_name }}
        token: ${{ secrets.VLSVC_PAT }}
        
    - name: Create archive file
      uses: thedoctor0/zip-release@0.7.1
      with:
        type: "zip"
        directory: "${{ env.SOURCE_DIR_PATH }}"
        filename: "${{ env.TARGET_FILE }}"
        
    - name: Move archive to target dir
      run: |
        # Print executed commands
        set -x
        
        mkdir -p "$TARGET_DIR_PATH"
        rm -f "$TARGET_DIR_PATH$TARGET_FILE"
        mv "$SOURCE_DIR_PATH$TARGET_FILE" "$TARGET_DIR_PATH"
        
    - name: Commit archive
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: Updated config archive
        commit_user_name: vastlimits
        commit_user_email: devops@vastlimits.com
