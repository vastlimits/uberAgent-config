name: uberAgent ESA Sigma rules

on:
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        branch: [ develop ]

    runs-on: ubuntu-latest

    env:
      PYTHONUNBUFFERED: 1
      GITHUB_ACTOR: ${{ github.actor }}
      GITHUB_TOKEN: ${{ secrets.VLSVC_PAT}}

    steps:
    - name: Checkout uberAgent-config
      uses: actions/checkout@v2
      with:
        token: ${{ secrets.VLSVC_PAT }}
        path: uberAgent-config

    - name: Checkout pySigma-backend-uberAgent
      uses: actions/checkout@v2
      with:
        token: ${{ secrets.VLSVC_PAT }}
        repository: vastlimits/pySigma-backend-uberAgent
        path: pySigma-backend-uberAgent

    - name: Checkout sigma-cli
      uses: actions/checkout@v2
      with:
        token: ${{ secrets.VLSVC_PAT }}
        repository: SigmaHQ/sigma-cli
        path: sigma-cli

    - name: Checkout sigma
      uses: actions/checkout@v2
      with:
        token: ${{ secrets.VLSVC_PAT }}
        repository: SigmaHQ/sigma
        path: sigma

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: "3.10"

    - name: Install Poetry
      uses: abatilo/actions-poetry@v2.0.0
      with:
        poetry-version: "1.4.2"

    - name: Install
      working-directory: ./sigma-cli
      run: poetry install

    - name: Install pySigma-backend-uberAgent from pyPI
      working-directory: ./sigma-cli
      run: poetry add pySigma-backend-uberAgent

    - name: Shell
      working-directory: ./sigma-cli
      run: poetry run sigma list pipelines

    - name: Create build directory
      run: mkdir build

    - name: Rules
      working-directory: build
      run: |
        # Activate poetry shell from sigma-cli in this shell
        . $(cd $GITHUB_WORKSPACE/sigma-cli ; poetry env info --path)/bin/activate

        # Copy rules
        chmod +x $GITHUB_WORKSPACE/pySigma-backend-uberAgent/copy-rules.py
        $GITHUB_WORKSPACE/pySigma-backend-uberAgent/copy-rules.py "$GITHUB_WORKSPACE/sigma/rules"

        # Convert rules
        $GITHUB_WORKSPACE/pySigma-backend-uberAgent/convert-rules.sh $(pwd)

    - name: List
      working-directory: build
      run: ls -la
