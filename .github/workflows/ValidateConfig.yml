name: Validate configuration
on:
  push:
    branches-ignore:
    - "main"
    - "version/7.0"
    - "version/6.2"
    paths-ignore:
    - "config-dist/**"    # avoid recursion
  pull_request:
    branches:
    - develop


env:
  uAConfigCheck_FEED: uAConfigCheck
  uAConfigCheck_EXE_Artifact_Version: '*'
  uAConfigCheck_EXE_Artifact_Package: uaconfigcheck
  uAConfigCheck_DLL_Artifact_Version: '*'
  uAConfigCheck_DLL_Artifact_Package: uberagent-develop

jobs:
  download-config:
    # Add "id-token" with the intended permissions.
    permissions:
      id-token: write
      contents: read

    runs-on: ubuntu-latest
    steps:
    
    - name: 'Login via azure/login@v1'
      uses: azure/login@v1
      with:
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        allow-no-subscriptions: true
        environment: azurecloud

    - name: download uAConfigCheck exe
      uses: azure/CLI@v1
      with:
        azcliversion: 2.55.0
        inlineScript: |
          az extension add --name azure-devops
          
          az artifacts universal download --organization https://dev.azure.com/vastlimits \
                                          --project uAConfigCheck --scope project --feed $uAConfigCheck_FEED \
                                          --name $uAConfigCheck_EXE_Artifact_Package --version "$uAConfigCheck_EXE_Artifact_Version" \
                                          --path . \
                                          --file-filter 'uAConfigCheck.exe'
          
    - name: download uAConfigCheck dll
      uses: azure/CLI@v1
      with:
        azcliversion: 2.55.0
        inlineScript: |
          az extension add --name azure-devops
          
          az artifacts universal download --organization https://dev.azure.com/vastlimits \
                                          --project uAConfigCheck --scope project --feed $uAConfigCheck_FEED \
                                          --name $uAConfigCheck_DLL_Artifact_Package --version "$uAConfigCheck_DLL_Artifact_Version" \
                                          --path ./releases/ \
                                          --file-filter 'uberAgent-develop.dll'
    
    - uses: actions/upload-artifact@v4
      with:
        name: uAConfigCheck
        path: |
          ./uAConfigCheck.exe
          ./releases/uberAgent-develop.dll
        retention-days: 1


  validate-config:
    needs: [download-config]
    runs-on: windows-latest
    steps:
    
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - uses: actions/download-artifact@v4
      with:
        name: uAConfigCheck
    
    - name: 'validate configuration uAConfigCheck'
      run: |
        .\uAConfigCheck.exe -t -w -v develop -f .\config\uberAgent.conf
      continue-on-error: false

    # TODO: maybe it's possible to use github's actions cache instead of upload-artifact/download-artifact,
    #       But it's not clear yet how it behaves in the face of concurrency.
    #       Also, one would have to clean the cache at the end of the workflow:
    #       https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows#force-deleting-cache-entries
