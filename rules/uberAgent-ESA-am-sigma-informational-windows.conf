#
# The rules are generated from the Sigma GitHub repository at https://github.com/SigmaHQ/sigma
# Follow these steps to get the latest rules from the repository with Python
#    1. Clone the repository locally
#    2. Using a commandline, change working directory to the just cloned repository
#    3. Run sigmac -I --target uberagent -r rules/
#
# The rules in this file are marked with sigma-level: informational
#

[ActivityMonitoringRule platform=Windows]
# Detects non wmiprvse loading WMI modules
RuleId = 671bb7e3-a020-4824-a00e-2ee5b55f385e
RuleName = WMI Modules Loaded
EventType = Image.Load
Tag = wmi-modules-loaded
RiskScore = 1
Annotation = {"mitre_attack": ["T1047"]}
Query = (((Image.Path like r"%\\wmiclnt.dll" or Image.Path like r"%\\WmiApRpl.dll" or Image.Path like r"%\\wmiprov.dll" or Image.Path like r"%\\wmiutils.dll" or Image.Path like r"%\\wbemcomn.dll" or Image.Path like r"%\\wbemprox.dll" or Image.Path like r"%\\WMINet\_Utils.dll" or Image.Path like r"%\\wbemsvc.dll" or Image.Path like r"%\\fastprox.dll") and not ((Process.Path like r"%\\WmiPrvSE.exe" or Process.Path like r"%\\WmiApSrv.exe" or Process.Path like r"%\\svchost.exe" or Process.Path like r"%\\DeviceCensus.exe" or Process.Path like r"%\\CompatTelRunner.exe" or Process.Path like r"%\\sdiagnhost.exe" or Process.Path like r"%\\SIHClient.exe" or Process.Path like r"%\\ngentask.exe" or Process.Path like r"%\\windows\\system32\\taskhostw.exe" or Process.Path like r"%\\windows\\system32\\MoUsoCoreWorker.exe" or Process.Path like r"%\\windows\\system32\\wbem\\WMIADAP.exe" or Process.Path like r"%C:\\Windows\\Sysmon64.exe" or Process.Path like r"%C:\\Windows\\Sysmon.exe" or Process.Path like r"%C:\\Windows\\System32\\wbem\\unsecapp.exe" or Process.Path like r"%\\logman.exe" or Process.Path like r"%\\systeminfo.exe" or Process.Path like r"%\\nvcontainer.exe" or Process.Path like r"%C:\\Windows\\System32\\wbem\\WMIC.exe" or Process.Path like r"%\\explorer.exe" or Process.Path like r"%\\opera\_autoupdate.exe" or Process.Path like r"%\\MsMpEng.exe" or Process.Path like r"%\\thor64.exe" or Process.Path like r"%\\thor.exe"))) and not ((Process.Path like r"C:\\Program Files\\%" or Process.Path like r"C:\\Program Files (x86)\\%")))
GenericProperty1 = Image.Path

[ActivityMonitoringRule platform=Windows]
# Detects the load of advapi31.dll by a process running in an uncommon folder
RuleId = d813d662-785b-42ca-8b4a-f7457d78d5a9
RuleName = Suspicious Load of Advapi31.dll
EventType = Image.Load
Tag = suspicious-load-of-advapi31.dll
RiskScore = 1
Annotation = {"mitre_attack": ["T1070"]}
Query = (Image.Path like r"%\\advapi32.dll" and not (((Process.Path like r"C:\\Windows\\%" or Process.Path like r"C:\\Program Files (x86)\\%" or Process.Path like r"C:\\Program Files\\%")) or (Process.Path like r"C:\\ProgramData\\Microsoft\\Windows Defender\\platform\\%" and Process.Path like r"%\\MpCmdRun.exe") or (Process.Path like r"C:\\Users\\%" and Process.Path like r"%\\AppData\\Local\\Microsoft\\OneDrive\\%" and Process.Path like r"%FileCoAuth.exe")))
GenericProperty1 = Image.Path

[ActivityMonitoringRule platform=Windows]
# Detect DLL Load from Spooler Service backup folder
RuleId = 02fb90de-c321-4e63-a6b9-25f4b03dfd14
RuleName = Windows Spooler Service Suspicious Binary Load
EventType = Image.Load
Tag = windows-spooler-service-suspicious-binary-load
RiskScore = 1
Annotation = {"mitre_attack": ["T1574"]}
Query = (Process.Path like r"%\\spoolsv.exe" and (Image.Path like r"%\\Windows\\System32\\spool\\drivers\\x64\\3\\%" or Image.Path like r"%\\Windows\\System32\\spool\\drivers\\x64\\4\\%") and Image.Path like r"%.dll")
GenericProperty1 = Image.Path

