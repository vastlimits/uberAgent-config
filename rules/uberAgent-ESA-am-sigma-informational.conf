#
# The rules are generated from the Sigma GitHub repository at https://github.com/SigmaHQ/sigma
# Follow these steps to get the latest rules from the repository with Python
#    1. Clone the repository locally
#    2. Using a commandline, change working directory to the just cloned repository
#    3. Run sigmac -I --target uberagent -r rules/
#
# The rules in this file are marked with sigma-level: informational
#

[ActivityMonitoringRule]
# Adversaries may shutdown/reboot systems to interrupt access to, or aid in the destruction of, those systems.
# Author: Igor Fits, Mikhail Larin, oscd.community
RuleId = 40b1fbe2-18ea-4ee7-be47-0294285811de
RuleName = System Shutdown/Reboot - MacOs
EventType = Process.Start
Tag = proc-start-system-shutdown/reboot-macos
RiskScore = 1
Annotation = {"mitre_attack": ["T1529"]}
Query = (Process.Path like r"%/shutdown" or Process.Path like r"%/reboot" or Process.Path like r"%/halt")

[ActivityMonitoringRule]
# Detects the usage of tooling to sniff network traffic.
# An adversary may place a network interface into promiscuous mode to passively access data in transit over the network, or use span ports to capture a larger amount of data.
# Author: Alejandro Ortuno, oscd.community
RuleId = adc9bcc4-c39c-4f6b-a711-1884017bf043
RuleName = Network Sniffing - MacOs
EventType = Process.Start
Tag = proc-start-network-sniffing-macos
RiskScore = 1
Annotation = {"mitre_attack": ["T1040"]}
Query = (Process.Path like r"%/tcpdump" or Process.Path like r"%/tshark")

[ActivityMonitoringRule]
# Detects enumeration of local system groups
# Author: Ömer Günal, Alejandro Ortuno, oscd.community
RuleId = 89bb1f97-c7b9-40e8-b52b-7d6afbd67276
RuleName = Local Groups Discovery - MacOs
EventType = Process.Start
Tag = proc-start-local-groups-discovery-macos
RiskScore = 1
Annotation = {"mitre_attack": ["T1069.001"]}
Query = ((Process.Path like r"%/dscacheutil" and Process.CommandLine like r"%-q%" and Process.CommandLine like r"%group%") or (Process.Path like r"%/cat" and Process.CommandLine like r"%/etc/group%") or (Process.Path like r"%/dscl" and Process.CommandLine like r"%-list%" and Process.CommandLine like r"%/groups%"))

[ActivityMonitoringRule]
# Detects usage of system utilities to discover system network connections
# Author: Daniil Yugoslavskiy, oscd.community
RuleId = 9a7a0393-2144-4626-9bf1-7c2f5a7321db
RuleName = System Network Connections Discovery - MacOs
EventType = Process.Start
Tag = proc-start-system-network-connections-discovery-macos
RiskScore = 1
Annotation = {"mitre_attack": ["T1049"]}
Query = (Process.Path like r"%/who" or Process.Path like r"%/w" or Process.Path like r"%/last" or Process.Path like r"%/lsof" or Process.Path like r"%/netstat")

[ActivityMonitoringRule]
# Detects enumeration of local network configuration
# Author: remotephone, oscd.community
RuleId = 58800443-f9fc-4d55-ae0c-98a3966dfb97
RuleName = System Network Discovery - macOS
EventType = Process.Start
Tag = proc-start-system-network-discovery-macos
RiskScore = 1
Annotation = {"mitre_attack": ["T1016"]}
Query = ((Process.Path like r"%/netstat" or Process.Path like r"%/ifconfig" or Process.Path like r"%/socketfilterfw" or Process.Path like r"%/networksetup" or Process.Path like r"%/arp") or (Process.Path == "/usr/bin/defaults" and Process.CommandLine like r"%read%" and Process.CommandLine like r"%/Library/Preferences/com.apple.alf%"))

[ActivityMonitoringRule]
# Detects the enumeration of other remote systems.
# Author: Alejandro Ortuno, oscd.community
RuleId = 10227522-8429-47e6-a301-f2b2d014e7ad
RuleName = Macos Remote System Discovery
EventType = Process.Start
Tag = proc-start-macos-remote-system-discovery
RiskScore = 1
Annotation = {"mitre_attack": ["T1018"]}
Query = ((Process.Path like r"%/arp" and Process.CommandLine like r"%-a%") or (Process.Path like r"%/ping" and (Process.CommandLine like r"% 10.%" or Process.CommandLine like r"% 192.168.%" or Process.CommandLine like r"% 172.16.%" or Process.CommandLine like r"% 172.17.%" or Process.CommandLine like r"% 172.18.%" or Process.CommandLine like r"% 172.19.%" or Process.CommandLine like r"% 172.20.%" or Process.CommandLine like r"% 172.21.%" or Process.CommandLine like r"% 172.22.%" or Process.CommandLine like r"% 172.23.%" or Process.CommandLine like r"% 172.24.%" or Process.CommandLine like r"% 172.25.%" or Process.CommandLine like r"% 172.26.%" or Process.CommandLine like r"% 172.27.%" or Process.CommandLine like r"% 172.28.%" or Process.CommandLine like r"% 172.29.%" or Process.CommandLine like r"% 172.30.%" or Process.CommandLine like r"% 172.31.%" or Process.CommandLine like r"% 127.%" or Process.CommandLine like r"% 169.254.%")))

[ActivityMonitoringRule]
# Adversaries may attempt to get information about running processes on a system. Information obtained could be used to gain an understanding of common software/applications running on systems within the network
# Author: frack113
RuleId = 63332011-f057-496c-ad8d-d2b6afb27f96
RuleName = Suspicious Tasklist Discovery Command
EventType = Process.Start
Tag = proc-start-suspicious-tasklist-discovery-command
RiskScore = 1
Annotation = {"mitre_attack": ["T1057"]}
Query = (Process.CommandLine like r"%tasklist%" or Process.Path like r"%\\tasklist.exe" or Process.Name == "tasklist.exe")

[ActivityMonitoringRule]
# Detects non wmiprvse loading WMI modules
# Author: Roberto Rodriguez @Cyb3rWard0g
RuleId = 671bb7e3-a020-4824-a00e-2ee5b55f385e
RuleName = WMI Modules Loaded
EventType = Image.Load
Tag = wmi-modules-loaded
RiskScore = 1
Annotation = {"mitre_attack": ["T1047"]}
Query = (((Image.Path like r"%\\wmiclnt.dll" or Image.Path like r"%\\WmiApRpl.dll" or Image.Path like r"%\\wmiprov.dll" or Image.Path like r"%\\wmiutils.dll" or Image.Path like r"%\\wbemcomn.dll" or Image.Path like r"%\\wbemprox.dll" or Image.Path like r"%\\WMINet\_Utils.dll" or Image.Path like r"%\\wbemsvc.dll" or Image.Path like r"%\\fastprox.dll") and not ((Process.Path like r"%\\WmiPrvSE.exe" or Process.Path like r"%\\WmiApSrv.exe" or Process.Path like r"%\\svchost.exe" or Process.Path like r"%\\DeviceCensus.exe" or Process.Path like r"%\\CompatTelRunner.exe" or Process.Path like r"%\\sdiagnhost.exe" or Process.Path like r"%\\SIHClient.exe" or Process.Path like r"%\\ngentask.exe" or Process.Path like r"%\\windows\\system32\\taskhostw.exe" or Process.Path like r"%\\windows\\system32\\MoUsoCoreWorker.exe" or Process.Path like r"%\\windows\\system32\\wbem\\WMIADAP.exe" or Process.Path like r"%C:\\Windows\\Sysmon64.exe" or Process.Path like r"%C:\\Windows\\Sysmon.exe" or Process.Path like r"%C:\\Windows\\System32\\wbem\\unsecapp.exe" or Process.Path like r"%\\logman.exe" or Process.Path like r"%\\systeminfo.exe" or Process.Path like r"%\\nvcontainer.exe" or Process.Path like r"%C:\\Windows\\System32\\wbem\\WMIC.exe" or Process.Path like r"%\\explorer.exe" or Process.Path like r"%\\opera\_autoupdate.exe" or Process.Path like r"%\\MsMpEng.exe" or Process.Path like r"%\\thor64.exe" or Process.Path like r"%\\thor.exe"))) and not ((Process.Path like r"C:\\Program Files\\%" or Process.Path like r"C:\\Program Files (x86)\\%")))
GenericProperty1 = Image.Path

[ActivityMonitoringRule]
# Detect DLL Load from Spooler Service backup folder
# Author: FPT.EagleEye, Thomas Patzke (improvements)
RuleId = 02fb90de-c321-4e63-a6b9-25f4b03dfd14
RuleName = Windows Spooler Service Suspicious Binary Load
EventType = Image.Load
Tag = windows-spooler-service-suspicious-binary-load
RiskScore = 1
Annotation = {"mitre_attack": ["T1574"]}
Query = (Process.Path like r"%\\spoolsv.exe" and (Image.Path like r"%\\Windows\\System32\\spool\\drivers\\x64\\3\\%" or Image.Path like r"%\\Windows\\System32\\spool\\drivers\\x64\\4\\%") and Image.Path like r"%.dll")
GenericProperty1 = Image.Path

[ActivityMonitoringRule]
# Detects the load of advapi31.dll by a process running in an uncommon folder
# Author: frack113
RuleId = d813d662-785b-42ca-8b4a-f7457d78d5a9
RuleName = Suspicious Load of Advapi31.dll
EventType = Image.Load
Tag = suspicious-load-of-advapi31.dll
RiskScore = 1
Annotation = {"mitre_attack": ["T1070"]}
Query = (Image.Path like r"%\\advapi32.dll" and not (((Process.Path like r"C:\\Windows\\%" or Process.Path like r"C:\\Program Files (x86)\\%" or Process.Path like r"C:\\Program Files\\%")) or (Process.Path like r"C:\\ProgramData\\Microsoft\\Windows Defender\\platform\\%" and Process.Path like r"%\\MpCmdRun.exe") or (Process.Path like r"C:\\Users\\%" and Process.Path like r"%\\AppData\\Local\\Microsoft\\OneDrive\\%" and Process.Path like r"%FileCoAuth.exe")))
GenericProperty1 = Image.Path

