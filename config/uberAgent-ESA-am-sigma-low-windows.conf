
#
# The rules are generated from the Sigma GitHub repository at https://github.com/SigmaHQ/sigma
# To generate the ruleset, please follow the instructions provided in the repository: https://github.com/vastlimits/pySigma-backend-uberAgent/
#
# The command used to generate the ruleset is:
#    sigma convert -s -f conf -p uberagent-develop -O backend_version=develop -t uberagent /home/runner/work/uberAgent-config/uberAgent-config/build/sigma-low-windows >> uberAgent-ESA-am-sigma-low-windows.conf
#

[ThreatDetectionRule platform=Windows]
# Detects the execution of whoami, which is often used by attackers after exploitation / privilege escalation
# Author: Florian Roth (Nextron Systems)
RuleId = e28a5a99-da44-436d-b7a0-2afc20a5f413
RuleName = Whoami Utility Execution
EventType = Process.Start
Tag = proc-start-whoami-utility-execution
RiskScore = 25
Annotation = {"mitre_attack": ["T1033"], "author": "Florian Roth (Nextron Systems)"}
Query = Process.Path like r"%\\whoami.exe" or Process.Name == "whoami.exe"


[ThreatDetectionRule platform=Windows]
# Detects the creation of a scheduled task via Registry keys.
# Author: Center for Threat Informed Defense (CTID) Summiting the Pyramid Team
RuleId = 93ff0ceb-e0ef-4586-8cd8-a6c277d738e3
RuleName = Scheduled Task Created - Registry
EventType = Reg.Any
Tag = scheduled-task-created-registry
RiskScore = 25
Annotation = {"mitre_attack": ["T1053.005"], "author": "Center for Threat Informed Defense (CTID) Summiting the Pyramid Team"}
Query = Reg.TargetObject like r"%\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tasks\\%" or Reg.TargetObject like r"%\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tree\\%"
Hive = HKLM,HKU
GenericProperty1 = Reg.TargetObject


[ThreatDetectionRule platform=Windows]
# Detects the loading of the "taskschd.dll" module from a process that located in a potentially suspicious or uncommon directory.
# The loading of this DLL might indicate that the application have the capability to create a scheduled task via the "Schedule.Service" COM object.
# Investigation of the loading application and its behavior is required to determining if its malicious.
# Author: Swachchhanda Shrawan Poudel
RuleId = 3b92a1d0-8d4b-4d28-a1b4-1e29d49a6a3e
RuleName = Task Scheduler DLL Loaded By Application Located In Potentially Suspicious Location
EventType = Image.Load
Tag = task-scheduler-dll-loaded-by-application-located-in-potentially-suspicious-location
RiskScore = 25
Annotation = {"mitre_attack": ["T1053.005"], "author": "Swachchhanda Shrawan Poudel"}
Query = (Image.Path like r"%\\taskschd.dll" or Process.Name == "taskschd.dll") and (Process.Path like r"%:\\Temp\\%" or Process.Path like r"%:\\Users\\Public\\%" or Process.Path like r"%:\\Windows\\Temp\\%" or Process.Path like r"%\\AppData\\Local\\Temp\\%" or Process.Path like r"%\\Desktop\\%" or Process.Path like r"%\\Downloads\\%")
GenericProperty1 = Image.Path


[ThreatDetectionRule platform=Windows]
# Detects registry modifications related to the proxy configuration of the system, potentially associated with the Raspberry Robin malware, as seen in campaigns running in Q1 2024.
# Raspberry Robin may alter proxy settings to circumvent security measures, ensuring unhindered connection with Command and Control servers for maintaining control over compromised systems if there are any proxy settings that are blocking connections.
# Author: Swachchhanda Shrawan Poudel
RuleId = 16a4c7b3-4681-49d0-8d58-3e9b796dcb43
RuleName = Potential Raspberry Robin Registry Set Internet Settings ZoneMap
EventType = Reg.Any
Tag = potential-raspberry-robin-registry-set-internet-settings-zonemap
RiskScore = 25
Annotation = {"mitre_attack": ["T1112"], "author": "Swachchhanda Shrawan Poudel"}
Query = (Process.Path like r"%\\AppData\\Local\\Temp\\%" or Process.Path like r"%\\Downloads\\%" or Process.Path like r"%\\Users\\Public\\%" or Process.Path like r"%\\Windows\\Temp\\%" or Process.Path like r"%\\control.exe") and Reg.TargetObject like r"%\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ZoneMap\\%" and ((Reg.TargetObject like r"%\\IntranetName" or Reg.TargetObject like r"%\\ProxyByPass" or Reg.TargetObject like r"%\\UNCAsIntranet") and Reg.Value.Data like r"%DWORD (0x00000001)%" or Reg.TargetObject like r"%\\AutoDetect" and Reg.Value.Data like r"%DWORD (0x00000000)%")
Hive = HKLM,HKU
GenericProperty1 = Reg.TargetObject
GenericProperty2 = Reg.Value.Data


[ThreatDetectionRule platform=Windows]
# Detects the export of the target Registry key to a file.
# Author: Oddvar Moe, Sander Wiebing, oscd.community
RuleId = f0e53e89-8d22-46ea-9db5-9d4796ee2f8a
RuleName = Exports Registry Key To a File
EventType = Process.Start
Tag = proc-start-exports-registry-key-to-a-file
RiskScore = 25
Annotation = {"mitre_attack": ["T1012"], "author": "Oddvar Moe, Sander Wiebing, oscd.community"}
Query = (Process.Path like r"%\\regedit.exe" or Process.Name == "REGEDIT.EXE") and (Process.CommandLine like r"% -E %" or Process.CommandLine like r"% /E %" or Process.CommandLine like r"% –E %" or Process.CommandLine like r"% —E %" or Process.CommandLine like r"% ―E %") and not ((Process.CommandLine like r"%hklm%" or Process.CommandLine like r"%hkey\_local\_machine%") and (Process.CommandLine like r"%\\system" or Process.CommandLine like r"%\\sam" or Process.CommandLine like r"%\\security"))


[ThreatDetectionRule platform=Windows]
# Detects changes to the registry values related to outlook that indicates that a reminder was triggered for a Note or Task item. This could be a sign of exploitation of CVE-2023-23397. Further investigation is required to determine the success of an exploitation.
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = fc06e655-d98c-412f-ac76-05c2698b1cb2
RuleName = Outlook Task/Note Reminder Received
EventType = Reg.Any
Tag = outlook-task/note-reminder-received
RiskScore = 25
Annotation = {"mitre_attack": ["T1137"], "author": "Nasreddine Bencherchali (Nextron Systems)"}
Query = Reg.TargetObject like r"%\\SOFTWARE\\Microsoft\\Office\\%" and Reg.TargetObject like r"%\\Outlook\\%" and (Reg.TargetObject like r"%\\Tasks\\%" or Reg.TargetObject like r"%\\Notes\\%")
Hive = HKLM,HKU
GenericProperty1 = Reg.TargetObject


[ThreatDetectionRule platform=Windows]
# Detects usage of "rar" to add files to an archive for potential compression. An adversary may compress data (e.g. sensitive documents) that is collected prior to exfiltration in order to make it portable and minimize the amount of data sent over the network.
# Author: Timur Zinniatullin, E.M. Anhaus, oscd.community
RuleId = 6f3e2987-db24-4c78-a860-b4f4095a7095
RuleName = Files Added To An Archive Using Rar.EXE
EventType = Process.Start
Tag = proc-start-files-added-to-an-archive-using-rar.exe
RiskScore = 25
Annotation = {"mitre_attack": ["T1560.001"], "author": "Timur Zinniatullin, E.M. Anhaus, oscd.community"}
Query = Process.Path like r"%\\rar.exe" and Process.CommandLine like r"% a %"


[ThreatDetectionRule platform=Windows]
# Detects attempts to access the "unattend.xml" file, where credentials might be stored.
# This file is used during the unattended windows install process.
# Author: frack113
RuleId = 76a26006-0942-430b-8249-bd51d448f8e5
RuleName = Unattend.XML File Access Attempt
EventType = File.Read
Tag = unattend.xml-file-access-attempt
RiskScore = 25
Annotation = {"mitre_attack": ["T1552.001"], "author": "frack113"}
Query = File.Path like r"%\\Panther\\unattend.xml"
GenericProperty1 = File.Path


[ThreatDetectionRule platform=Windows]
# Detects PowerShell creating a PowerShell file (.ps1). While often times this behavior is benign, sometimes it can be a sign of a dropper script trying to achieve persistence.
# Author: frack113
RuleId = 576426ad-0131-4001-ae01-be175da0c108
RuleName = PowerShell Script Dropped Via PowerShell.EXE
EventType = File.Create
Tag = powershell-script-dropped-via-powershell.exe
RiskScore = 25
Annotation = {"author": "frack113"}
Query = (Process.Path like r"%\\powershell.exe" or Process.Path like r"%\\pwsh.exe") and File.Path like r"%.ps1" and not (File.Path like r"%\_\_PSScriptPolicyTest\_%" or File.Path like r"C:\\Users\\%" and File.Path like r"%\\AppData\\Local\\Temp\\%" or File.Path like r"C:\\Windows\\Temp\\%")
GenericProperty1 = File.Path


[ThreatDetectionRule platform=Windows]
# Detects when when a mounted share is removed. Adversaries may remove share connections that are no longer useful in order to clean up traces of their operation
# Author: oscd.community, @redcanary, Zach Stanford @svch0st
RuleId = cb7c4a03-2871-43c0-9bbb-18bbdb079896
RuleName = Unmount Share Via Net.EXE
EventType = Process.Start
Tag = proc-start-unmount-share-via-net.exe
RiskScore = 25
Annotation = {"mitre_attack": ["T1070.005"], "author": "oscd.community, @redcanary, Zach Stanford @svch0st"}
Query = (Process.Path like r"%\\net.exe" or Process.Path like r"%\\net1.exe" or Process.Name in ["net.exe", "net1.exe"]) and Process.CommandLine like r"%share%" and Process.CommandLine like r"%/delete%"


[ThreatDetectionRule platform=Windows]
# Detects filename indicators associated with the SNAKE malware as reported by CISA in their report
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = 99eccc2b-7182-442f-8806-b76cc36d866b
RuleName = SNAKE Malware Installer Name Indicators
EventType = File.Create
Tag = snake-malware-installer-name-indicators
RiskScore = 25
Annotation = {"author": "Nasreddine Bencherchali (Nextron Systems)"}
Query = File.Path like r"%\\jpsetup.exe" or File.Path like r"%\\jpinst.exe"
GenericProperty1 = File.Path


[ThreatDetectionRule platform=Windows]
# Detects usage of the "Import-Module" cmdlet in order to add new Cmdlets to the current PowerShell session
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = 4ad74d01-f48c-42d0-b88c-b31efa4d2262
RuleName = Import New Module Via PowerShell CommandLine
EventType = Process.Start
Tag = proc-start-import-new-module-via-powershell-commandline
RiskScore = 25
Annotation = {"author": "Nasreddine Bencherchali (Nextron Systems)"}
Query = (Process.Path like r"%\\powershell.exe" or Process.Path like r"%\\pwsh.exe" or Process.Name in ["PowerShell.EXE", "pwsh.dll"]) and (Process.CommandLine like r"%Import-Module %" or Process.CommandLine like r"%ipmo %") and not ((Parent.Path like r"%:\\Program Files\\WindowsApps\\Microsoft.WindowsTerminal\_%" or Parent.Path like r"%:\\Windows\\System32\\cmd.exe%") and Process.CommandLine like r"%:\\Program Files\\Microsoft Visual Studio\\%" and Process.CommandLine like r"%Tools\\Microsoft.VisualStudio.DevShell.dll%")
GenericProperty1 = Parent.Path


[ThreatDetectionRule platform=Windows]
# Detects modification of the registry settings used for Internet Explorer and other Windows components that use these settings. An attacker can abuse this registry key to add a domain to the trusted sites Zone or insert javascript for persistence
# Author: frack113
RuleId = d88d0ab2-e696-4d40-a2ed-9790064e66b3
RuleName = Modification of IE Registry Settings
EventType = Reg.Any
Tag = modification-of-ie-registry-settings
RiskScore = 25
Annotation = {"mitre_attack": ["T1112"], "author": "frack113"}
Query = Reg.TargetObject like r"%\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings%" and not (Reg.Value.Data like r"DWORD%" or Reg.Value.Data in ["Cookie:", "Visited:", "(Empty)"] or Reg.TargetObject like r"%\\Cache%" or Reg.TargetObject like r"%\\ZoneMap%" or Reg.TargetObject like r"%\\WpadDecision%" or Reg.Value.Data == "Binary Data" or Reg.TargetObject like r"%\\Accepted Documents\\%")
Hive = HKLM,HKU
GenericProperty1 = Reg.TargetObject
GenericProperty2 = Reg.Value.Data


[ThreatDetectionRule platform=Windows]
# Detects file access requests to chromium based browser sensitive files by uncommon processes.
# Could indicate potential attempt of stealing sensitive information.
# Author: X__Junior (Nextron Systems)
RuleId = c5f37810-a85f-4186-81e9-33f23abb4141
RuleName = Access To Chromium Browsers Sensitive Files By Uncommon Applications
EventType = File.Read
Tag = access-to-chromium-browsers-sensitive-files-by-uncommon-applications
RiskScore = 25
Annotation = {"mitre_attack": ["T1003"], "author": "X__Junior (Nextron Systems)"}
Query = (File.Path like r"%\\User Data\\Default\\Cookies%" or File.Path like r"%\\User Data\\Default\\History%" or File.Path like r"%\\User Data\\Default\\Network\\Cookies%" or File.Path like r"%\\User Data\\Default\\Web Data%") and not (Process.Path == "System" or Process.Path like r"C:\\Program Files (x86)\\%" or Process.Path like r"C:\\Program Files\\%" or Process.Path like r"C:\\Windows\\system32\\%" or Process.Path like r"C:\\Windows\\SysWOW64\\%") and not (Process.Path like r"C:\\ProgramData\\Microsoft\\Windows Defender\\%" and (Process.Path like r"%\\MpCopyAccelerator.exe" or Process.Path like r"%\\MsMpEng.exe"))
GenericProperty1 = File.Path


[ThreatDetectionRule platform=Windows]
# Detects execution of "sc.exe" to query information about registered services on the system
# Author: frack113
RuleId = 57712d7a-679c-4a41-a913-87e7175ae429
RuleName = SC.EXE Query Execution
EventType = Process.Start
Tag = proc-start-sc.exe-query-execution
RiskScore = 25
Annotation = {"mitre_attack": ["T1007"], "author": "frack113"}
Query = Process.Path like r"%\\sc.exe" and Process.Name == "sc.exe" and Process.CommandLine like r"% query%" and not Process.CommandLine == "sc query dokan1"


[ThreatDetectionRule platform=Windows]
# Detects the execution of regini.exe which can be used to modify registry keys, the changes are imported from one or more text files.
# Author: Eli Salem, Sander Wiebing, oscd.community
RuleId = 5f60740a-f57b-4e76-82a1-15b6ff2cb134
RuleName = Registry Modification Via Regini.EXE
EventType = Process.Start
Tag = proc-start-registry-modification-via-regini.exe
RiskScore = 25
Annotation = {"mitre_attack": ["T1112"], "author": "Eli Salem, Sander Wiebing, oscd.community"}
Query = (Process.Path like r"%\\regini.exe" or Process.Name == "REGINI.EXE") and not Process.CommandLine regex ":[^ \\\\]"


[ThreatDetectionRule platform=Windows]
# Detects the load of known vulnerable drivers via the file name of the drivers.
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = 72cd00d6-490c-4650-86ff-1d11f491daa1
RuleName = Vulnerable Driver Load By Name
EventType = Driver.Load
Tag = vulnerable-driver-load-by-name
RiskScore = 25
Annotation = {"mitre_attack": ["T1543.003", "T1068"], "author": "Nasreddine Bencherchali (Nextron Systems)"}
Query = Image.Path like r"%\\panmonfltx64.sys" or Image.Path like r"%\\dbutil.sys" or Image.Path like r"%\\fairplaykd.sys" or Image.Path like r"%\\nvaudio.sys" or Image.Path like r"%\\superbmc.sys" or Image.Path like r"%\\bsmi.sys" or Image.Path like r"%\\smarteio64.sys" or Image.Path like r"%\\bwrsh.sys" or Image.Path like r"%\\agent64.sys" or Image.Path like r"%\\asmmap64.sys" or Image.Path like r"%\\dellbios.sys" or Image.Path like r"%\\chaos-rootkit.sys" or Image.Path like r"%\\wcpu.sys" or Image.Path like r"%\\dh\_kernel.sys" or Image.Path like r"%\\sbiosio64.sys" or Image.Path like r"%\\bw.sys" or Image.Path like r"%\\asrdrv102.sys" or Image.Path like r"%\\nt6.sys" or Image.Path like r"%\\mhyprot3.sys" or Image.Path like r"%\\winio64c.sys" or Image.Path like r"%\\asupio64.sys" or Image.Path like r"%\\blackbonedrv10.sys" or Image.Path like r"%\\d.sys" or Image.Path like r"%\\driver7-x86.sys" or Image.Path like r"%\\sfdrvx32.sys" or Image.Path like r"%\\enetechio64.sys" or Image.Path like r"%\\gdrv.sys" or Image.Path like r"%\\sysinfodetectorx64.sys" or Image.Path like r"%\\fh-ethercat\_dio.sys" or Image.Path like r"%\\asromgdrv.sys" or Image.Path like r"%\\my.sys" or Image.Path like r"%\\dcprotect.sys" or Image.Path like r"%\\irec.sys" or Image.Path like r"%\\gedevdrv.sys" or Image.Path like r"%\\winio32a.sys" or Image.Path like r"%\\gvcidrv64.sys" or Image.Path like r"%\\winio32.sys" or Image.Path like r"%\\bs\_hwmio64.sys" or Image.Path like r"%\\nstr.sys" or Image.Path like r"%\\inpoutx64.sys" or Image.Path like r"%\\hw.sys" or Image.Path like r"%\\winio64.sys" or Image.Path like r"%\\hpportiox64.sys" or Image.Path like r"%\\iobitunlocker.sys" or Image.Path like r"%\\b1.sys" or Image.Path like r"%\\aoddriver.sys" or Image.Path like r"%\\elbycdio.sys" or Image.Path like r"%\\protects.sys" or Image.Path like r"%\\kprocesshacker.sys" or Image.Path like r"%\\speedfan.sys" or Image.Path like r"%\\radhwmgr.sys" or Image.Path like r"%\\iscflashx64.sys" or Image.Path like r"%\\black.sys" or Image.Path like r"%\\b4.sys" or Image.Path like r"%\\hwos2ec10x64.sys" or Image.Path like r"%\\winflash64.sys" or Image.Path like r"%\\corsairllaccess64.sys" or Image.Path like r"%\\bs\_i2cio.sys" or Image.Path like r"%\\d3.sys" or Image.Path like r"%\\windows-xp-64.sys" or Image.Path like r"%\\aswvmm.sys" or Image.Path like r"%\\bs\_i2c64.sys" or Image.Path like r"%\\1.sys" or Image.Path like r"%\\nchgbios2x64.sys" or Image.Path like r"%\\cpuz141.sys" or Image.Path like r"%\\segwindrvx64.sys" or Image.Path like r"%\\tdeio64.sys" or Image.Path like r"%\\ntiolib.sys" or Image.Path like r"%\\gtckmdfbs.sys" or Image.Path like r"%\\iomap64.sys" or Image.Path like r"%\\avalueio.sys" or Image.Path like r"%\\semav6msr.sys" or Image.Path like r"%\\lgdcatcher.sys" or Image.Path like r"%\\b.sys" or Image.Path like r"%\\hwdetectng.sys" or Image.Path like r"%\\nt4.sys" or Image.Path like r"%\\tgsafe.sys" or Image.Path like r"%\\mydrivers.sys" or Image.Path like r"%\\eneio64.sys" or Image.Path like r"%\\procexp.sys" or Image.Path like r"%\\viragt64.sys" or Image.Path like r"%\\fpcie2com.sys" or Image.Path like r"%\\lenovodiagnosticsdriver.sys" or Image.Path like r"%\\cp2x72c.sys" or Image.Path like r"%\\kerneld.amd64" or Image.Path like r"%\\bs\_def64.sys" or Image.Path like r"%\\piddrv.sys" or Image.Path like r"%\\amifldrv64.sys" or Image.Path like r"%\\cpuz\_x64.sys" or Image.Path like r"%\\proxy32.sys" or Image.Path like r"%\\wsdkd.sys" or Image.Path like r"%\\t8.sys" or Image.Path like r"%\\ucorew64.sys" or Image.Path like r"%\\atszio.sys" or Image.Path like r"%\\lmiinfo.sys" or Image.Path like r"%\\80.sys" or Image.Path like r"%\\nt3.sys" or Image.Path like r"%\\ngiodriver.sys" or Image.Path like r"%\\lv561av.sys" or Image.Path like r"%\\gpcidrv64.sys" or Image.Path like r"%\\fd3b7234419fafc9bdd533f48896ed73\_b816c5cd.sys" or Image.Path like r"%\\rtport.sys" or Image.Path like r"%\\full.sys" or Image.Path like r"%\\viragt.sys" or Image.Path like r"%\\fiddrv64.sys" or Image.Path like r"%\\cupfixerx64.sys" or Image.Path like r"%\\cpupress.sys" or Image.Path like r"%\\hwos2ec7x64.sys" or Image.Path like r"%\\driver7-x86-withoutdbg.sys" or Image.Path like r"%\\asrdrv10.sys" or Image.Path like r"%\\nvflsh64.sys" or Image.Path like r"%\\asrrapidstartdrv.sys" or Image.Path like r"%\\tmcomm.sys" or Image.Path like r"%\\wiseunlo.sys" or Image.Path like r"%\\rwdrv.sys" or Image.Path like r"%\\asio64.sys" or Image.Path like r"%\\nvoclock.sys" or Image.Path like r"%\\panio.sys" or Image.Path like r"%\\mtcbsv64.sys" or Image.Path like r"%\\amigendrv64.sys" or Image.Path like r"%\\capcom.sys" or Image.Path like r"%\\netflt.sys" or Image.Path like r"%\\phlashnt.sys" or Image.Path like r"%\\dbutil\_2\_3.sys" or Image.Path like r"%\\ni.sys" or Image.Path like r"%\\ntiolib\_x64.sys" or Image.Path like r"%\\atszio64.sys" or Image.Path like r"%\\lgcoretemp.sys" or Image.Path like r"%\\lha.sys" or Image.Path like r"%\\phymem64.sys" or Image.Path like r"%\\dbutildrv2.sys" or Image.Path like r"%\\asrdrv103.sys" or Image.Path like r"%\\rtcore64.sys" or Image.Path like r"%\\bs\_hwmio64\_w10.sys" or Image.Path like r"%\\ene.sys" or Image.Path like r"%\\winio64b.sys" or Image.Path like r"%\\piddrv64.sys" or Image.Path like r"%\\directio32.sys" or Image.Path like r"%\\monitor\_win10\_x64.sys" or Image.Path like r"%\\nt5.sys" or Image.Path like r"%\\asrsmartconnectdrv.sys" or Image.Path like r"%\\rtif.sys" or Image.Path like r"%\\atillk64.sys" or Image.Path like r"%\\directio.sys" or Image.Path like r"%\\asribdrv.sys" or Image.Path like r"%\\kfeco11x64.sys" or Image.Path like r"%\\citmdrv\_ia64.sys" or Image.Path like r"%\\sysdrv3s.sys" or Image.Path like r"%\\amp.sys" or Image.Path like r"%\\vboxdrv.sys" or Image.Path like r"%\\adv64drv.sys" or Image.Path like r"%\\hostnt.sys" or Image.Path like r"%\\phymem\_ext64.sys" or Image.Path like r"%\\echo\_driver.sys" or Image.Path like r"%\\winiodrv.sys" or Image.Path like r"%\\pdfwkrnl.sys" or Image.Path like r"%\\glckio2.sys" or Image.Path like r"%\\asrdrv106.sys" or Image.Path like r"%\\nscm.sys" or Image.Path like r"%\\bs\_rcio64.sys" or Image.Path like r"%\\ncpl.sys" or Image.Path like r"%\\sandra.sys" or Image.Path like r"%\\fiddrv.sys" or Image.Path like r"%\\hwrwdrv.sys" or Image.Path like r"%\\mhyprot.sys" or Image.Path like r"%\\asrsetupdrv103.sys" or Image.Path like r"%\\iqvw64.sys" or Image.Path like r"%\\b3.sys" or Image.Path like r"%\\ssport.sys" or Image.Path like r"%\\bs\_def.sys" or Image.Path like r"%\\computerz.sys" or Image.Path like r"%\\windows8-10-32.sys" or Image.Path like r"%\\nstrwsk.sys" or Image.Path like r"%\\lurker.sys" or Image.Path like r"%\\bsmemx64.sys" or Image.Path like r"%\\wyproxy64.sys" or Image.Path like r"%\\asio.sys" or Image.Path like r"%\\t3.sys" or Image.Path like r"%\\cpuz.sys" or Image.Path like r"%\\rtkio.sys" or Image.Path like r"%\\driver7-x64.sys" or Image.Path like r"%\\netfilterdrv.sys" or Image.Path like r"%\\ioaccess.sys" or Image.Path like r"%\\testbone.sys" or Image.Path like r"%\\gameink.sys" or Image.Path like r"%\\kevp64.sys" or Image.Path like r"%\\mhyprot2.sys" or Image.Path like r"%\\se64a.sys" or Image.Path like r"%\\vboxusb.sys" or Image.Path like r"%\\windows7-32.sys" or Image.Path like r"%\\vproeventmonitor.sys" or Image.Path like r"%\\winio64a.sys" or Image.Path like r"%\\asrdrv101.sys" or Image.Path like r"%\\netproxydriver.sys" or Image.Path like r"%\\elrawdsk.sys" or Image.Path like r"%\\zam64.sys" or Image.Path like r"%\\cg6kwin2k.sys" or Image.Path like r"%\\asupio.sys" or Image.Path like r"%\\stdcdrvws64.sys" or Image.Path like r"%\\81.sys" or Image.Path like r"%\\citmdrv\_amd64.sys" or Image.Path like r"%\\amdryzenmasterdriver.sys" or Image.Path like r"%\\vmdrv.sys" or Image.Path like r"%\\sysinfo.sys" or Image.Path like r"%\\alsysio64.sys" or Image.Path like r"%\\directio64.sys" or Image.Path like r"%\\rzpnk.sys" or Image.Path like r"%\\amdpowerprofiler.sys" or Image.Path like r"%\\truesight.sys" or Image.Path like r"%\\wirwadrv.sys" or Image.Path like r"%\\phymemx64.sys" or Image.Path like r"%\\msio64.sys" or Image.Path like r"%\\sepdrv3\_1.sys" or Image.Path like r"%\\gametersafe.sys" or Image.Path like r"%\\bs\_rcio.sys" or Image.Path like r"%\\d4.sys" or Image.Path like r"%\\t.sys" or Image.Path like r"%\\eio.sys" or Image.Path like r"%\\nt2.sys" or Image.Path like r"%\\winring0.sys" or Image.Path like r"%\\physmem.sys" or Image.Path like r"%\\libnicm.sys" or Image.Path like r"%\\msio32.sys" or Image.Path like r"%\\asrautochkupddrv.sys" or Image.Path like r"%\\asio32.sys" or Image.Path like r"%\\etdsupp.sys" or Image.Path like r"%\\smep\_namco.sys" or Image.Path like r"%\\bandai.sys" or Image.Path like r"%\\d2.sys" or Image.Path like r"%\\magdrvamd64.sys" or Image.Path like r"%\\nvflash.sys" or Image.Path like r"%\\goad.sys" or Image.Path like r"%\\proxy64.sys" or Image.Path like r"%\\amsdk.sys" or Image.Path like r"%\\kbdcap64.sys" or Image.Path like r"%\\vdbsv64.sys" or Image.Path like r"%\\pchunter.sys" or Image.Path like r"%\\sysconp.sys" or Image.Path like r"%\\dh\_kernel\_10.sys" or Image.Path like r"%\\msrhook.sys" or Image.Path like r"%\\bedaisy.sys" or Image.Path like r"%\\dcr.sys" or Image.Path like r"%\\panmonflt.sys" or Image.Path like r"%\\bsmixp64.sys" or Image.Path like r"%\\otipcibus.sys" or Image.Path like r"%\\fidpcidrv.sys" or Image.Path like r"%\\kfeco10x64.sys" or Image.Path like r"%\\asrdrv104.sys" or Image.Path like r"%\\c.sys" or Image.Path like r"%\\tdklib64.sys" or Image.Path like r"%\\bsmix64.sys" or Image.Path like r"%\\bs\_flash64.sys" or Image.Path like r"%\\stdcdrv64.sys" or Image.Path like r"%\\naldrv.sys" or Image.Path like r"%\\ctiio64.sys" or Image.Path like r"%\\bwrs.sys" or Image.Path like r"%\\nicm.sys" or Image.Path like r"%\\winio32b.sys" or Image.Path like r"%\\paniox64.sys" or Image.Path like r"%\\ecsiodriverx64.sys" or Image.Path like r"%\\iomem64.sys" or Image.Path like r"%\\fidpcidrv64.sys" or Image.Path like r"%\\aswarpot.sys" or Image.Path like r"%\\bs\_rciow1064.sys" or Image.Path like r"%\\asmio64.sys" or Image.Path like r"%\\openlibsys.sys" or Image.Path like r"%\\viraglt64.sys" or Image.Path like r"%\\dbk64.sys" or Image.Path like r"%\\t7.sys" or Image.Path like r"%\\atlaccess.sys" or Image.Path like r"%\\nbiolib\_x64.sys" or Image.Path like r"%\\smep\_capcom.sys" or Image.Path like r"%\\iqvw64e.sys"
GenericProperty1 = Image.Path


[ThreatDetectionRule platform=Windows]
# Detect indirect command execution via Program Compatibility Assistant pcwrun.exe
# Author: A. Sungurov , oscd.community
RuleId = b97cd4b1-30b8-4a9d-bd72-6293928d52bc
RuleName = Indirect Command Execution By Program Compatibility Wizard
EventType = Process.Start
Tag = proc-start-indirect-command-execution-by-program-compatibility-wizard
RiskScore = 25
Annotation = {"mitre_attack": ["T1218"], "author": "A. Sungurov , oscd.community"}
Query = Parent.Path like r"%\\pcwrun.exe"
GenericProperty1 = Parent.Path


[ThreatDetectionRule platform=Windows]
# Detects the creation of a new PowerShell module ".psm1", ".psd1", ".dll", ".ps1", etc.
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = e36941d0-c0f0-443f-bc6f-cb2952eb69ea
RuleName = PowerShell Module File Created
EventType = File.Create
Tag = powershell-module-file-created
RiskScore = 25
Annotation = {"author": "Nasreddine Bencherchali (Nextron Systems)"}
Query = (Process.Path like r"%\\powershell.exe" or Process.Path like r"%\\pwsh.exe") and (File.Path like r"%\\WindowsPowerShell\\Modules\\%" or File.Path like r"%\\PowerShell\\7\\Modules\\%")
GenericProperty1 = File.Path


[ThreatDetectionRule platform=Windows]
# Detects the execution of a Sysinternals Tool via the creation of the "accepteula" registry key
# Author: Markus Neis
RuleId = 25ffa65d-76d8-4da5-a832-3f2b0136e133
RuleName = PUA - Sysinternal Tool Execution - Registry
EventType = Reg.Any
Tag = pua-sysinternal-tool-execution-registry
RiskScore = 25
Annotation = {"mitre_attack": ["T1588.002"], "author": "Markus Neis"}
Query = Reg.EventType == "CreateKey" and Reg.TargetObject like r"%\\EulaAccepted"
Hive = HKLM,HKU
GenericProperty1 = Reg.TargetObject
GenericProperty2 = Reg.EventType


[ThreatDetectionRule platform=Windows]
# Detects the execution of "wmic" with the "group" flag.
# Adversaries may attempt to find local system groups and permission settings.
# The knowledge of local system permission groups can help adversaries determine which groups exist and which users belong to a particular group.
# Adversaries may use this information to determine which users have elevated permissions, such as the users found within the local administrators group.
# Author: frack113
RuleId = 164eda96-11b2-430b-85ff-6a265c15bf32
RuleName = Local Groups Reconnaissance Via Wmic.EXE
EventType = Process.Start
Tag = proc-start-local-groups-reconnaissance-via-wmic.exe
RiskScore = 25
Annotation = {"mitre_attack": ["T1069.001"], "author": "frack113"}
Query = (Process.Path like r"%\\wmic.exe" or Process.Name == "wmic.exe") and Process.CommandLine like r"% group%"


[ThreatDetectionRule platform=Windows]
# Detects file access requests to files ending with either the ".hive"/".reg" extension, usually associated with Windows Registry backups.
# Author: frack113
RuleId = 337a31c6-46c4-46be-886a-260d7aa78cac
RuleName = Access To .Reg/.Hive Files By Uncommon Applications
EventType = File.Read
Tag = access-to-.reg/.hive-files-by-uncommon-applications
RiskScore = 25
Annotation = {"mitre_attack": ["T1112"], "author": "frack113"}
Query = (File.Path like r"%.hive" or File.Path like r"%.reg") and not (Process.Path like r"C:\\Program Files (x86)\\%" or Process.Path like r"C:\\Program Files\\%" or Process.Path like r"C:\\Windows\\System32\\%" or Process.Path like r"C:\\Windows\\SysWOW64\\%")
GenericProperty1 = File.Path


[ThreatDetectionRule platform=Windows]
# Detects the stopping of a Windows service via the "sc.exe" utility
# Author: Jakob Weinzettl, oscd.community, Nasreddine Bencherchali (Nextron Systems)
RuleId = 81bcb81b-5b1f-474b-b373-52c871aaa7b1
RuleName = Stop Windows Service Via Sc.EXE
EventType = Process.Start
Tag = proc-start-stop-windows-service-via-sc.exe
RiskScore = 25
Annotation = {"mitre_attack": ["T1489"], "author": "Jakob Weinzettl, oscd.community, Nasreddine Bencherchali (Nextron Systems)"}
Query = (Process.Name == "sc.exe" or Process.Path like r"%\\sc.exe") and Process.CommandLine like r"% stop %"


[ThreatDetectionRule platform=Windows]
# Detects WMI modules being loaded by an uncommon process
# Author: Roberto Rodriguez @Cyb3rWard0g
RuleId = 671bb7e3-a020-4824-a00e-2ee5b55f385e
RuleName = WMI Module Loaded By Uncommon Process
EventType = Image.Load
Tag = wmi-module-loaded-by-uncommon-process
RiskScore = 25
Annotation = {"mitre_attack": ["T1047"], "author": "Roberto Rodriguez @Cyb3rWard0g"}
Query = (Image.Path like r"%\\fastprox.dll" or Image.Path like r"%\\wbemcomn.dll" or Image.Path like r"%\\wbemprox.dll" or Image.Path like r"%\\wbemsvc.dll" or Image.Path like r"%\\WmiApRpl.dll" or Image.Path like r"%\\wmiclnt.dll" or Image.Path like r"%\\WMINet\_Utils.dll" or Image.Path like r"%\\wmiprov.dll" or Image.Path like r"%\\wmiutils.dll") and not (Process.Path like r"%:\\Program Files (x86)\\%" or Process.Path like r"%:\\Program Files\\%" or Process.Path like r"%:\\Windows\\explorer.exe%" or Process.Path like r"%:\\Windows\\Microsoft.NET\\Framework\\%" or Process.Path like r"%:\\Windows\\Microsoft.NET\\Framework64\\%" or Process.Path like r"%:\\Windows\\System32\\%" or Process.Path like r"%:\\Windows\\SysWOW64\\%") and not (Process.Path like r"%\\WindowsAzureGuestAgent.exe" or Process.Path like r"%\\WaAppAgent.exe" or Process.Path like r"%\\thor.exe" or Process.Path like r"%\\thor64.exe" or Process.Path like r"%\\MsMpEng.exe" or Process.Path like r"%\\Microsoft\\Teams\\current\\Teams.exe%" or Process.Path like r"%\\Microsoft\\Teams\\Update.exe%" or Process.Path like r"%:\\Windows\\Sysmon.exe" or Process.Path like r"%:\\Windows\\Sysmon64.exe")
GenericProperty1 = Image.Path


[ThreatDetectionRule platform=Windows]
# Detects the use of the "SET" internal command of Cmd.EXE with the /p flag followed directly by an "=" sign.
# Attackers used this technique along with an append redirection operator ">>" in order to update the content of a file indirectly.
# Ex: cmd /c >> example.txt set /p="test data". This will append "test data" to contents of "example.txt".
# The typical use case of the "set /p=" command is to prompt the user for input.
# Author: Nasreddine Bencherchali (Nextron Systems), MahirAli Khan (in/mahiralikhan)
RuleId = 65e4c134-ee52-4099-9e35-5e17a4b45c62
RuleName = Potential File Override/Append Via SET Command
EventType = Process.Start
Tag = proc-start-potential-file-override/append-via-set-command
RiskScore = 25
Annotation = {"author": "Nasreddine Bencherchali (Nextron Systems), MahirAli Khan (in/mahiralikhan)"}
Query = (Process.Path like r"%\\cmd.exe" or Process.Name == "Cmd.Exe") and (Process.CommandLine like r"%/c set /p=%" or Process.CommandLine like r"%\"set /p=%" or Process.CommandLine like r"%>>%set /p=%")


[ThreatDetectionRule platform=Windows]
# Detect the usage of "DirLister.exe" a utility for quickly listing folder or drive contents. It was seen used by BlackCat ransomware to create a list of accessible directories and files.
# Author: frack113
RuleId = b4dc61f5-6cce-468e-a608-b48b469feaa2
RuleName = DirLister Execution
EventType = Process.Start
Tag = proc-start-dirlister-execution
RiskScore = 25
Annotation = {"mitre_attack": ["T1083"], "author": "frack113"}
Query = Process.Name == "DirLister.exe" or Process.Path like r"%\\dirlister.exe"


[ThreatDetectionRule platform=Windows]
# Detects command lines that contain the 'accepteula' flag which could be a sign of execution of one of the Sysinternals tools
# Author: Markus Neis
RuleId = 7cccd811-7ae9-4ebe-9afd-cb5c406b824b
RuleName = Potential Execution of Sysinternals Tools
EventType = Process.Start
Tag = proc-start-potential-execution-of-sysinternals-tools
RiskScore = 25
Annotation = {"mitre_attack": ["T1588.002"], "author": "Markus Neis"}
Query = Process.CommandLine like r"% -accepteula%" or Process.CommandLine like r"% /accepteula%" or Process.CommandLine like r"% –accepteula%" or Process.CommandLine like r"% —accepteula%" or Process.CommandLine like r"% ―accepteula%"


[ThreatDetectionRule platform=Windows]
# Detects the enabling of the PowerShell script execution policy. Once enabled, this policy allows scripts to be executed.
# Author: Nasreddine Bencherchali (Nextron Systems), Thurein Oo
RuleId = 8218c875-90b9-42e2-b60d-0b0069816d10
RuleName = PowerShell Script Execution Policy Enabled
EventType = Reg.Any
Tag = powershell-script-execution-policy-enabled
RiskScore = 25
Annotation = {"author": "Nasreddine Bencherchali (Nextron Systems), Thurein Oo"}
Query = Reg.TargetObject like r"%\\Policies\\Microsoft\\Windows\\PowerShell\\EnableScripts" and Reg.Value.Data == "DWORD (0x00000001)"
Hive = HKLM,HKU
GenericProperty1 = Reg.TargetObject
GenericProperty2 = Reg.Value.Data


[ThreatDetectionRule platform=Windows]
# Detects changes to shell context menu commands. Use this rule to hunt for potential anomalies and suspicious shell commands.
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = 868df2d1-0939-4562-83a7-27408c4a1ada
RuleName = Shell Context Menu Command Tampering
EventType = Reg.Any
Tag = shell-context-menu-command-tampering
RiskScore = 25
Annotation = {"author": "Nasreddine Bencherchali (Nextron Systems)"}
Query = Reg.TargetObject like r"%\\Software\\Classes\\%" and Reg.TargetObject like r"%\\shell\\%" and Reg.TargetObject like r"%\\command\\%"
Hive = HKLM,HKU
GenericProperty1 = Reg.TargetObject


[ThreatDetectionRule platform=Windows]
# Attackers may leverage fsutil to enumerated connected drives.
# Author: Christopher Peacock '@securepeacock', SCYTHE '@scythe_io'
RuleId = 63de06b9-a385-40b5-8b32-73f2b9ef84b6
RuleName = Fsutil Drive Enumeration
EventType = Process.Start
Tag = proc-start-fsutil-drive-enumeration
RiskScore = 25
Annotation = {"mitre_attack": ["T1120"], "author": "Christopher Peacock '@securepeacock', SCYTHE '@scythe_io'"}
Query = (Process.Path like r"%\\fsutil.exe" or Process.Name == "fsutil.exe") and Process.CommandLine like r"%drives%"


[ThreatDetectionRule platform=Windows]
# Detects file association changes using the builtin "assoc" command.
# When a file is opened, the default program used to open the file (also called the file association or handler) is checked. File association selections are stored in the Windows Registry and can be edited by users, administrators, or programs that have Registry access or by administrators using the built-in assoc utility. Applications can modify the file association for a given file extension to call an arbitrary program when a file with the given extension is opened.
# Author: Timur Zinniatullin, oscd.community
RuleId = 3d3aa6cd-6272-44d6-8afc-7e88dfef7061
RuleName = Change Default File Association Via Assoc
EventType = Process.Start
Tag = proc-start-change-default-file-association-via-assoc
RiskScore = 25
Annotation = {"mitre_attack": ["T1546.001"], "author": "Timur Zinniatullin, oscd.community"}
Query = (Process.Path like r"%\\cmd.exe" or Process.Name == "Cmd.Exe") and Process.CommandLine like r"%assoc%"


[ThreatDetectionRule platform=Windows]
# Detects Microsoft Word loading an Add-In (.wll) file which can be used by threat actors for initial access or persistence.
# Author: Steffen Rogge (dr0pd34d)
RuleId = 1337afba-d17d-4d23-bd55-29b927603b30
RuleName = Microsoft Word Add-In Loaded
EventType = Image.Load
Tag = microsoft-word-add-in-loaded
RiskScore = 25
Annotation = {"mitre_attack": ["T1204.002"], "author": "Steffen Rogge (dr0pd34d)"}
Query = Process.Path like r"%\\winword.exe" and Image.Path like r"%.wll"
GenericProperty1 = Image.Path


[ThreatDetectionRule platform=Windows]
# Detects loading of Amsi.dll by uncommon processes
# Author: frack113
RuleId = facd1549-e416-48e0-b8c4-41d7215eedc8
RuleName = Amsi.DLL Load By Uncommon Process
EventType = Image.Load
Tag = amsi.dll-load-by-uncommon-process
RiskScore = 25
Annotation = {"mitre_attack": ["T1490"], "author": "frack113"}
Query = Image.Path like r"%\\amsi.dll" and not (Process.Path like r"%:\\Windows\\explorer.exe" or Process.Path like r"%:\\Windows\\Sysmon64.exe" or Process.Path like r"%:\\Program Files (x86)\\%" or Process.Path like r"%:\\Program Files\\%" or Process.Path like r"%:\\Windows\\System32\\%" or Process.Path like r"%:\\Windows\\SysWOW64\\%" or Process.Path like r"%:\\Windows\\WinSxS\\%" or (Process.Path like r"%:\\Windows\\Microsoft.NET\\Framework\\%" or Process.Path like r"%:\\Windows\\Microsoft.NET\\Framework64\\%") and Process.Path like r"%\\ngentask.exe" or isnull(Process.Path) or Process.Path == "") and not (Process.Path like r"%:\\ProgramData\\Microsoft\\Windows Defender\\Platform\\%" and Process.Path like r"%\\MsMpEng.exe")
GenericProperty1 = Image.Path


[ThreatDetectionRule platform=Windows]
# Detects creation of a file named "ntds.dit" (Active Directory Database)
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = 0b8baa3f-575c-46ee-8715-d6f28cc7d33c
RuleName = NTDS.DIT Created
EventType = File.Create
Tag = ntds.dit-created
RiskScore = 25
Annotation = {"mitre_attack": ["T1003.003"], "author": "Nasreddine Bencherchali (Nextron Systems)"}
Query = File.Path like r"%ntds.dit"
GenericProperty1 = File.Path


[ThreatDetectionRule platform=Windows]
# Detects the creation of a process via the Windows task manager. This might be an attempt to bypass UAC
# Author: Florian Roth (Nextron Systems)
RuleId = 3d7679bd-0c00-440c-97b0-3f204273e6c7
RuleName = New Process Created Via Taskmgr.EXE
EventType = Process.Start
Tag = proc-start-new-process-created-via-taskmgr.exe
RiskScore = 25
Annotation = {"mitre_attack": ["T1036"], "author": "Florian Roth (Nextron Systems)"}
Query = Parent.Path like r"%\\taskmgr.exe" and not (Process.Path like r"%:\\Windows\\System32\\mmc.exe" or Process.Path like r"%:\\Windows\\System32\\resmon.exe" or Process.Path like r"%:\\Windows\\System32\\Taskmgr.exe")
GenericProperty1 = Parent.Path


[ThreatDetectionRule platform=Windows]
# Detects abusing Azure Browser SSO by requesting OAuth 2.0 refresh tokens for an Azure-AD-authenticated Windows user (i.e. the machine is joined to Azure AD and a user logs in with their Azure AD account) wanting to perform SSO authentication in the browser.
# An attacker can use this to authenticate to Azure AD in a browser as that user.
# Author: Den Iuzvyk
RuleId = 50f852e6-af22-4c78-9ede-42ef36aa3453
RuleName = Potential Azure Browser SSO Abuse
EventType = Image.Load
Tag = potential-azure-browser-sso-abuse
RiskScore = 25
Annotation = {"mitre_attack": ["T1574.002"], "author": "Den Iuzvyk"}
Query = Image.Path == "C:\\Windows\\System32\\MicrosoftAccountTokenProvider.dll" and not ((Process.Path like r"C:\\Windows\\System32\\%" or Process.Path like r"C:\\Windows\\SysWOW64\\%") and Process.Path like r"%\\BackgroundTaskHost.exe") and not ((Process.Path like r"C:\\Program Files\\Microsoft Visual Studio\\%" or Process.Path like r"C:\\Program Files (x86)\\Microsoft Visual Studio\\%") and Process.Path like r"%\\IDE\\devenv.exe" or Process.Path in ["C:\\Program Files (x86)\\Internet Explorer\\iexplore.exe", "C:\\Program Files\\Internet Explorer\\iexplore.exe"] or Process.Path like r"C:\\Program Files (x86)\\Microsoft\\EdgeWebView\\Application\\%" or Process.Path like r"%\\WindowsApps\\MicrosoftEdge.exe" or Process.Path in ["C:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe", "C:\\Program Files\\Microsoft\\Edge\\Application\\msedge.exe"] or (Process.Path like r"C:\\Program Files (x86)\\Microsoft\\EdgeCore\\%" or Process.Path like r"C:\\Program Files\\Microsoft\\EdgeCore\\%") and (Process.Path like r"%\\msedge.exe" or Process.Path like r"%\\msedgewebview2.exe") or Process.Path like r"%\\AppData\\Local\\Microsoft\\OneDrive\\OneDrive.exe" or isnull(Process.Path))
GenericProperty1 = Image.Path


[ThreatDetectionRule platform=Windows]
# Detects the creation of a file with the ".dmp"/".hdmp" extension. Often created by software during a crash. Memory dumps can sometimes contain sensitive information such as credentials. It's best to determine the source of the crash.
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = 3a525307-d100-48ae-b3b9-0964699d7f97
RuleName = DMP/HDMP File Creation
EventType = File.Create
Tag = dmp/hdmp-file-creation
RiskScore = 25
Annotation = {"author": "Nasreddine Bencherchali (Nextron Systems)"}
Query = File.Path like r"%.dmp" or File.Path like r"%.dump" or File.Path like r"%.hdmp"
GenericProperty1 = File.Path


[ThreatDetectionRule platform=Windows]
# Detects potential RDP connection via Mstsc using a local ".rdp" file
# Author: Nasreddine Bencherchali (Nextron Systems), Christopher Peacock @securepeacock
RuleId = 5fdce3ac-e7f9-4ecd-a3aa-a4d78ebbf0af
RuleName = Mstsc.EXE Execution With Local RDP File
EventType = Process.Start
Tag = proc-start-mstsc.exe-execution-with-local-rdp-file
RiskScore = 25
Annotation = {"mitre_attack": ["T1219"], "author": "Nasreddine Bencherchali (Nextron Systems), Christopher Peacock @securepeacock"}
Query = (Process.Path like r"%\\mstsc.exe" or Process.Name == "mstsc.exe") and (Process.CommandLine like r"%.rdp" or Process.CommandLine like r"%.rdp\"") and not (Parent.Path == "C:\\Windows\\System32\\lxss\\wslhost.exe" and Process.CommandLine like r"%C:\\ProgramData\\Microsoft\\WSL\\wslg.rdp%")
GenericProperty1 = Parent.Path


[ThreatDetectionRule platform=Windows]
# Detects changes to the "ExtErrorInformation" key in order to disable ETW logging for rpcrt4.dll
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = 90f342e1-1aaa-4e43-b092-39fda57ed11e
RuleName = ETW Logging Disabled For rpcrt4.dll
EventType = Reg.Any
Tag = etw-logging-disabled-for-rpcrt4.dll
RiskScore = 25
Annotation = {"mitre_attack": ["T1112", "T1562"], "author": "Nasreddine Bencherchali (Nextron Systems)"}
Query = Reg.TargetObject like r"%\\Microsoft\\Windows NT\\Rpc\\ExtErrorInformation" and (Reg.Value.Data in ["DWORD (0x00000000)", "DWORD (0x00000002)"])
Hive = HKLM,HKU
GenericProperty1 = Reg.TargetObject
GenericProperty2 = Reg.Value.Data


[ThreatDetectionRule platform=Windows]
# Detects the execution of the "jsc.exe" (JScript Compiler).
# Attacker might abuse this in order to compile JScript files on the fly and bypassing application whitelisting.
# Author: frack113
RuleId = 52788a70-f1da-40dd-8fbd-73b5865d6568
RuleName = JScript Compiler Execution
EventType = Process.Start
Tag = proc-start-jscript-compiler-execution
RiskScore = 25
Annotation = {"mitre_attack": ["T1127"], "author": "frack113"}
Query = Process.Path like r"%\\jsc.exe" or Process.Name == "jsc.exe"


[ThreatDetectionRule platform=Windows]
# Detects non-interactive PowerShell activity by looking at the "powershell" process with a non-user GUI process such as "explorer.exe" as a parent.
# Author: Roberto Rodriguez @Cyb3rWard0g (rule), oscd.community (improvements)
RuleId = f4bbd493-b796-416e-bbf2-121235348529
RuleName = Non Interactive PowerShell Process Spawned
EventType = Process.Start
Tag = proc-start-non-interactive-powershell-process-spawned
RiskScore = 25
Annotation = {"mitre_attack": ["T1059.001"], "author": "Roberto Rodriguez @Cyb3rWard0g (rule), oscd.community (improvements)"}
Query = (Process.Path like r"%\\powershell.exe" or Process.Path like r"%\\pwsh.exe" or Process.Name in ["PowerShell.EXE", "pwsh.dll"]) and not (Parent.Path like r"%:\\Windows\\explorer.exe" or Parent.Path like r"%:\\Windows\\System32\\CompatTelRunner.exe" or Parent.Path like r"%:\\Windows\\SysWOW64\\explorer.exe" or Parent.Path == ":\\$WINDOWS.~BT\\Sources\\SetupHost.exe") and not (Parent.Path like r"%\\AppData\\Local\\Programs\\Microsoft VS Code\\Code.exe" and Parent.CommandLine like r"% --ms-enable-electron-run-as-node %" or Parent.Path like r"%:\\Program Files\\WindowsApps\\Microsoft.WindowsTerminal\_%" and Parent.Path like r"%\\WindowsTerminal.exe")
GenericProperty1 = Parent.Path
GenericProperty2 = Parent.CommandLine


[ThreatDetectionRule platform=Windows]
# Detects nltest commands that can be used for information discovery
# Author: Arun Chauhan
RuleId = 903076ff-f442-475a-b667-4f246bcc203b
RuleName = Nltest.EXE Execution
EventType = Process.Start
Tag = proc-start-nltest.exe-execution
RiskScore = 25
Annotation = {"mitre_attack": ["T1016", "T1018", "T1482"], "author": "Arun Chauhan"}
Query = Process.Path like r"%\\nltest.exe" or Process.Name == "nltestrk.exe"


[ThreatDetectionRule platform=Windows]
# Detects the creation of a new service using powershell.
# Author: Timur Zinniatullin, Daniil Yugoslavskiy, oscd.community
RuleId = c02e96b7-c63a-4c47-bd83-4a9f74afcfb2
RuleName = New Service Creation Using PowerShell
EventType = Process.Start
Tag = proc-start-new-service-creation-using-powershell
RiskScore = 25
Annotation = {"mitre_attack": ["T1543.003"], "author": "Timur Zinniatullin, Daniil Yugoslavskiy, oscd.community"}
Query = Process.CommandLine like r"%New-Service%" and Process.CommandLine like r"%-BinaryPathName%"


[ThreatDetectionRule platform=Windows]
# Identifies use of various commands to query a systems time. This technique may be used before executing a scheduled task or to discover the time zone of a target system.
# Author: E.M. Anhaus (originally from Atomic Blue Detections, Endgame), oscd.community
RuleId = b243b280-65fe-48df-ba07-6ddea7646427
RuleName = Discovery of a System Time
EventType = Process.Start
Tag = proc-start-discovery-of-a-system-time
RiskScore = 25
Annotation = {"mitre_attack": ["T1124"], "author": "E.M. Anhaus (originally from Atomic Blue Detections, Endgame), oscd.community"}
Query = (Process.Path like r"%\\net.exe" or Process.Path like r"%\\net1.exe") and Process.CommandLine like r"%time%" or Process.Path like r"%\\w32tm.exe" and Process.CommandLine like r"%tz%"


[ThreatDetectionRule platform=Windows]
# Detects the use of the redirection character ">" to redirect information on the command line.
# This technique is sometimes used by malicious actors in order to redirect the output of reconnaissance commands such as "hostname" and "dir" to files for future exfiltration.
# Author: frack113
RuleId = 4f4eaa9f-5ad4-410c-a4be-bc6132b0175a
RuleName = CMD Shell Output Redirect
EventType = Process.Start
Tag = proc-start-cmd-shell-output-redirect
RiskScore = 25
Annotation = {"mitre_attack": ["T1082"], "author": "frack113"}
Query = (Process.Name == "Cmd.Exe" or Process.Path like r"%\\cmd.exe") and Process.CommandLine like r"%>%" and not (Process.CommandLine like r"%C:\\Program Files (x86)\\Internet Download Manager\\IDMMsgHost.exe%" or Process.CommandLine like r"%chrome-extension://%" or Process.CommandLine like r"%\\.\\pipe\\chrome.nativeMessaging%")


[ThreatDetectionRule platform=Windows]
# Detects calls to the "New-NetFirewallRule" cmdlet from PowerShell in order to add a new firewall rule with an "Allow" action.
# Author: frack113
RuleId = 51483085-0cba-46a8-837e-4416496d6971
RuleName = New Windows Firewall Rule Added Via New-NetFirewallRule Cmdlet
EventType = Process.Start
Tag = proc-start-new-windows-firewall-rule-added-via-new-netfirewallrule-cmdlet
RiskScore = 25
Annotation = {"author": "frack113"}
Query = (Process.Path like r"%\\powershell.exe" or Process.Path like r"%\\pwsh.exe" or Process.Path like r"%\\powershell\_ise.exe" or Process.Name in ["PowerShell.EXE", "pwsh.dll"]) and Process.CommandLine like r"%New-NetFirewallRule %" and Process.CommandLine like r"% -Action %" and Process.CommandLine like r"%allow%"


[ThreatDetectionRule platform=Windows]
# Detects a CodePage modification using the "mode.com" utility.
# This behavior has been used by threat actors behind Dharma ransomware.
# Author: Nasreddine Bencherchali (Nextron Systems), Joseliyo Sanchez, @Joseliyo_Jstnk
RuleId = d48c5ffa-3b02-4c0f-9a9e-3c275650dd0e
RuleName = CodePage Modification Via MODE.COM
EventType = Process.Start
Tag = proc-start-codepage-modification-via-mode.com
RiskScore = 25
Annotation = {"mitre_attack": ["T1036"], "author": "Nasreddine Bencherchali (Nextron Systems), Joseliyo Sanchez, @Joseliyo_Jstnk"}
Query = (Process.Path like r"%\\mode.com" or Process.Name == "MODE.COM") and Process.CommandLine like r"% con %" and Process.CommandLine like r"% cp %" and Process.CommandLine like r"% select=%"


[ThreatDetectionRule platform=Windows]
# Detects changes to the "MaxMpxCt" registry value.
# MaxMpxCt specifies the maximum outstanding network requests for the server per client, which is used when negotiating a Server Message Block (SMB) connection with a client. Note if the value is set beyond 125 older Windows 9x clients will fail to negotiate.
# Ransomware threat actors and operators (specifically BlackCat) were seen increasing this value in order to handle a higher volume of traffic.
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = 0e6a9e62-627e-496c-aef5-bfa39da29b5e
RuleName = MaxMpxCt Registry Value Changed
EventType = Reg.Any
Tag = maxmpxct-registry-value-changed
RiskScore = 25
Annotation = {"mitre_attack": ["T1070.005"], "author": "Nasreddine Bencherchali (Nextron Systems)"}
Query = Reg.TargetObject like r"%\\Services\\LanmanServer\\Parameters\\MaxMpxCt"
Hive = HKLM,HKU
GenericProperty1 = Reg.TargetObject


[ThreatDetectionRule platform=Windows]
# Detects the execution of clip.exe in order to copy data to the clipboard. Adversaries may collect data stored in the clipboard from users copying information within or between applications.
# Author: frack113
RuleId = ddeff553-5233-4ae9-bbab-d64d2bd634be
RuleName = Data Copied To Clipboard Via Clip.EXE
EventType = Process.Start
Tag = proc-start-data-copied-to-clipboard-via-clip.exe
RiskScore = 25
Annotation = {"mitre_attack": ["T1115"], "author": "frack113"}
Query = Process.Path like r"%\\clip.exe" or Process.Name == "clip.exe"


[ThreatDetectionRule platform=Windows]
# Detects the creation of files in a specific location by ScreenConnect RMM.
# ScreenConnect has feature to remotely execute binaries on a target machine. These binaries will be dropped to ":\Users\<username>\Documents\ConnectWiseControl\Temp\" before execution.
# Author: Ali Alwashali
RuleId = 0afecb6e-6223-4a82-99fb-bf5b981e92a5
RuleName = Remote Access Tool - ScreenConnect Temporary File
EventType = File.Create
Tag = remote-access-tool-screenconnect-temporary-file
RiskScore = 25
Annotation = {"mitre_attack": ["T1059.003"], "author": "Ali Alwashali"}
Query = Process.Path like r"%\\ScreenConnect.WindowsClient.exe" and File.Path like r"%\\Documents\\ConnectWiseControl\\Temp\\%"
GenericProperty1 = File.Path


[ThreatDetectionRule platform=Windows]
# Detects the execution of a system command via the ScreenConnect RMM service.
# Author: Ali Alwashali
RuleId = b1f73849-6329-4069-bc8f-78a604bb8b23
RuleName = Remote Access Tool - ScreenConnect Remote Command Execution
EventType = Process.Start
Tag = proc-start-remote-access-tool-screenconnect-remote-command-execution
RiskScore = 25
Annotation = {"mitre_attack": ["T1059.003"], "author": "Ali Alwashali"}
Query = Parent.Path like r"%\\ScreenConnect.ClientService.exe" and (Process.Path like r"%\\cmd.exe" or Process.Name == "Cmd.Exe") and Process.CommandLine like r"%\\TEMP\\ScreenConnect\\%"
GenericProperty1 = Parent.Path


[ThreatDetectionRule platform=Windows]
# Detects execution of the builtin "del"/"erase" commands in order to delete files.
# Adversaries may delete files left behind by the actions of their intrusion activity.
# Malware, tools, or other non-native files dropped or created on a system by an adversary may leave traces to indicate to what was done within a network and how.
# Removal of these files can occur during an intrusion, or as part of a post-intrusion process to minimize the adversary's footprint.
# Author: frack113
RuleId = 379fa130-190e-4c3f-b7bc-6c8e834485f3
RuleName = File Deletion Via Del
EventType = Process.Start
Tag = proc-start-file-deletion-via-del
RiskScore = 25
Annotation = {"mitre_attack": ["T1070.004"], "author": "frack113"}
Query = (Process.Path like r"%\\cmd.exe" or Process.Name == "Cmd.Exe") and (Process.CommandLine like r"%del %" or Process.CommandLine like r"%erase %") and (Process.CommandLine like r"% -f%" or Process.CommandLine like r"% /f%" or Process.CommandLine like r"% –f%" or Process.CommandLine like r"% —f%" or Process.CommandLine like r"% ―f%" or Process.CommandLine like r"% -s%" or Process.CommandLine like r"% /s%" or Process.CommandLine like r"% –s%" or Process.CommandLine like r"% —s%" or Process.CommandLine like r"% ―s%" or Process.CommandLine like r"% -q%" or Process.CommandLine like r"% /q%" or Process.CommandLine like r"% –q%" or Process.CommandLine like r"% —q%" or Process.CommandLine like r"% ―q%")


[ThreatDetectionRule platform=Windows]
# Detects execution of "Net.EXE".
# Author: Michael Haag, Mark Woan (improvements), James Pemberton / @4A616D6573 / oscd.community (improvements)
RuleId = 183e7ea8-ac4b-4c23-9aec-b3dac4e401ac
RuleName = Net.EXE Execution
EventType = Process.Start
Tag = proc-start-net.exe-execution
RiskScore = 25
Annotation = {"mitre_attack": ["T1007", "T1049", "T1018", "T1135", "T1201", "T1069.001", "T1069.002", "T1087.001", "T1087.002", "T1021.002"], "author": "Michael Haag, Mark Woan (improvements), James Pemberton / @4A616D6573 / oscd.community (improvements)"}
Query = (Process.Path like r"%\\net.exe" or Process.Path like r"%\\net1.exe" or Process.Name in ["net.exe", "net1.exe"]) and (Process.CommandLine like r"% accounts%" or Process.CommandLine like r"% group%" or Process.CommandLine like r"% localgroup%" or Process.CommandLine like r"% share%" or Process.CommandLine like r"% start%" or Process.CommandLine like r"% stop %" or Process.CommandLine like r"% user%" or Process.CommandLine like r"% view%")


[ThreatDetectionRule platform=Windows]
# Adversaries can carry out malicious operations using a virtual instance to avoid detection. This rule is built to detect the registration of the Virtualbox driver or start of a Virtualbox VM.
# Author: Janantha Marasinghe
RuleId = bab049ca-7471-4828-9024-38279a4c04da
RuleName = Detect Virtualbox Driver Installation OR Starting Of VMs
EventType = Process.Start
Tag = proc-start-detect-virtualbox-driver-installation-or-starting-of-vms
RiskScore = 25
Annotation = {"mitre_attack": ["T1564.006", "T1564"], "author": "Janantha Marasinghe"}
Query = Process.CommandLine like r"%VBoxRT.dll,RTR3Init%" or Process.CommandLine like r"%VBoxC.dll%" or Process.CommandLine like r"%VBoxDrv.sys%" or Process.CommandLine like r"%startvm%" or Process.CommandLine like r"%controlvm%"


[ThreatDetectionRule platform=Windows]
# Detects usage of the "systeminfo" command to retrieve information
# Author: frack113
RuleId = 0ef56343-059e-4cb6-adc1-4c3c967c5e46
RuleName = Suspicious Execution of Systeminfo
EventType = Process.Start
Tag = proc-start-suspicious-execution-of-systeminfo
RiskScore = 25
Annotation = {"mitre_attack": ["T1082"], "author": "frack113"}
Query = Process.Path like r"%\\systeminfo.exe" or Process.Name == "sysinfo.exe"


[ThreatDetectionRule platform=Windows]
# Use of hostname to get information
# Author: frack113
RuleId = 7be5fb68-f9ef-476d-8b51-0256ebece19e
RuleName = Suspicious Execution of Hostname
EventType = Process.Start
Tag = proc-start-suspicious-execution-of-hostname
RiskScore = 25
Annotation = {"mitre_attack": ["T1082"], "author": "frack113"}
Query = Process.Path like r"%\\HOSTNAME.EXE"


[ThreatDetectionRule platform=Windows]
# Detects the execution of "hh.exe" to open ".chm" files.
# Author: E.M. Anhaus (originally from Atomic Blue Detections, Dan Beavin), oscd.community
RuleId = 68c8acb4-1b60-4890-8e82-3ddf7a6dba84
RuleName = HH.EXE Execution
EventType = Process.Start
Tag = proc-start-hh.exe-execution
RiskScore = 25
Annotation = {"mitre_attack": ["T1218.001"], "author": "E.M. Anhaus (originally from Atomic Blue Detections, Dan Beavin), oscd.community"}
Query = (Process.Name == "HH.exe" or Process.Path like r"%\\hh.exe") and Process.CommandLine like r"%.chm%"


[ThreatDetectionRule platform=Windows]
# Detects the creation of a child "explorer.exe" process from a shell like process such as "cmd.exe" or "powershell.exe".
# Attackers can use "explorer.exe" for evading defense mechanisms by proxying the execution through the latter.
# While this is often a legitimate action, this rule can be use to hunt for anomalies.
# Muddy Waters threat actor was seeing using this technique.
# Author: Furkan CALISKAN, @caliskanfurkan_, @oscd_initiative
RuleId = 9eb271b9-24ae-4cd4-9465-19cfc1047f3e
RuleName = Potential Proxy Execution Via Explorer.EXE From Shell Process
EventType = Process.Start
Tag = proc-start-potential-proxy-execution-via-explorer.exe-from-shell-process
RiskScore = 25
Annotation = {"mitre_attack": ["T1218"], "author": "Furkan CALISKAN, @caliskanfurkan_, @oscd_initiative"}
Query = (Parent.Path like r"%\\cmd.exe" or Parent.Path like r"%\\powershell.exe" or Parent.Path like r"%\\pwsh.exe") and Process.Path like r"%\\explorer.exe" and Process.CommandLine like r"%explorer.exe%"
GenericProperty1 = Parent.Path


[ThreatDetectionRule platform=Windows]
# Detects processes loading "System.Drawing.ni.dll". This could be an indicator of potential Screen Capture.
# Author: Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research)
RuleId = 666ecfc7-229d-42b8-821e-1a8f8cb7057c
RuleName = System Drawing DLL Load
EventType = Image.Load
Tag = system-drawing-dll-load
RiskScore = 25
Annotation = {"mitre_attack": ["T1113"], "author": "Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research)"}
Query = Image.Path like r"%\\System.Drawing.ni.dll"
GenericProperty1 = Image.Path


[ThreatDetectionRule platform=Windows]
# Detects changes to the "TracingDisabled" key in order to disable ETW logging for services.exe (SCM)
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = 4f281b83-0200-4b34-bf35-d24687ea57c2
RuleName = ETW Logging Disabled For SCM
EventType = Reg.Any
Tag = etw-logging-disabled-for-scm
RiskScore = 25
Annotation = {"mitre_attack": ["T1112", "T1562"], "author": "Nasreddine Bencherchali (Nextron Systems)"}
Query = Reg.TargetObject like r"%Software\\Microsoft\\Windows NT\\CurrentVersion\\Tracing\\SCM\\Regular\\TracingDisabled" and Reg.Value.Data == "DWORD (0x00000001)"
Hive = HKLM,HKU
GenericProperty1 = Reg.TargetObject
GenericProperty2 = Reg.Value.Data


[ThreatDetectionRule platform=Windows]
# Detects the load of RstrtMgr DLL (Restart Manager) by an uncommon process.
# This library has been used during ransomware campaigns to kill processes that would prevent file encryption by locking them (e.g. Conti ransomware, Cactus ransomware). It has also recently been seen used by the BiBi wiper for Windows.
# It could also be used for anti-analysis purposes by shut downing specific processes.
# Author: Luc Génaux
RuleId = 3669afd2-9891-4534-a626-e5cf03810a61
RuleName = Load Of RstrtMgr.DLL By An Uncommon Process
EventType = Image.Load
Tag = load-of-rstrtmgr.dll-by-an-uncommon-process
RiskScore = 25
Annotation = {"mitre_attack": ["T1486", "T1562.001"], "author": "Luc G\u00e9naux"}
Query = (Image.Path like r"%\\RstrtMgr.dll" or Process.Name == "RstrtMgr.dll") and not (Process.Path like r"%:\\$WINDOWS.~BT\\%" or Process.Path like r"%:\\$WinREAgent\\%" or Process.Path like r"%:\\Program Files (x86)\\%" or Process.Path like r"%:\\Program Files\\%" or Process.Path like r"%:\\ProgramData\\%" or Process.Path like r"%:\\Windows\\explorer.exe%" or Process.Path like r"%:\\Windows\\SoftwareDistribution\\%" or Process.Path like r"%:\\Windows\\SysNative\\%" or Process.Path like r"%:\\Windows\\System32\\%" or Process.Path like r"%:\\Windows\\SysWOW64\\%" or Process.Path like r"%:\\Windows\\WinSxS\\%" or Process.Path like r"%:\\WUDownloadCache\\%" or Process.Path like r"%:\\Users\\%" and Process.Path like r"%\\AppData\\Local\\Temp\\is-%" and Process.Path like r"%.tmp\\%" and Process.Path like r"%.tmp" or Process.Path like r"%:\\Windows\\Temp\\%")
GenericProperty1 = Image.Path


[ThreatDetectionRule platform=Windows]
# Detect suspicious parent processes of well-known Windows processes
# Author: vburov
RuleId = 96036718-71cc-4027-a538-d1587e0006a7
RuleName = Windows Processes Suspicious Parent Directory
EventType = Process.Start
Tag = proc-start-windows-processes-suspicious-parent-directory
RiskScore = 25
Annotation = {"mitre_attack": ["T1036.003", "T1036.005"], "author": "vburov"}
Query = (Process.Path like r"%\\svchost.exe" or Process.Path like r"%\\taskhost.exe" or Process.Path like r"%\\lsm.exe" or Process.Path like r"%\\lsass.exe" or Process.Path like r"%\\services.exe" or Process.Path like r"%\\lsaiso.exe" or Process.Path like r"%\\csrss.exe" or Process.Path like r"%\\wininit.exe" or Process.Path like r"%\\winlogon.exe") and not (Parent.Path like r"%\\SavService.exe" or Parent.Path like r"%\\ngen.exe" or Parent.Path like r"%\\System32\\%" or Parent.Path like r"%\\SysWOW64\\%" or (Parent.Path like r"%\\Windows Defender\\%" or Parent.Path like r"%\\Microsoft Security Client\\%") and Parent.Path like r"%\\MsMpEng.exe" or isnull(Parent.Path) or Parent.Path == "-")
GenericProperty1 = Parent.Path


[ThreatDetectionRule platform=Windows]
# Detects the creation of a new office macro files on the systems
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = 91174a41-dc8f-401b-be89-7bfc140612a0
RuleName = Office Macro File Creation
EventType = File.Create
Tag = office-macro-file-creation
RiskScore = 25
Annotation = {"mitre_attack": ["T1566.001"], "author": "Nasreddine Bencherchali (Nextron Systems)"}
Query = File.Path like r"%.docm" or File.Path like r"%.dotm" or File.Path like r"%.xlsm" or File.Path like r"%.xltm" or File.Path like r"%.potm" or File.Path like r"%.pptm"
GenericProperty1 = File.Path


[ThreatDetectionRule platform=Windows]
# Detects the stopping of a Windows service via the "net" utility.
# Author: Jakob Weinzettl, oscd.community, Nasreddine Bencherchali (Nextron Systems)
RuleId = 88872991-7445-4a22-90b2-a3adadb0e827
RuleName = Stop Windows Service Via Net.EXE
EventType = Process.Start
Tag = proc-start-stop-windows-service-via-net.exe
RiskScore = 25
Annotation = {"mitre_attack": ["T1489"], "author": "Jakob Weinzettl, oscd.community, Nasreddine Bencherchali (Nextron Systems)"}
Query = (Process.Name in ["net.exe", "net1.exe"] or Process.Path like r"%\\net.exe" or Process.Path like r"%\\net1.exe") and Process.CommandLine like r"% stop %"


[ThreatDetectionRule platform=Windows]
# Detects the stopping of a Windows service via the PowerShell Cmdlet "Stop-Service"
# Author: Jakob Weinzettl, oscd.community, Nasreddine Bencherchali (Nextron Systems)
RuleId = c49c5062-0966-4170-9efd-9968c913a6cf
RuleName = Stop Windows Service Via PowerShell Stop-Service
EventType = Process.Start
Tag = proc-start-stop-windows-service-via-powershell-stop-service
RiskScore = 25
Annotation = {"mitre_attack": ["T1489"], "author": "Jakob Weinzettl, oscd.community, Nasreddine Bencherchali (Nextron Systems)"}
Query = (Process.Name in ["PowerShell.EXE", "pwsh.dll"] or Process.Path like r"%\\powershell.exe" or Process.Path like r"%\\pwsh.exe") and Process.CommandLine like r"%Stop-Service %"


[ThreatDetectionRule platform=Windows]
# Detects the execution of "attrib" with the "+s" flag to mark files as system files
# Author: frack113
RuleId = bb19e94c-59ae-4c15-8c12-c563d23fe52b
RuleName = Set Files as System Files Using Attrib.EXE
EventType = Process.Start
Tag = proc-start-set-files-as-system-files-using-attrib.exe
RiskScore = 25
Annotation = {"mitre_attack": ["T1564.001"], "author": "frack113"}
Query = (Process.Path like r"%\\attrib.exe" or Process.Name == "ATTRIB.EXE") and Process.CommandLine like r"% +s %"


[ThreatDetectionRule platform=Windows]
# Detects the registration of a new ODBC driver.
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = 3390fbef-c98d-4bdd-a863-d65ed7c610dd
RuleName = New ODBC Driver Registered
EventType = Reg.Any
Tag = new-odbc-driver-registered
RiskScore = 25
Annotation = {"author": "Nasreddine Bencherchali (Nextron Systems)"}
Query = Reg.TargetObject like r"%\\SOFTWARE\\ODBC\\ODBCINST.INI\\%" and Reg.TargetObject like r"%\\Driver" and not (Reg.TargetObject like r"%\\SQL Server\\%" and Reg.Value.Data == "\%WINDIR\%\\System32\\SQLSRV32.dll") and not (Reg.TargetObject like r"%\\Microsoft Access %" and Reg.Value.Data like r"C:\\Progra%" and Reg.Value.Data like r"%\\ACEODBC.DLL" or Reg.TargetObject like r"%\\Microsoft Excel Driver%" and Reg.Value.Data like r"C:\\Progra%" and Reg.Value.Data like r"%\\ACEODBC.DLL")
Hive = HKLM,HKU
GenericProperty1 = Reg.TargetObject
GenericProperty2 = Reg.Value.Data


[ThreatDetectionRule platform=Windows]
# Detects the deletion of the TeamViewer log files which may indicate an attempt to destroy forensic evidence
# Author: frack113
RuleId = b1decb61-ed83-4339-8e95-53ea51901720
RuleName = TeamViewer Log File Deleted
EventType = File.Delete
Tag = teamviewer-log-file-deleted
RiskScore = 25
Annotation = {"mitre_attack": ["T1070.004"], "author": "frack113"}
Query = File.Path like r"%\\TeamViewer\_%" and File.Path like r"%.log" and not Process.Path == "C:\\Windows\\system32\\svchost.exe"
GenericProperty1 = File.Path


[ThreatDetectionRule platform=Windows]
# Detects changes to the AppInstaller (winget) admin settings. Such as enabling local manifest installations or disabling installer hash checks
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = 6db5eaf9-88f7-4ed9-af7d-9ef2ad12f236
RuleName = Winget Admin Settings Modification
EventType = Reg.Any
Tag = winget-admin-settings-modification
RiskScore = 25
Annotation = {"author": "Nasreddine Bencherchali (Nextron Systems)"}
Query = Process.Path like r"%\\winget.exe" and Reg.TargetObject like r"\\REGISTRY\\A\\%" and Reg.TargetObject like r"%\\LocalState\\admin\_settings"
Hive = HKLM,HKU
GenericProperty1 = Reg.TargetObject


[ThreatDetectionRule platform=Windows]
# Detects the creation of a new service using the "sc.exe" utility.
# Author: Timur Zinniatullin, Daniil Yugoslavskiy, oscd.community
RuleId = 85ff530b-261d-48c6-a441-facaa2e81e48
RuleName = New Service Creation Using Sc.EXE
EventType = Process.Start
Tag = proc-start-new-service-creation-using-sc.exe
RiskScore = 25
Annotation = {"mitre_attack": ["T1543.003"], "author": "Timur Zinniatullin, Daniil Yugoslavskiy, oscd.community"}
Query = Process.Path like r"%\\sc.exe" and Process.CommandLine like r"%create%" and Process.CommandLine like r"%binPath%"


[ThreatDetectionRule platform=Windows]
# Detects the creation of ".rev" files by WinRAR. Could be indicative of potential exploitation of CVE-2023-40477. Look for a suspicious execution shortly after creation or a WinRAR application crash.
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = c3bd6c55-d495-4c34-918e-e03e8828c074
RuleName = CVE-2023-40477 Potential Exploitation - .REV File Creation
EventType = File.Create
Tag = cve-2023-40477-potential-exploitation-.rev-file-creation
RiskScore = 25
Annotation = {"author": "Nasreddine Bencherchali (Nextron Systems)"}
Query = (Process.Path like r"%\\explorer.exe" or Process.Path like r"%\\WinRAR.exe") and File.Path like r"%.rev"
GenericProperty1 = File.Path


[ThreatDetectionRule platform=Windows]
# Detects potential suspicious execution of a GUID like folder name located in a suspicious location such as %TEMP% as seen being used in IcedID attacks.
# Use this rule to hunt for potentially suspicious activity stemming from uncommon folders.
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = 90b63c33-2b97-4631-a011-ceb0f47b77c3
RuleName = Potential Suspicious Execution From GUID Like Folder Names
EventType = Process.Start
Tag = proc-start-potential-suspicious-execution-from-guid-like-folder-names
RiskScore = 25
Annotation = {"mitre_attack": ["T1027"], "author": "Nasreddine Bencherchali (Nextron Systems)"}
Query = (Process.CommandLine like r"%\\AppData\\Roaming\\%" or Process.CommandLine like r"%\\AppData\\Local\\Temp\\%") and Process.CommandLine like r"%\\{%" and Process.CommandLine like r"%}\\%" and not (Process.Path like r"%\\{%" and Process.Path like r"%}\\%" or isnull(Process.Path) or Process.Path == "C:\\Windows\\System32\\drvinst.exe" or Process.Path in ["C:\\Windows\\System32\\msiexec.exe", "C:\\Windows\\SysWOW64\\msiexec.exe"])


[ThreatDetectionRule platform=Windows]
# Detects attempts to enumerate file shares, printer shares and sessions using "net.exe" with the "view" flag.
# Author: Endgame, JHasenbusch (ported for oscd.community)
RuleId = 62510e69-616b-4078-b371-847da438cc03
RuleName = Share And Session Enumeration Using Net.EXE
EventType = Process.Start
Tag = proc-start-share-and-session-enumeration-using-net.exe
RiskScore = 25
Annotation = {"mitre_attack": ["T1018"], "author": "Endgame, JHasenbusch (ported for oscd.community)"}
Query = (Process.Path like r"%\\net.exe" or Process.Path like r"%\\net1.exe" or Process.Name in ["net.exe", "net1.exe"]) and Process.CommandLine like r"%view%" and not Process.CommandLine like r"%\\\\%"


[ThreatDetectionRule platform=Windows]
# Detects Microsoft Excel loading an Add-In (.xll) file
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = c5f4b5cb-4c25-4249-ba91-aa03626e3185
RuleName = Microsoft Excel Add-In Loaded
EventType = Image.Load
Tag = microsoft-excel-add-in-loaded
RiskScore = 25
Annotation = {"mitre_attack": ["T1204.002"], "author": "Nasreddine Bencherchali (Nextron Systems)"}
Query = Process.Path like r"%\\excel.exe" and Image.Path like r"%.xll"
GenericProperty1 = Image.Path


[ThreatDetectionRule platform=Windows]
# Detects default PsExec service filename which indicates PsExec service installation and execution
# Author: Thomas Patzke
RuleId = 259e5a6a-b8d2-4c38-86e2-26c5e651361d
RuleName = PsExec Service File Creation
EventType = File.Create
Tag = psexec-service-file-creation
RiskScore = 25
Annotation = {"mitre_attack": ["T1569.002"], "author": "Thomas Patzke"}
Query = File.Path like r"%\\PSEXESVC.exe"
GenericProperty1 = File.Path


[ThreatDetectionRule platform=Windows]
# Detects execution of "tar.exe" in order to extract compressed file.
# Adversaries may abuse various utilities in order to decompress data to avoid detection.
# Author: AdmU3
RuleId = bf361876-6620-407a-812f-bfe11e51e924
RuleName = Compressed File Extraction Via Tar.EXE
EventType = Process.Start
Tag = proc-start-compressed-file-extraction-via-tar.exe
RiskScore = 25
Annotation = {"mitre_attack": ["T1560", "T1560.001"], "author": "AdmU3"}
Query = (Process.Path like r"%\\tar.exe" or Process.Name == "bsdtar") and Process.CommandLine like r"%-x%"


[ThreatDetectionRule platform=Windows]
# Local accounts, System Owner/User discovery using operating systems utilities
# Author: Timur Zinniatullin, Daniil Yugoslavskiy, oscd.community
RuleId = 502b42de-4306-40b4-9596-6f590c81f073
RuleName = Local Accounts Discovery
EventType = Process.Start
Tag = proc-start-local-accounts-discovery
RiskScore = 25
Annotation = {"mitre_attack": ["T1033", "T1087.001"], "author": "Timur Zinniatullin, Daniil Yugoslavskiy, oscd.community"}
Query = Process.Path like r"%\\cmd.exe" and Process.CommandLine like r"% /c%" and Process.CommandLine like r"%dir %" and Process.CommandLine like r"%\\Users\\%" and not Process.CommandLine like r"% rmdir %" or (Process.Path like r"%\\net.exe" or Process.Path like r"%\\net1.exe") and Process.CommandLine like r"%user%" and not (Process.CommandLine like r"%/domain%" or Process.CommandLine like r"%/add%" or Process.CommandLine like r"%/delete%" or Process.CommandLine like r"%/active%" or Process.CommandLine like r"%/expires%" or Process.CommandLine like r"%/passwordreq%" or Process.CommandLine like r"%/scriptpath%" or Process.CommandLine like r"%/times%" or Process.CommandLine like r"%/workstations%") or Process.Path like r"%\\whoami.exe" or Process.Path like r"%\\quser.exe" or Process.Path like r"%\\qwinsta.exe" or Process.Path like r"%\\wmic.exe" and Process.CommandLine like r"%useraccount%" and Process.CommandLine like r"%get%" or Process.Path like r"%\\cmdkey.exe" and Process.CommandLine like r"% /l%"


[ThreatDetectionRule platform=Windows]
# Detects file access requests to Windows Outlook Mail by uncommon processes.
# Could indicate potential attempt of credential stealing.
# Requires heavy baselining before usage
# Author: frack113
RuleId = fc3e237f-2fef-406c-b90d-b3ae7e02fa8f
RuleName = Access To Windows Outlook Mail Files By Uncommon Applications
EventType = File.Read
Tag = access-to-windows-outlook-mail-files-by-uncommon-applications
RiskScore = 25
Annotation = {"mitre_attack": ["T1070.008"], "author": "frack113"}
Query = (File.Path like r"%\\AppData\\Local\\Comms\\Unistore\\data%" or File.Path like r"%\\AppData\\Local\\Comms\\UnistoreDB\\store.vol") and not (Process.Path == "System" or Process.Path like r"C:\\Program Files (x86)\\%" or Process.Path like r"C:\\Program Files\\%" or Process.Path like r"C:\\Windows\\system32\\%" or Process.Path like r"C:\\Windows\\SysWOW64\\%") and not (Process.Path like r"C:\\ProgramData\\Microsoft\\Windows Defender\\%" and (Process.Path like r"%\\MpCopyAccelerator.exe" or Process.Path like r"%\\MsMpEng.exe") or Process.Path like r"%\\thor64.exe" or Process.Path like r"%\\thor.exe")
GenericProperty1 = File.Path


[ThreatDetectionRule platform=Windows]
# Detects the usage of the "net.exe" command to start a service using the "start" flag
# Author: Timur Zinniatullin, Daniil Yugoslavskiy, oscd.community
RuleId = 2a072a96-a086-49fa-bcb5-15cc5a619093
RuleName = Start Windows Service Via Net.EXE
EventType = Process.Start
Tag = proc-start-start-windows-service-via-net.exe
RiskScore = 25
Annotation = {"mitre_attack": ["T1569.002"], "author": "Timur Zinniatullin, Daniil Yugoslavskiy, oscd.community"}
Query = (Process.Path like r"%\\net.exe" or Process.Path like r"%\\net1.exe" or Process.Name in ["net.exe", "net1.exe"]) and Process.CommandLine like r"% start %"


[ThreatDetectionRule platform=Windows]
# Detects execution of "tar.exe" in order to create a compressed file.
# Adversaries may abuse various utilities to compress or encrypt data before exfiltration.
# Author: Nasreddine Bencherchali (Nextron Systems), AdmU3
RuleId = 418a3163-3247-4b7b-9933-dcfcb7c52ea9
RuleName = Compressed File Creation Via Tar.EXE
EventType = Process.Start
Tag = proc-start-compressed-file-creation-via-tar.exe
RiskScore = 25
Annotation = {"mitre_attack": ["T1560", "T1560.001"], "author": "Nasreddine Bencherchali (Nextron Systems), AdmU3"}
Query = (Process.Path like r"%\\tar.exe" or Process.Name == "bsdtar") and (Process.CommandLine like r"%-c%" or Process.CommandLine like r"%-r%" or Process.CommandLine like r"%-u%")


[ThreatDetectionRule platform=Windows]
# Detects usage of the "dir" command part of Widows CMD with the "/S" command line flag in order to enumerate files in a specified directory and all subdirectories.
# Author: frack113
RuleId = 7c9340a9-e2ee-4e43-94c5-c54ebbea1006
RuleName = File And SubFolder Enumeration Via Dir Command
EventType = Process.Start
Tag = proc-start-file-and-subfolder-enumeration-via-dir-command
RiskScore = 25
Annotation = {"mitre_attack": ["T1217"], "author": "frack113"}
Query = (Process.Path like r"%\\cmd.exe" or Process.Name == "Cmd.Exe") and (Process.CommandLine like r"%dir%-s%" or Process.CommandLine like r"%dir%/s%" or Process.CommandLine like r"%dir%–s%" or Process.CommandLine like r"%dir%—s%" or Process.CommandLine like r"%dir%―s%")


[ThreatDetectionRule platform=Windows]
# Adversaries may look for details about the network configuration and settings of systems they access or through information discovery of remote systems
# Author: frack113, Christopher Peacock '@securepeacock', SCYTHE '@scythe_io'
RuleId = 0e4164da-94bc-450d-a7be-a4b176179f1f
RuleName = Firewall Configuration Discovery Via Netsh.EXE
EventType = Process.Start
Tag = proc-start-firewall-configuration-discovery-via-netsh.exe
RiskScore = 25
Annotation = {"mitre_attack": ["T1016"], "author": "frack113, Christopher Peacock '@securepeacock', SCYTHE '@scythe_io'"}
Query = (Process.Path like r"%\\netsh.exe" or Process.Name == "netsh.exe") and Process.CommandLine like r"%netsh %" and Process.CommandLine like r"%show %" and Process.CommandLine like r"%firewall %" and (Process.CommandLine like r"%config %" or Process.CommandLine like r"%state %" or Process.CommandLine like r"%rule %" or Process.CommandLine like r"%name=all%")


[ThreatDetectionRule platform=Windows]
# Adversaries may attempt to get a listing of network connections to or from the compromised system they are currently accessing or from remote systems by querying for information over the network.
# Author: frack113
RuleId = 1c67a717-32ba-409b-a45d-0fb704a73a81
RuleName = System Network Connections Discovery Via Net.EXE
EventType = Process.Start
Tag = proc-start-system-network-connections-discovery-via-net.exe
RiskScore = 25
Annotation = {"mitre_attack": ["T1049"], "author": "frack113"}
Query = (Process.Path like r"%\\net.exe" or Process.Path like r"%\\net1.exe" or Process.Name in ["net.exe", "net1.exe"]) and (Process.CommandLine like r"% use" or Process.CommandLine like r"% sessions" or Process.CommandLine like r"% use %" or Process.CommandLine like r"% sessions %")


[ThreatDetectionRule platform=Windows]
# Detects execution of the builtin "rmdir" command in order to delete directories.
# Adversaries may delete files left behind by the actions of their intrusion activity.
# Malware, tools, or other non-native files dropped or created on a system by an adversary may leave traces to indicate to what was done within a network and how.
# Removal of these files can occur during an intrusion, or as part of a post-intrusion process to minimize the adversary's footprint.
# Author: frack113
RuleId = 41ca393d-538c-408a-ac27-cf1e038be80c
RuleName = Directory Removal Via Rmdir
EventType = Process.Start
Tag = proc-start-directory-removal-via-rmdir
RiskScore = 25
Annotation = {"mitre_attack": ["T1070.004"], "author": "frack113"}
Query = (Process.Path like r"%\\cmd.exe" or Process.Name == "Cmd.Exe") and Process.CommandLine like r"%rmdir%" and (Process.CommandLine like r"%/s%" or Process.CommandLine like r"%/q%")


[ThreatDetectionRule platform=Windows]
# Detects file access requests to browser credential stores by uncommon processes.
# Could indicate potential attempt of credential stealing.
# Requires heavy baselining before usage
# Author: frack113, X__Junior (Nextron Systems)
RuleId = 91cb43db-302a-47e3-b3c8-7ede481e27bf
RuleName = Access To Browser Credential Files By Uncommon Applications
EventType = File.Read
Tag = access-to-browser-credential-files-by-uncommon-applications
RiskScore = 25
Annotation = {"mitre_attack": ["T1003"], "author": "frack113, X__Junior (Nextron Systems)"}
Query = (File.Path like r"%\\Appdata\\Local\\Microsoft\\Windows\\WebCache\\WebCacheV01.dat" or File.Path like r"%\\cookies.sqlite" or File.Path like r"%\\places.sqlite" or File.Path like r"%release\\key3.db" or File.Path like r"%release\\key4.db" or File.Path like r"%release\\logins.json" or File.Path like r"%\\User Data\\Default\\Login Data%" or File.Path like r"%\\User Data\\Local State%") and not (Process.Path == "System" or Process.Path like r"C:\\Program Files (x86)\\%" or Process.Path like r"C:\\Program Files\\%" or Process.Path like r"C:\\Windows\\system32\\%" or Process.Path like r"C:\\Windows\\SysWOW64\\%") and not (Process.Path like r"C:\\ProgramData\\Microsoft\\Windows Defender\\%" and (Process.Path like r"%\\MpCopyAccelerator.exe" or Process.Path like r"%\\MsMpEng.exe") or Process.Path like r"%\\thor.exe" or Process.Path like r"%\\thor64.exe")
GenericProperty1 = File.Path


[ThreatDetectionRule platform=Windows]
# Detects the execution of "BitLockerToGo.EXE".
# BitLocker To Go is BitLocker Drive Encryption on removable data drives. This feature includes the encryption of, USB flash drives, SD cards, External hard disk drives, Other drives that are formatted by using the NTFS, FAT16, FAT32, or exFAT file system.
# This is a rarely used application and usage of it at all is worth investigating.
# Malware such as Lumma stealer has been seen using this process as a target for process hollowing.
# Author: Josh Nickels, mttaggart
RuleId = 7f2376f9-42ee-4dfc-9360-fecff9a88fc8
RuleName = BitLockerTogo.EXE Execution
EventType = Process.Start
Tag = proc-start-bitlockertogo.exe-execution
RiskScore = 25
Annotation = {"mitre_attack": ["T1218"], "author": "Josh Nickels, mttaggart"}
Query = Process.Path like r"%\\BitLockerToGo.exe"


[ThreatDetectionRule platform=Windows]
# Detects the deletion of the "Zone.Identifier" ADS. Attackers can leverage this in order to bypass security restrictions that make use of the ADS such as Microsoft Office apps.
# Author: frack113
RuleId = 7eac0a16-5832-4e81-865f-0268a6d19e4b
RuleName = ADS Zone.Identifier Deleted
EventType = File.Delete
Tag = ads-zone.identifier-deleted
RiskScore = 25
Annotation = {"mitre_attack": ["T1070.004"], "author": "frack113"}
Query = File.Path like r"%:Zone.Identifier"
GenericProperty1 = File.Path


[ThreatDetectionRule platform=Windows]
# Adversaries may enumerate browser bookmarks to learn more about compromised hosts.
# Browser bookmarks may reveal personal information about users (ex: banking sites, interests, social media, etc.) as well as details about
# internal network resources such as servers, tools/dashboards, or other related infrastructure.
# Author: frack113, Nasreddine Bencherchali (Nextron Systems)
RuleId = 725a9768-0f5e-4cb3-aec2-bc5719c6831a
RuleName = Suspicious Where Execution
EventType = Process.Start
Tag = proc-start-suspicious-where-execution
RiskScore = 25
Annotation = {"mitre_attack": ["T1217"], "author": "frack113, Nasreddine Bencherchali (Nextron Systems)"}
Query = (Process.Path like r"%\\where.exe" or Process.Name == "where.exe") and (Process.CommandLine like r"%places.sqlite%" or Process.CommandLine like r"%cookies.sqlite%" or Process.CommandLine like r"%formhistory.sqlite%" or Process.CommandLine like r"%logins.json%" or Process.CommandLine like r"%key4.db%" or Process.CommandLine like r"%key3.db%" or Process.CommandLine like r"%sessionstore.jsonlz4%" or Process.CommandLine like r"%History%" or Process.CommandLine like r"%Bookmarks%" or Process.CommandLine like r"%Cookies%" or Process.CommandLine like r"%Login Data%")


[ThreatDetectionRule platform=Windows]
# Use of reg to get MachineGuid information
# Author: frack113
RuleId = f5240972-3938-4e56-8e4b-e33893176c1f
RuleName = Suspicious Query of MachineGUID
EventType = Process.Start
Tag = proc-start-suspicious-query-of-machineguid
RiskScore = 25
Annotation = {"mitre_attack": ["T1082"], "author": "frack113"}
Query = Process.Path like r"%\\reg.exe" and Process.CommandLine like r"%SOFTWARE\\Microsoft\\Cryptography%" and Process.CommandLine like r"%/v %" and Process.CommandLine like r"%MachineGuid%"


[ThreatDetectionRule platform=Windows]
# This tool enables enumeration and exporting of all DNS records in the zone for recon purposes of internal networks Python 3 and python.exe must be installed,
# Usee to Query/modify DNS records for Active Directory integrated DNS via LDAP
# Author: frack113
RuleId = 26d3f0a2-f514-4a3f-a8a7-e7e48a8d9160
RuleName = PUA - Adidnsdump Execution
EventType = Process.Start
Tag = proc-start-pua-adidnsdump-execution
RiskScore = 25
Annotation = {"mitre_attack": ["T1018"], "author": "frack113"}
Query = Process.Path like r"%\\python.exe" and Process.CommandLine like r"%adidnsdump%"


[ThreatDetectionRule platform=Windows]
# Detects the creation of an executable by another executable.
# Author: frack113
RuleId = 297afac9-5d02-4138-8c58-b977bac60556
RuleName = Creation of an Executable by an Executable
EventType = File.Create
Tag = creation-of-an-executable-by-an-executable
RiskScore = 25
Annotation = {"mitre_attack": ["T1587.001"], "author": "frack113"}
Query = Process.Path like r"%.exe" and File.Path like r"%.exe" and not (Process.Path like r"%:\\Windows\\System32\\msiexec.exe" or Process.Path like r"%:\\Windows\\system32\\cleanmgr.exe" or Process.Path like r"%:\\Windows\\explorer.exe" or Process.Path like r"%:\\WINDOWS\\system32\\dxgiadaptercache.exe" or Process.Path like r"%:\\WINDOWS\\system32\\Dism.exe" or Process.Path like r"%:\\Windows\\System32\\wuauclt.exe" or Process.Path like r"%:\\WINDOWS\\system32\\svchost.exe" and File.Path like r"%:\\Windows\\SoftwareDistribution\\Download\\%" or Process.Path like r"%:\\Windows\\system32\\svchost.exe" and File.Path like r"%:\\WUDownloadCache\\%" and File.Path like r"%\\WindowsUpdateBox.exe%" or Process.Path like r"%:\\WINDOWS\\SoftwareDistribution\\Download\\%" and Process.Path like r"%\\WindowsUpdateBox.Exe" and File.Path like r"%:\\$WINDOWS.~BT\\Sources\\%" or Process.Path like r"%:\\Windows\\WinSxS\\%" and Process.Path like r"%\\TiWorker.exe" or Process.Path like r"%:\\Program Files\\%" or Process.Path like r"%:\\Program Files (x86)\\%" or File.Path like r"%:\\Program Files\\%" or File.Path like r"%:\\Program Files (x86)\\%" or Process.Path like r"%:\\ProgramData\\Microsoft\\Windows Defender\\%" or Process.Path like r"%:\\Program Files\\Windows Defender\\%" or File.Path like r"%\\AppData\\Local\\Microsoft\\WindowsApps\\%" or Process.Path like r"%\\AppData\\Local\\Microsoft\\Teams\\Update.exe" and (File.Path like r"%\\AppData\\Local\\Microsoft\\Teams\\stage\\Teams.exe" or File.Path like r"%\\AppData\\Local\\Microsoft\\Teams\\stage\\Squirrel.exe" or File.Path like r"%\\AppData\\Local\\Microsoft\\SquirrelTemp\\tempb\\") or Process.Path like r"%:\\Windows\\Microsoft.NET\\Framework\\%" and Process.Path like r"%\\mscorsvw.exe" and File.Path like r"%:\\Windows\\assembly\\NativeImages\_%" or Process.Path like r"%\\AppData\\Local\\%" and Process.Path like r"%\\Microsoft VS Code\\Code.exe" and File.Path like r"%\\.vscode\\extensions\\%" or Process.Path like r"%\\AppData\\Local\\GitHubDesktop\\Update.exe" and File.Path like r"%\\AppData\\Local\\SquirrelTemp\\%" or Process.Path like r"%:\\WINDOWS\\TEMP\\%" or File.Path like r"%:\\WINDOWS\\TEMP\\%" or Process.Path like r"%\\AppData\\Local\\Temp\\%" or File.Path like r"%\\AppData\\Local\\Temp\\%" or Process.Path like r"%:\\Windows\\Microsoft.NET\\Framework%" and Process.Path like r"%\\mscorsvw.exe" and File.Path like r"%:\\Windows\\assembly%") and not (Process.Path like r"%\\Python27\\python.exe%" and (File.Path like r"%\\Python27\\Lib\\site-packages\\%" or File.Path like r"%\\Python27\\Scripts\\%" or File.Path like r"%\\AppData\\Local\\Temp\\%") or Process.Path like r"%\\AppData\\Local\\SquirrelTemp\\Update.exe%" and File.Path like r"%\\AppData\\Local%" or Process.Path like r"%\\ChromeSetup.exe" and File.Path like r"%\\Google%")
GenericProperty1 = File.Path


[ThreatDetectionRule platform=Windows]
# Detects the command line executed when TeamViewer starts a session started by a remote host.
# Once a connection has been started, an investigator can verify the connection details by viewing the "incoming_connections.txt" log file in the TeamViewer folder.
# Author: Josh Nickels, Qi Nan
RuleId = ab70c354-d9ac-4e11-bbb6-ec8e3b153357
RuleName = Remote Access Tool - Team Viewer Session Started On Windows Host
EventType = Process.Start
Tag = proc-start-remote-access-tool-team-viewer-session-started-on-windows-host
RiskScore = 25
Annotation = {"mitre_attack": ["T1133"], "author": "Josh Nickels, Qi Nan"}
Query = Process.Path == "TeamViewer\_Desktop.exe" and Parent.Path == "TeamViewer\_Service.exe" and Process.CommandLine like r"%TeamViewer\_Desktop.exe --IPCport 5939 --Module 1"
GenericProperty1 = Parent.Path


[ThreatDetectionRule platform=Windows]
# Detects execution of "taskkill.exe" in order to stop a service or a process. Look for suspicious parents executing this command in order to hunt for potential malicious activity.
# Attackers might leverage this in order to conduct data destruction or data encrypted for impact on the data stores of services like Exchange and SQL Server.
# Author: frack113, MalGamy (Nextron Systems), Nasreddine Bencherchali
RuleId = 86085955-ea48-42a2-9dd3-85d4c36b167d
RuleName = Process Terminated Via Taskkill
EventType = Process.Start
Tag = proc-start-process-terminated-via-taskkill
RiskScore = 25
Annotation = {"mitre_attack": ["T1489"], "author": "frack113, MalGamy (Nextron Systems), Nasreddine Bencherchali"}
Query = (Process.Path like r"%\\taskkill.exe" or Process.Name == "taskkill.exe") and (Process.CommandLine like r"% -f %" or Process.CommandLine like r"% /f %" or Process.CommandLine like r"% –f %" or Process.CommandLine like r"% —f %" or Process.CommandLine like r"% ―f %" or Process.CommandLine like r"% -f" or Process.CommandLine like r"% /f" or Process.CommandLine like r"% –f" or Process.CommandLine like r"% —f" or Process.CommandLine like r"% ―f") and (Process.CommandLine like r"% -im %" or Process.CommandLine like r"% /im %" or Process.CommandLine like r"% –im %" or Process.CommandLine like r"% —im %" or Process.CommandLine like r"% ―im %" or Process.CommandLine like r"% -pid %" or Process.CommandLine like r"% /pid %" or Process.CommandLine like r"% –pid %" or Process.CommandLine like r"% —pid %" or Process.CommandLine like r"% ―pid %") and not ((Parent.Path like r"%\\AppData\\Local\\Temp\\%" or Parent.Path like r"%:\\Windows\\Temp%") and Parent.Path like r"%.tmp")
GenericProperty1 = Parent.Path


[ThreatDetectionRule platform=Windows]
# Detects execution of findstr with the "s" and "i" flags for a "subfolder" and "insensitive" search respectively. Attackers sometimes leverage this built-in utility to search the system for interesting files or filter through results of commands.
# Author: Furkan CALISKAN, @caliskanfurkan_, @oscd_initiative, Nasreddine Bencherchali (Nextron Systems)
RuleId = 04936b66-3915-43ad-a8e5-809eadfd1141
RuleName = Insensitive Subfolder Search Via Findstr.EXE
EventType = Process.Start
Tag = proc-start-insensitive-subfolder-search-via-findstr.exe
RiskScore = 25
Annotation = {"mitre_attack": ["T1218", "T1564.004", "T1552.001", "T1105"], "author": "Furkan CALISKAN, @caliskanfurkan_, @oscd_initiative, Nasreddine Bencherchali (Nextron Systems)"}
Query = (Process.CommandLine like r"%findstr%" or Process.Path like r"%findstr.exe" or Process.Name == "FINDSTR.EXE") and (Process.CommandLine like r"% -s %" or Process.CommandLine like r"% /s %" or Process.CommandLine like r"% –s %" or Process.CommandLine like r"% —s %" or Process.CommandLine like r"% ―s %") and (Process.CommandLine like r"% -i %" or Process.CommandLine like r"% /i %" or Process.CommandLine like r"% –i %" or Process.CommandLine like r"% —i %" or Process.CommandLine like r"% ―i %")


[ThreatDetectionRule platform=Windows]
# Detects a non-browser process communicating with the Notion API. This could indicate potential use of a covert C2 channel such as "OffensiveNotion C2"
# Author: Gavin Knapp
RuleId = 7e9cf7b6-e827-11ed-a05b-15959c120003
RuleName = Potentially Suspicious Network Connection To Notion API
EventType = Net.Any
Tag = potentially-suspicious-network-connection-to-notion-api
RiskScore = 25
Annotation = {"mitre_attack": ["T1102"], "author": "Gavin Knapp"}
Query = Net.Target.Name like r"%api.notion.com%" and not (Process.Path like r"%\\AppData\\Local\\Programs\\Notion\\Notion.exe" or Process.Path like r"%\\brave.exe" or Process.Path in ["C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe", "C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe"] or Process.Path in ["C:\\Program Files\\Mozilla Firefox\\firefox.exe", "C:\\Program Files (x86)\\Mozilla Firefox\\firefox.exe"] or Process.Path in ["C:\\Program Files (x86)\\Internet Explorer\\iexplore.exe", "C:\\Program Files\\Internet Explorer\\iexplore.exe"] or Process.Path like r"%\\maxthon.exe" or Process.Path like r"C:\\Program Files (x86)\\Microsoft\\EdgeWebView\\Application\\%" or Process.Path like r"%\\WindowsApps\\MicrosoftEdge.exe" or Process.Path in ["C:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe", "C:\\Program Files\\Microsoft\\Edge\\Application\\msedge.exe"] or (Process.Path like r"C:\\Program Files (x86)\\Microsoft\\EdgeCore\\%" or Process.Path like r"C:\\Program Files\\Microsoft\\EdgeCore\\%") and (Process.Path like r"%\\msedge.exe" or Process.Path like r"%\\msedgewebview2.exe") or Process.Path like r"%\\opera.exe" or Process.Path like r"%\\safari.exe" or Process.Path like r"%\\seamonkey.exe" or Process.Path like r"%\\vivaldi.exe" or Process.Path like r"%\\whale.exe")
GenericProperty1 = Net.Target.Name


[ThreatDetectionRule platform=Windows]
# Detects the enumeration and query of interesting and in some cases sensitive services on the system via "sc.exe".
# Attackers often try to enumerate the services currently running on a system in order to find different attack vectors.
# Author: Swachchhanda Shrawan Poudel
RuleId = e83e8899-c9b2-483b-b355-5decc942b959
RuleName = Interesting Service Enumeration Via Sc.EXE
EventType = Process.Start
Tag = proc-start-interesting-service-enumeration-via-sc.exe
RiskScore = 25
Annotation = {"mitre_attack": ["T1003"], "author": "Swachchhanda Shrawan Poudel"}
Query = (Process.Path like r"%\\sc.exe" or Process.Name == "sc.exe") and Process.CommandLine like r"%query%" and Process.CommandLine like r"%termservice%"


[ThreatDetectionRule platform=Windows]
# Detects DNS queries to "ufile.io", which was seen abused by malware and threat actors as a method for data exfiltration
# Author: yatinwad, TheDFIRReport
RuleId = 1cbbeaaf-3c8c-4e4c-9d72-49485b6a176b
RuleName = DNS Query To Ufile.io
EventType = Dns.Query
Tag = dns-query-to-ufile.io
RiskScore = 25
Annotation = {"mitre_attack": ["T1567.002"], "author": "yatinwad, TheDFIRReport"}
Query = Dns.QueryRequest like r"%ufile.io%"
GenericProperty1 = Dns.QueryRequest


[ThreatDetectionRule platform=Windows]
# When C# is compiled dynamically, a .cmdline file will be created as a part of the process.
# Certain processes are not typically observed compiling C# code, but can do so without touching disk.
# This can be used to unpack a payload for execution
# Author: frack113
RuleId = e4a74e34-ecde-4aab-b2fb-9112dd01aed0
RuleName = Dynamic CSharp Compile Artefact
EventType = File.Create
Tag = dynamic-csharp-compile-artefact
RiskScore = 25
Annotation = {"mitre_attack": ["T1027.004"], "author": "frack113"}
Query = File.Path like r"%.cmdline"
GenericProperty1 = File.Path


[ThreatDetectionRule platform=Windows]
# Windows Test Authoring and Execution Framework (TAEF) framework allows you to run automation by executing tests files written on different languages (C, C#, Microsoft COM Scripting interfaces
# Adversaries may execute malicious code (such as WSC file with VBScript, dll and so on) directly by running te.exe
# Author: Agro (@agro_sev) oscd.community
RuleId = 634b00d5-ccc3-4a06-ae3b-0ec8444dd51b
RuleName = Malicious Windows Script Components File Execution by TAEF Detection
EventType = Process.Start
Tag = proc-start-malicious-windows-script-components-file-execution-by-taef-detection
RiskScore = 25
Annotation = {"mitre_attack": ["T1218"], "author": "Agro (@agro_sev) oscd.community"}
Query = Process.Path like r"%\\te.exe" or Parent.Path like r"%\\te.exe" or Process.Name == "\\te.exe"
GenericProperty1 = Parent.Path


[ThreatDetectionRule platform=Windows]
# Detects potential DLL sideloading of "7za.dll"
# Author: X__Junior
RuleId = 4f6edb78-5c21-42ab-a558-fd2a6fc1fd57
RuleName = Potential 7za.DLL Sideloading
EventType = Image.Load
Tag = potential-7za.dll-sideloading
RiskScore = 25
Annotation = {"mitre_attack": ["T1574.001", "T1574.002"], "author": "X__Junior"}
Query = Image.Path like r"%\\7za.dll" and not ((Process.Path like r"C:\\Program Files (x86)\\%" or Process.Path like r"C:\\Program Files\\%") and (Image.Path like r"C:\\Program Files (x86)\\%" or Image.Path like r"C:\\Program Files\\%"))
GenericProperty1 = Image.Path


[ThreatDetectionRule platform=Windows]
# Detects specific combinations of encoding methods in PowerShell via the commandline
# Author: Teymur Kheirkhabarov (idea), Vasiliy Burov (rule), oscd.community, Tim Shelton
RuleId = cdf05894-89e7-4ead-b2b0-0a5f97a90f2f
RuleName = Potential Encoded PowerShell Patterns In CommandLine
EventType = Process.Start
Tag = proc-start-potential-encoded-powershell-patterns-in-commandline
RiskScore = 25
Annotation = {"mitre_attack": ["T1027", "T1059.001"], "author": "Teymur Kheirkhabarov (idea), Vasiliy Burov (rule), oscd.community, Tim Shelton"}
Query = (Process.Path like r"%\\powershell.exe" or Process.Path like r"%\\pwsh.exe" or Process.Name in ["PowerShell.EXE", "pwsh.dll"]) and ((Process.CommandLine like r"%ToInt%" or Process.CommandLine like r"%ToDecimal%" or Process.CommandLine like r"%ToByte%" or Process.CommandLine like r"%ToUint%" or Process.CommandLine like r"%ToSingle%" or Process.CommandLine like r"%ToSByte%") and (Process.CommandLine like r"%ToChar%" or Process.CommandLine like r"%ToString%" or Process.CommandLine like r"%String%") or Process.CommandLine like r"%char%" and Process.CommandLine like r"%join%" or Process.CommandLine like r"%split%" and Process.CommandLine like r"%join%")


[ThreatDetectionRule platform=Windows]
# Adversaries may look for details about the network configuration and settings of systems they access or through information discovery of remote systems
# Author: frack113, Christopher Peacock '@securepeacock', SCYTHE '@scythe_io'
RuleId = a29c1813-ab1f-4dde-b489-330b952e91ae
RuleName = Suspicious Network Command
EventType = Process.Start
Tag = proc-start-suspicious-network-command
RiskScore = 25
Annotation = {"mitre_attack": ["T1016"], "author": "frack113, Christopher Peacock '@securepeacock', SCYTHE '@scythe_io'"}
Query = Process.CommandLine like r"%ipconfig /all%" or Process.CommandLine like r"%netsh interface show interface%" or Process.CommandLine like r"%arp -a%" or Process.CommandLine like r"%nbtstat -n%" or Process.CommandLine like r"%net config%" or Process.CommandLine like r"%route print%"


[ThreatDetectionRule platform=Windows]
# Detects the creation of scheduled tasks by user accounts via the "schtasks" utility.
# Author: Florian Roth (Nextron Systems)
RuleId = 92626ddd-662c-49e3-ac59-f6535f12d189
RuleName = Scheduled Task Creation Via Schtasks.EXE
EventType = Process.Start
Tag = proc-start-scheduled-task-creation-via-schtasks.exe
RiskScore = 25
Annotation = {"mitre_attack": ["T1053.005"], "author": "Florian Roth (Nextron Systems)"}
Query = Process.Path like r"%\\schtasks.exe" and Process.CommandLine like r"% /create %" and not (Process.User like r"%AUTHORI%" or Process.User like r"%AUTORI%")
GenericProperty1 = Process.User


[ThreatDetectionRule platform=Windows]
# Detects the creation of a scheduled task via file creation.
# Author: Center for Threat Informed Defense (CTID) Summiting the Pyramid Team
RuleId = a762e74f-4dce-477c-b023-4ed81df600f9
RuleName = Scheduled Task Created - FileCreation
EventType = File.Create
Tag = scheduled-task-created-filecreation
RiskScore = 25
Annotation = {"mitre_attack": ["T1053.005"], "author": "Center for Threat Informed Defense (CTID) Summiting the Pyramid Team"}
Query = File.Path like r"%:\\Windows\\System32\\Tasks\\%" or File.Path like r"%:\\Windows\\SysWOW64\\Tasks\\%" or File.Path like r"%:\\Windows\\Tasks\\%"
GenericProperty1 = File.Path


[ThreatDetectionRule platform=Windows]
# Detects DNS query requests to "update.onelaunch.com". This domain is associated with the OneLaunch adware application.
# When the OneLaunch application is installed it will attempt to get updates from this domain.
# Author: Josh Nickels
RuleId = df68f791-ad95-447f-a271-640a0dab9cf8
RuleName = DNS Query Request To OneLaunch Update Service
EventType = Dns.Query
Tag = dns-query-request-to-onelaunch-update-service
RiskScore = 25
Annotation = {"mitre_attack": ["T1056"], "author": "Josh Nickels"}
Query = Dns.QueryRequest == "update.onelaunch.com" and Process.Path like r"%\\OneLaunch.exe"
GenericProperty1 = Dns.QueryRequest


[ThreatDetectionRule platform=Windows]
# Detects when a share is mounted using the "net.exe" utility
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = f117933c-980c-4f78-b384-e3d838111165
RuleName = Windows Share Mount Via Net.EXE
EventType = Process.Start
Tag = proc-start-windows-share-mount-via-net.exe
RiskScore = 25
Annotation = {"mitre_attack": ["T1021.002"], "author": "Nasreddine Bencherchali (Nextron Systems)"}
Query = (Process.Path like r"%\\net.exe" or Process.Path like r"%\\net1.exe" or Process.Name in ["net.exe", "net1.exe"]) and (Process.CommandLine like r"% use %" or Process.CommandLine like r"% \\\\%")


[ThreatDetectionRule platform=Windows]
# Detects DNS server discovery via LDAP query requests from uncommon applications
# Author: frack113
RuleId = a21bcd7e-38ec-49ad-b69a-9ea17e69509e
RuleName = DNS Server Discovery Via LDAP Query
EventType = Dns.Query
Tag = dns-server-discovery-via-ldap-query
RiskScore = 25
Annotation = {"mitre_attack": ["T1482"], "author": "frack113"}
Query = Dns.QueryRequest like r"\_ldap.%" and not (Process.Path like r"%:\\Program Files\\%" or Process.Path like r"%:\\Program Files (x86)\\%" or Process.Path like r"%:\\Windows\\%" or Process.Path like r"%:\\ProgramData\\Microsoft\\Windows Defender\\Platform\\%" and Process.Path like r"%\\MsMpEng.exe" or Process.Path == "<unknown process>" or isnull(Process.Path)) and not (Process.Path like r"C:\\WindowsAzure\\GuestAgent%" or Process.Path like r"%\\chrome.exe" or Process.Path like r"%\\firefox.exe" or Process.Path like r"%\\opera.exe")
GenericProperty1 = Dns.QueryRequest

