
#
# The rules are generated from the Sigma GitHub repository at https://github.com/SigmaHQ/sigma
# To generate the ruleset, please follow the instructions provided in the repository: https://github.com/vastlimits/pySigma-backend-uberAgent/
#
# The command used to generate the ruleset is:
#    sigma convert -s -f conf -p uberagent-7.1.0 -O backend_version=7.1.0 -t uberagent /home/runner/work/uberAgent-config/uberAgent-config/build/sigma-low-macos >> uberAgent-ESA-am-sigma-low-macos.conf
#

[ActivityMonitoringRule platform=MacOS]
# Detects attempts to use system dialog prompts to capture user credentials
# Author: remotephone, oscd.community
RuleId = 60f1ce20-484e-41bd-85f4-ac4afec2c541
RuleName = GUI Input Capture - macOS
EventType = Process.Start
Tag = proc-start-gui-input-capture-macos
RiskScore = 25
Annotation = {"mitre_attack": ["T1056.002"]}
Query = Process.Path == "/usr/sbin/osascript" and Process.CommandLine like r"%-e%" and Process.CommandLine like r"%display%" and Process.CommandLine like r"%dialog%" and Process.CommandLine like r"%answer%" and (Process.CommandLine like r"%admin%" or Process.CommandLine like r"%administrator%" or Process.CommandLine like r"%authenticate%" or Process.CommandLine like r"%authentication%" or Process.CommandLine like r"%credentials%" or Process.CommandLine like r"%pass%" or Process.CommandLine like r"%password%" or Process.CommandLine like r"%unlock%")


[ActivityMonitoringRule platform=MacOS]
# Detects usage of base64 utility to decode arbitrary base64-encoded text
# Author: Daniil Yugoslavskiy, oscd.community
RuleId = 719c22d7-c11a-4f2c-93a6-2cfdd5412f68
RuleName = Decode Base64 Encoded Text -MacOs
EventType = Process.Start
Tag = proc-start-decode-base64-encoded-text-macos
RiskScore = 25
Annotation = {"mitre_attack": ["T1027"]}
Query = Process.Path == "/usr/bin/base64" and Process.CommandLine like r"%-d%"


[ActivityMonitoringRule platform=MacOS]
# Detects execution of the "jamf" binary to create user accounts and run commands. For example, the binary can be abused by attackers on the system in order to bypass security controls or remove application control polices.
# Author: Jay Pandit
RuleId = be2e3a5c-9cc7-4d02-842a-68e9cb26ec49
RuleName = JAMF MDM Execution
EventType = Process.Start
Tag = proc-start-jamf-mdm-execution
RiskScore = 25
Query = Process.Path like r"%/jamf" and (Process.CommandLine like r"%createAccount%" or Process.CommandLine like r"%manage%" or Process.CommandLine like r"%removeFramework%" or Process.CommandLine like r"%removeMdmProfile%" or Process.CommandLine like r"%resetPassword%" or Process.CommandLine like r"%setComputerName%")


[ActivityMonitoringRule platform=MacOS]
# Detection use of the command "split" to split files into parts and possible transfer.
# Author: Igor Fits, Mikhail Larin, oscd.community
RuleId = 7f2bb9d5-6395-4de5-969c-70c11fbe6b12
RuleName = Split A File Into Pieces
EventType = Process.Start
Tag = proc-start-split-a-file-into-pieces
RiskScore = 25
Annotation = {"mitre_attack": ["T1030"]}
Query = Process.Path like r"%/split"


[ActivityMonitoringRule platform=MacOS]
# Detects the creation of a startup item plist file, that automatically get executed at boot initialization to establish persistence.
# Adversaries may use startup items automatically executed at boot initialization to establish persistence.
# Startup items execute during the final phase of the boot process and contain shell scripts or other executable files along with configuration information used by the system to determine the execution order for all startup items.
# Author: Alejandro Ortuno, oscd.community
RuleId = dfe8b941-4e54-4242-b674-6b613d521962
RuleName = Startup Item File Created - MacOS
EventType = File.Create
Tag = startup-item-file-created-macos
RiskScore = 25
Annotation = {"mitre_attack": ["T1037.005"]}
Query = (File.Path like r"/Library/StartupItems/%" or File.Path like r"/System/Library/StartupItems%") and File.Path like r"%.plist"
GenericProperty1 = File.Path


[ActivityMonitoringRule platform=MacOS]
# Detects enumeration of local systeam accounts on MacOS
# Author: Alejandro Ortuno, oscd.community
RuleId = ddf36b67-e872-4507-ab2e-46bda21b842c
RuleName = Local System Accounts Discovery - MacOs
EventType = Process.Start
Tag = proc-start-local-system-accounts-discovery-macos
RiskScore = 25
Annotation = {"mitre_attack": ["T1087.001"]}
Query = Process.Path like r"%/dscl" and Process.CommandLine like r"%list%" and Process.CommandLine like r"%/users%" or Process.Path like r"%/dscacheutil" and Process.CommandLine like r"%-q%" and Process.CommandLine like r"%user%" or Process.CommandLine like r"%'x:0:'%" or Process.Path like r"%/cat" and (Process.CommandLine like r"%/etc/passwd%" or Process.CommandLine like r"%/etc/sudoers%") or Process.Path like r"%/id" or Process.Path like r"%/lsof" and Process.CommandLine like r"%-u%"


[ActivityMonitoringRule platform=MacOS]
# Detects macOS Gatekeeper bypass via xattr utility
# Author: Daniil Yugoslavskiy, oscd.community
RuleId = f5141b6d-9f42-41c6-a7bf-2a780678b29b
RuleName = Gatekeeper Bypass via Xattr
EventType = Process.Start
Tag = proc-start-gatekeeper-bypass-via-xattr
RiskScore = 25
Annotation = {"mitre_attack": ["T1553.001"]}
Query = Process.Path like r"%/xattr" and Process.CommandLine like r"%-d%" and Process.CommandLine like r"%com.apple.quarantine%"


[ActivityMonitoringRule platform=MacOS]
# Detects the use of csrutil to view the Configure System Integrity Protection (SIP) status. This technique is used in post-exploit scenarios.
# Author: Joseliyo Sanchez, @Joseliyo_Jstnk
RuleId = 53821412-17b0-4147-ade0-14faae67d54b
RuleName = System Integrity Protection (SIP) Enumeration
EventType = Process.Start
Tag = proc-start-system-integrity-protection-(sip)-enumeration
RiskScore = 25
Annotation = {"mitre_attack": ["T1518.001"]}
Query = Process.Path like r"%/csrutil" and Process.CommandLine like r"%status%"


[ActivityMonitoringRule platform=MacOS]
# Detects attempts to enable the guest account using the sysadminctl utility
# Author: Sohan G (D4rkCiph3r)
RuleId = d7329412-13bd-44ba-a072-3387f804a106
RuleName = Guest Account Enabled Via Sysadminctl
EventType = Process.Start
Tag = proc-start-guest-account-enabled-via-sysadminctl
RiskScore = 25
Annotation = {"mitre_attack": ["T1078", "T1078.001"]}
Query = Process.Path like r"%/sysadminctl" and Process.CommandLine like r"% -guestAccount%" and Process.CommandLine like r"% on%"


[ActivityMonitoringRule platform=MacOS]
# Detects enumeration of local or remote network services.
# Author: Alejandro Ortuno, oscd.community
RuleId = 84bae5d4-b518-4ae0-b331-6d4afd34d00f
RuleName = MacOS Network Service Scanning
EventType = Process.Start
Tag = proc-start-macos-network-service-scanning
RiskScore = 25
Annotation = {"mitre_attack": ["T1046"]}
Query = (Process.Path like r"%/nc" or Process.Path like r"%/netcat") and not Process.CommandLine like r"%l%" or Process.Path like r"%/nmap" or Process.Path like r"%/telnet"


[ActivityMonitoringRule platform=MacOS]
# Detects the command line executed when TeamViewer starts a session started by a remote host.
# Once a connection has been started, an investigator can verify the connection details by viewing the "incoming_connections.txt" log file in the TeamViewer folder.
# Author: Josh Nickels, Qi Nan
RuleId = f459ccb4-9805-41ea-b5b2-55e279e2424a
RuleName = Remote Access Tool - Team Viewer Session Started On MacOS Host
EventType = Process.Start
Tag = proc-start-remote-access-tool-team-viewer-session-started-on-macos-host
RiskScore = 25
Annotation = {"mitre_attack": ["T1133"]}
Query = Parent.Path like r"%/TeamViewer\_Service" and Process.Path like r"%/TeamViewer\_Desktop" and Process.CommandLine like r"%/TeamViewer\_Desktop --IPCport 5939 --Module 1"
GenericProperty1 = Parent.Path


[ActivityMonitoringRule platform=MacOS]
# Detects attempts to masquerade as legitimate files by adding a space to the end of the filename.
# Author: remotephone
RuleId = b6e2a2e3-2d30-43b1-a4ea-071e36595690
RuleName = Space After Filename - macOS
EventType = Process.Start
Tag = proc-start-space-after-filename-macos
RiskScore = 25
Annotation = {"mitre_attack": ["T1036.006"]}
Query = Process.CommandLine like r"% " or Process.Path like r"% "


[ActivityMonitoringRule platform=MacOS]
# Detects the creation of a new user account. Such accounts may be used for persistence that do not require persistent remote access tools to be deployed on the system.
# Author: Alejandro Ortuno, oscd.community
RuleId = 51719bf5-e4fd-4e44-8ba8-b830e7ac0731
RuleName = Creation Of A Local User Account
EventType = Process.Start
Tag = proc-start-creation-of-a-local-user-account
RiskScore = 25
Annotation = {"mitre_attack": ["T1136.001"]}
Query = Process.Path like r"%/dscl" and Process.CommandLine like r"%create%" or Process.Path like r"%/sysadminctl" and Process.CommandLine like r"%addUser%"


[ActivityMonitoringRule platform=MacOS]
# Detects attempts to use screencapture to collect macOS screenshots
# Author: remotephone, oscd.community
RuleId = 0877ed01-da46-4c49-8476-d49cdd80dfa7
RuleName = Screen Capture - macOS
EventType = Process.Start
Tag = proc-start-screen-capture-macos
RiskScore = 25
Annotation = {"mitre_attack": ["T1113"]}
Query = Process.Path == "/usr/sbin/screencapture"

