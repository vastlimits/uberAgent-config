#
# The rules are generated from the Sigma GitHub repository at https://github.com/SigmaHQ/sigma
# Follow these steps to get the latest rules from the repository with Python
#    1. Clone the repository locally
#    2. Using a commandline, change working directory to the just cloned repository
#    3. Run sigmac -I --target uberagent -r rules/
#
# The rules in this file are marked with sigma-level: critical
#

[ActivityMonitoringRule platform=Windows]
# Detects static QMS 810 and mimikatz driver name used by Mimikatz as exploited in CVE-2021-1675 and CVE-2021-34527
# Author: Markus Neis, @markus_neis, Florian Roth
RuleId = ba6b9e43-1d45-4d3c-a504-1043a64c8469
RuleName = PrinterNightmare Mimimkatz Driver Name
EventType = Reg.Any
Tag = printernightmare-mimimkatz-driver-name
RiskScore = 100
Annotation = {"mitre_attack": ["T1204"]}
Query = (((Reg.Key.Target like r"%\\Control\\Print\\Environments\\Windows x64\\Drivers\\Version-3\\QMS 810\\%" or Reg.Key.Target like r"%\\Control\\Print\\Environments\\Windows x64\\Drivers\\Version-3\\mimikatz%") or (Reg.Key.Target like r"%legitprinter%" and Reg.Key.Target like r"%\\Control\\Print\\Environments\\Windows%")) or ((Reg.Key.Target like r"%\\Control\\Print\\Environments%" or Reg.Key.Target like r"%\\CurrentVersion\\Print\\Printers%") and (Reg.Key.Target like r"%Gentil Kiwi%" or Reg.Key.Target like r"%mimikatz printer%" or Reg.Key.Target like r"%Kiwi Legit Printer%")))
Hive = HKLM,HKU
GenericProperty1 = Reg.Key.Target

[ActivityMonitoringRule platform=Windows]
# Detects the usage and installation of a backdoor that uses an option to register a malicious debugger for built-in tools that are accessible in the login screen
# Author: Florian Roth (Nextron Systems), @twjackomo, Jonhnathan Ribeiro, oscd.community
RuleId = baca5663-583c-45f9-b5dc-ea96a22ce542
RuleName = Sticky Key Like Backdoor Usage - Registry
EventType = Reg.Any
Tag = sticky-key-like-backdoor-usage-registry
RiskScore = 100
Annotation = {"mitre_attack": ["T1546.008"]}
Query = (Reg.Key.Target like r"%\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\sethc.exe\\Debugger" or Reg.Key.Target like r"%\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\utilman.exe\\Debugger" or Reg.Key.Target like r"%\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\osk.exe\\Debugger" or Reg.Key.Target like r"%\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\Magnify.exe\\Debugger" or Reg.Key.Target like r"%\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\Narrator.exe\\Debugger" or Reg.Key.Target like r"%\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\DisplaySwitch.exe\\Debugger" or Reg.Key.Target like r"%\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\atbroker.exe\\Debugger" or Reg.Key.Target like r"%\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\HelpPane.exe\\Debugger")
Hive = HKLM,HKU
GenericProperty1 = Reg.Key.Target

[ActivityMonitoringRule platform=Windows]
# Detects registry keys created in OceanLotus (also known as APT32) attacks
# Author: megan201296, Jonhnathan Ribeiro
RuleId = 4ac5fc44-a601-4c06-955b-309df8c4e9d4
RuleName = OceanLotus Registry Activity
EventType = Reg.Any
Tag = oceanlotus-registry-activity
RiskScore = 100
Annotation = {"mitre_attack": ["T1112"]}
Query = (Reg.Key.Target like r"HKCU\\SOFTWARE\\Classes\\CLSID\\{E08A0F4B-1F65-4D4D-9A09-BD4625B9C5A1}\\Model" or ((Reg.Key.Target like r"HKCU\\SOFTWARE\\App\\%" or Reg.Key.Target like r"HKLM\\SOFTWARE\\App\\%") and (Reg.Key.Target like r"%AppXbf13d4ea2945444d8b13e2121cb6b663\\%" or Reg.Key.Target like r"%AppX70162486c7554f7f80f481985d67586d\\%" or Reg.Key.Target like r"%AppX37cc7fdccd644b4f85f4b22d5a3f105a\\%") and (Reg.Key.Target like r"%Application" or Reg.Key.Target like r"%DefaultIcon")) or (Reg.Key.Target like r"HKCU\\%" and (Reg.Key.Target like r"%Classes\\AppXc52346ec40fb4061ad96be0e6cb7d16a\\%" or Reg.Key.Target like r"%Classes\\AppX3bbba44c6cae4d9695755183472171e2\\%" or Reg.Key.Target like r"%Classes\\CLSID\\{E3517E26-8E93-458D-A6DF-8030BC80528B}\\%" or Reg.Key.Target like r"%Classes\\CLSID\\{E08A0F4B-1F65-4D4D-9A09-BD4625B9C5A1}\\Model%")))
Hive = HKLM,HKU
GenericProperty1 = Reg.Key.Target

[ActivityMonitoringRule platform=Windows]
# Detects FlowCloud malware from threat group TA410.
# Author: NVISO
RuleId = 5118765f-6657-4ddb-a487-d7bd673abbf1
RuleName = FlowCloud Malware
EventType = Reg.Any
Tag = flowcloud-malware
RiskScore = 100
Annotation = {"mitre_attack": ["T1112"]}
Query = ((Reg.Key.Target like r"HKLM\\HARDWARE\\{804423C2-F490-4ac3-BFA5-13DEDE63A71A}" or Reg.Key.Target like r"HKLM\\HARDWARE\\{A5124AF5-DF23-49bf-B0ED-A18ED3DEA027}" or Reg.Key.Target like r"HKLM\\HARDWARE\\{2DB80286-1784-48b5-A751-B6ED1F490303}") or Reg.Key.Target like r"HKLM\\SYSTEM\\Setup\\PrintResponsor\\%")
Hive = HKLM,HKU
GenericProperty1 = Reg.Key.Target

[ActivityMonitoringRule platform=Windows]
# Detects registry key used by Leviathan APT in Malaysian focused campaign
# Author: Aidan Bracher
RuleId = 70d43542-cd2d-483c-8f30-f16b436fd7db
RuleName = Leviathan Registry Key Activity
EventType = Reg.Any
Tag = leviathan-registry-key-activity
RiskScore = 100
Annotation = {"mitre_attack": ["T1547.001"]}
Query = Reg.Key.Target like r"HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\ntkd"
Hive = HKLM,HKU
GenericProperty1 = Reg.Key.Target

[ActivityMonitoringRule platform=Windows]
# Detects the addition of a SSP to the registry. Upon a reboot or API call, SSP DLLs gain access to encrypted and plaintext passwords stored in Windows.
# Author: iwillkeepwatch
RuleId = eeb30123-9fbd-4ee8-aaa0-2e545bbed6dc
RuleName = Security Support Provider (SSP) Added to LSA Configuration
EventType = Reg.Any
Tag = security-support-provider-(ssp)-added-to-lsa-configuration
RiskScore = 100
Annotation = {"mitre_attack": ["T1547.005"]}
Query = ((Reg.Key.Target like r"HKLM\\System\\CurrentControlSet\\Control\\Lsa\\Security Packages" or Reg.Key.Target like r"HKLM\\System\\CurrentControlSet\\Control\\Lsa\\OSConfig\\Security Packages") and not ((Process.Path like r"C:\\Windows\\system32\\msiexec.exe" or Process.Path like r"C:\\Windows\\syswow64\\MsiExec.exe")))
Hive = HKLM,HKU
GenericProperty1 = Reg.Key.Target

[ActivityMonitoringRule platform=Windows]
# Detects the use of Windows Credential Editor (WCE)
# Author: Florian Roth (Nextron Systems)
RuleId = a6b33c02-8305-488f-8585-03cb2a7763f2
RuleName = Windows Credential Editor Registry
EventType = Reg.Any
Tag = windows-credential-editor-registry
RiskScore = 100
Annotation = {"mitre_attack": ["T1003.001"]}
Query = Reg.Key.Target like r"%Services\\WCESERVICE\\Start%"
Hive = HKLM,HKU
GenericProperty1 = Reg.Key.Target

[ActivityMonitoringRule platform=Windows]
# Detects Pandemic Windows Implant
# Author: Florian Roth (Nextron Systems)
RuleId = 47e0852a-cf81-4494-a8e6-31864f8c86ed
RuleName = Pandemic Registry Key
EventType = Reg.Any
Tag = pandemic-registry-key
RiskScore = 100
Annotation = {"mitre_attack": ["T1105"]}
Query = Reg.Key.Target like r"%\\SYSTEM\\CurrentControlSet\\services\\null\\Instance%"
Hive = HKLM,HKU
GenericProperty1 = Reg.Key.Target

[ActivityMonitoringRule platform=Windows]
# Detects OilRig registry persistence as reported by Nyotron in their March 2018 report
# Author: Florian Roth (Nextron Systems), Markus Neis, Jonhnathan Ribeiro, Daniil Yugoslavskiy, oscd.community
RuleId = 7bdf2a7c-3acc-4091-9581-0a77dad1c5b5
RuleName = OilRig APT Registry Persistence
EventType = Reg.Any
Tag = oilrig-apt-registry-persistence
RiskScore = 100
Annotation = {"mitre_attack": ["T1053.005", "T1543.003", "T1112", "T1071.004"]}
Query = (Reg.Key.Target like r"%SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\UMe" or Reg.Key.Target like r"%SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\UT")
Hive = HKLM,HKU
GenericProperty1 = Reg.Key.Target

[ActivityMonitoringRule platform=Windows]
# Detects changes to the Registry in which a monitor program gets registered to dump the memory of the lsass.exe process
# Author: Florian Roth (Nextron Systems)
RuleId = 55e29995-75e7-451a-bef0-6225e2f13597
RuleName = Potential Credential Dumping Via LSASS SilentProcessExit Technique
EventType = Reg.Any
Tag = potential-credential-dumping-via-lsass-silentprocessexit-technique
RiskScore = 100
Annotation = {"mitre_attack": ["T1003.001"]}
Query = Reg.Key.Target like r"%Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit\\lsass.exe%"
Hive = HKLM,HKU
GenericProperty1 = Reg.Key.Target

[ActivityMonitoringRule platform=Windows]
# Detects potential DLL hijack of "iertutil.dll" found in the DCOM InternetExplorer.Application Class
# Author: Roberto Rodriguez @Cyb3rWard0g, Open Threat Research (OTR), wagga
RuleId = f354eba5-623b-450f-b073-0b5b2773b6aa
RuleName = Potential DCOM InternetExplorer.Application DLL Hijack - Image Load
EventType = Image.Load
Tag = potential-dcom-internetexplorer.application-dll-hijack-image-load
RiskScore = 100
Annotation = {"mitre_attack": ["T1021.002", "T1021.003"]}
Query = (Process.Path like r"%\\Internet Explorer\\iexplore.exe" and Image.Path like r"%\\Internet Explorer\\iertutil.dll")
GenericProperty1 = Image.Path

[ActivityMonitoringRule platform=Windows]
# Detects DLL hijacking technique used by NOBELIUM in their FoggyWeb backdoor. Which loads a malicious version of the expected "version.dll" dll
# Author: Florian Roth (Nextron Systems)
RuleId = 640dc51c-7713-4faa-8a0e-e7c0d9d4654c
RuleName = FoggyWeb Backdoor DLL Loading
EventType = Image.Load
Tag = foggyweb-backdoor-dll-loading
RiskScore = 100
Annotation = {"mitre_attack": ["T1587"]}
Query = Image.Path like r"C:\\Windows\\ADFS\\version.dll"
GenericProperty1 = Image.Path

[ActivityMonitoringRule platform=Windows]
# Detects the use of the Dinject PowerShell cradle based on the specific flags
# Author: Florian Roth (Nextron Systems)
RuleId = d78b5d61-187d-44b6-bf02-93486a80de5a
RuleName = HackTool - DInjector PowerShell Cradle Execution
EventType = Process.Start
Tag = proc-start-hacktool-dinjector-powershell-cradle-execution
RiskScore = 100
Annotation = {"mitre_attack": ["T1055"]}
Query = (Process.CommandLine like r"% /am51%" and Process.CommandLine like r"% /password%")

[ActivityMonitoringRule platform=Windows]
# Detects process activity patterns as seen being used by Sliver C2 framework implants
# Author: Nasreddine Bencherchali (Nextron Systems), Florian Roth (Nextron Systems)
RuleId = 42333b2c-b425-441c-b70e-99404a17170f
RuleName = HackTool - Sliver C2 Implant Activity Pattern
EventType = Process.Start
Tag = proc-start-hacktool-sliver-c2-implant-activity-pattern
RiskScore = 100
Annotation = {"mitre_attack": ["T1059"]}
Query = Process.CommandLine like r"%-NoExit -Command [Console]::OutputEncoding=[Text.UTF8Encoding]::UTF8%"

[ActivityMonitoringRule platform=Windows]
# Detects different hacktools used for relay attacks on Windows for privilege escalation
# Author: Florian Roth (Nextron Systems)
RuleId = 5589ab4f-a767-433c-961d-c91f3f704db1
RuleName = Potential SMB Relay Attack Tool Execution
EventType = Process.Start
Tag = proc-start-potential-smb-relay-attack-tool-execution
RiskScore = 100
Annotation = {"mitre_attack": ["T1557.001"]}
Query = (((Process.Path like r"%PetitPotam%" or Process.Path like r"%RottenPotato%" or Process.Path like r"%HotPotato%" or Process.Path like r"%JuicyPotato%" or Process.Path like r"%\\just\_dce\_%" or Process.Path like r"%Juicy Potato%" or Process.Path like r"%\\temp\\rot.exe%" or Process.Path like r"%\\Potato.exe%" or Process.Path like r"%\\SpoolSample.exe%" or Process.Path like r"%\\Responder.exe%" or Process.Path like r"%\\smbrelayx%" or Process.Path like r"%\\ntlmrelayx%" or Process.Path like r"%\\LocalPotato%") or (Process.CommandLine like r"%Invoke-Tater%" or Process.CommandLine like r"% smbrelay%" or Process.CommandLine like r"% ntlmrelay%" or Process.CommandLine like r"%cme smb %" or Process.CommandLine like r"% /ntlm:NTLMhash %" or Process.CommandLine like r"%Invoke-PetitPotam%" or Process.CommandLine like r"%.exe -t % -p %") or (Process.CommandLine like r"%.exe -c \"{%" and Process.CommandLine like r"%}\" -z")) and not (((Process.Path like r"%HotPotatoes6%" or Process.Path like r"%HotPotatoes7%" or Process.Path like r"%HotPotatoes %"))))

[ActivityMonitoringRule platform=Windows]
# Detects suspicious child processes of the Veeam service process. This could indicate potential RCE or SQL Injection.
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = d55b793d-f847-4eea-b59a-5ab09908ac90
RuleName = Suspicious Child Process Of Veeam Dabatase
EventType = Process.Start
Tag = proc-start-suspicious-child-process-of-veeam-dabatase
RiskScore = 100
Query = ((Parent.Path like r"%\\sqlservr.exe" and Parent.CommandLine like r"%VEEAMSQL%") and (((Process.Path like r"%\\cmd.exe" or Process.Path like r"%\\powershell.exe" or Process.Path like r"%\\pwsh.exe" or Process.Path like r"%\\wsl.exe" or Process.Path like r"%\\wt.exe") and (Process.CommandLine like r"%-ex %" or Process.CommandLine like r"%bypass%" or Process.CommandLine like r"%cscript%" or Process.CommandLine like r"%DownloadString%" or Process.CommandLine like r"%http://%" or Process.CommandLine like r"%https://%" or Process.CommandLine like r"%mshta%" or Process.CommandLine like r"%regsvr32%" or Process.CommandLine like r"%rundll32%" or Process.CommandLine like r"%wscript%" or Process.CommandLine like r"%copy %")) or (Process.Path like r"%\\net.exe" or Process.Path like r"%\\net1.exe" or Process.Path like r"%\\netstat.exe" or Process.Path like r"%\\nltest.exe" or Process.Path like r"%\\ping.exe" or Process.Path like r"%\\tasklist.exe" or Process.Path like r"%\\whoami.exe")))
GenericProperty1 = Parent.Path
GenericProperty2 = Parent.CommandLine

[ActivityMonitoringRule platform=Windows]
# Detects the use of Dumpert process dumper, which dumps the lsass.exe process memory
# Author: Florian Roth (Nextron Systems)
RuleId = 2704ab9e-afe2-4854-a3b1-0c0706d03578
RuleName = HackTool - Dumpert Process Dumper Execution
EventType = Process.Start
Tag = proc-start-hacktool-dumpert-process-dumper-execution
RiskScore = 100
Annotation = {"mitre_attack": ["T1003.001"]}
Query = (Process.Hashes like r"%09D278F9DE118EF09163C6140255C690%" or Process.CommandLine like r"%Dumpert.dll%")
GenericProperty1 = Process.Hashes

[ActivityMonitoringRule platform=Windows]
# Detects usage of the powerShell New-MailboxExportRequest Cmdlet to exports a mailbox to a remote or local share, as used in ProxyShell exploitations
# Author: Florian Roth (Nextron Systems)
RuleId = 889719ef-dd62-43df-86c3-768fb08dc7c0
RuleName = Suspicious PowerShell Mailbox Export to Share
EventType = Process.Start
Tag = proc-start-suspicious-powershell-mailbox-export-to-share
RiskScore = 100
Query = (Process.CommandLine like r"%New-MailboxExportRequest%" and Process.CommandLine like r"% -Mailbox %" and Process.CommandLine like r"% -FilePath \\\\\*")

[ActivityMonitoringRule platform=Windows]
# Detects suspicious use of an .exe extension after a non-executable file extension like .pdf.exe, a set of spaces or underlines to cloak the executable file in spear phishing campaigns
# Author: Florian Roth (Nextron Systems), @blu3_team (idea), Nasreddine Bencherchali (Nextron Systems)
RuleId = 1cdd9a09-06c9-4769-99ff-626e2b3991b8
RuleName = Suspicious Double Extension File Execution
EventType = Process.Start
Tag = proc-start-suspicious-double-extension-file-execution
RiskScore = 100
Annotation = {"mitre_attack": ["T1566.001"]}
Query = ((Process.Path like r"%.doc.exe" or Process.Path like r"%.docx.exe" or Process.Path like r"%.xls.exe" or Process.Path like r"%.xlsx.exe" or Process.Path like r"%.ppt.exe" or Process.Path like r"%.pptx.exe" or Process.Path like r"%.rtf.exe" or Process.Path like r"%.pdf.exe" or Process.Path like r"%.txt.exe" or Process.Path like r"%      .exe" or Process.Path like r"%\_\_\_\_\_\_.exe" or Process.Path like r"%.doc.js" or Process.Path like r"%.docx.js" or Process.Path like r"%.xls.js" or Process.Path like r"%.xlsx.js" or Process.Path like r"%.ppt.js" or Process.Path like r"%.pptx.js" or Process.Path like r"%.rtf.js" or Process.Path like r"%.pdf.js" or Process.Path like r"%.txt.js") and (Process.CommandLine like r"%.doc.exe%" or Process.CommandLine like r"%.docx.exe%" or Process.CommandLine like r"%.xls.exe%" or Process.CommandLine like r"%.xlsx.exe%" or Process.CommandLine like r"%.ppt.exe%" or Process.CommandLine like r"%.pptx.exe%" or Process.CommandLine like r"%.rtf.exe%" or Process.CommandLine like r"%.pdf.exe%" or Process.CommandLine like r"%.txt.exe%" or Process.CommandLine like r"%      .exe%" or Process.CommandLine like r"%\_\_\_\_\_\_.exe%" or Process.CommandLine like r"%.doc.js%" or Process.CommandLine like r"%.docx.js%" or Process.CommandLine like r"%.xls.js%" or Process.CommandLine like r"%.xlsx.js%" or Process.CommandLine like r"%.ppt.js%" or Process.CommandLine like r"%.pptx.js%" or Process.CommandLine like r"%.rtf.js%" or Process.CommandLine like r"%.pdf.js%" or Process.CommandLine like r"%.txt.js%"))

[ActivityMonitoringRule platform=Windows]
# Detects indicators of a UAC bypass method by mocking directories
# Author: Florian Roth (Nextron Systems)
RuleId = 4ac47ed3-44c2-4b1f-9d51-bf46e8914126
RuleName = TrustedPath UAC Bypass Pattern
EventType = Process.Start
Tag = proc-start-trustedpath-uac-bypass-pattern
RiskScore = 100
Annotation = {"mitre_attack": ["T1548.002"]}
Query = Process.Path like r"%C:\\Windows \\System32\\%"

[ActivityMonitoringRule platform=Windows]
# Detects a suspicious LSASS process process clone that could be a sign of credential dumping activity
# Author: Florian Roth (Nextron Systems), Samir Bousseaden
RuleId = c8da0dfd-4ed0-4b68-962d-13c9c884384e
RuleName = Potential Credential Dumping Via LSASS Process Clone
EventType = Process.Start
Tag = proc-start-potential-credential-dumping-via-lsass-process-clone
RiskScore = 100
Annotation = {"mitre_attack": ["T1003", "T1003.001"]}
Query = (Process.Path like r"%\\Windows\\System32\\lsass.exe" and Parent.Path like r"%\\Windows\\System32\\lsass.exe")
GenericProperty1 = Parent.Path

[ActivityMonitoringRule platform=Windows]
# Detects the use of the filename DumpStack.log to evade Microsoft Defender
# Author: Florian Roth (Nextron Systems)
RuleId = 4f647cfa-b598-4e12-ad69-c68dd16caef8
RuleName = DumpStack.log Defender Evasion
EventType = Process.Start
Tag = proc-start-dumpstack.log-defender-evasion
RiskScore = 100
Query = (Process.Path like r"%\\DumpStack.log" or Process.CommandLine like r"% -o DumpStack.log%")

[ActivityMonitoringRule platform=Windows]
# Detects the execution of the PoC that can be used to exploit Sysmon CVE-2022-41120
# Author: Florian Roth (Nextron Systems)
RuleId = 8a7e90c5-fe6e-45dc-889e-057fe4378bd9
RuleName = HackTool - SysmonEOP Execution
EventType = Process.Start
Tag = proc-start-hacktool-sysmoneop-execution
RiskScore = 100
Annotation = {"mitre_attack": ["T1068"]}
Query = (Process.Path like r"%\\SysmonEOP.exe" or Process.Hashes in ["IMPHASH=22F4089EB8ABA31E1BB162C6D9BF72E5", "IMPHASH=5123FA4C4384D431CD0D893EEB49BBEC"] or Process.Hash.IMP in ["22f4089eb8aba31e1bb162c6d9bf72e5", "5123fa4c4384d431cd0d893eeb49bbec"])
GenericProperty1 = Process.Hashes
GenericProperty2 = Process.Hash.IMP

[ActivityMonitoringRule platform=Windows]
# Detects the usage and installation of a backdoor that uses an option to register a malicious debugger for built-in tools that are accessible in the login screen
# Author: Florian Roth (Nextron Systems), @twjackomo, Jonhnathan Ribeiro, oscd.community
RuleId = 2fdefcb3-dbda-401e-ae23-f0db027628bc
RuleName = Sticky Key Like Backdoor Execution
EventType = Process.Start
Tag = proc-start-sticky-key-like-backdoor-execution
RiskScore = 100
Annotation = {"mitre_attack": ["T1546.008"]}
Query = (Parent.Path like r"%\\winlogon.exe" and (Process.Path like r"%\\cmd.exe" or Process.Path like r"%\\cscript.exe" or Process.Path like r"%\\mshta.exe" or Process.Path like r"%\\powershell.exe" or Process.Path like r"%\\pwsh.exe" or Process.Path like r"%\\regsvr32.exe" or Process.Path like r"%\\rundll32.exe" or Process.Path like r"%\\wscript.exe" or Process.Path like r"%\\wt.exe") and (Process.CommandLine like r"%sethc.exe%" or Process.CommandLine like r"%utilman.exe%" or Process.CommandLine like r"%osk.exe%" or Process.CommandLine like r"%Magnify.exe%" or Process.CommandLine like r"%Narrator.exe%" or Process.CommandLine like r"%DisplaySwitch.exe%"))
GenericProperty1 = Parent.Path

[ActivityMonitoringRule platform=Windows]
# By replacing the sticky keys executable with the local admins CMD executable, an attacker is able to access a privileged windows console session without authenticating to the system.
# When the sticky keys are "activated" the privilleged shell is launched.
# Author: Sreeman
RuleId = 1070db9a-3e5d-412e-8e7b-7183b616e1b3
RuleName = Persistence Via Sticky Key Backdoor
EventType = Process.Start
Tag = proc-start-persistence-via-sticky-key-backdoor
RiskScore = 100
Annotation = {"mitre_attack": ["T1546.008"]}
Query = (Process.CommandLine like r"%copy %" and Process.CommandLine like r"%/y %" and Process.CommandLine like r"%C:\\windows\\system32\\cmd.exe C:\\windows\\system32\\sethc.exe%")

[ActivityMonitoringRule platform=Windows]
# Detects a WMI backdoor in Exchange Transport Agents via WMI event filters
# Author: Florian Roth (Nextron Systems)
RuleId = 797011dc-44f4-4e6f-9f10-a8ceefbe566b
RuleName = WMI Backdoor Exchange Transport Agent
EventType = Process.Start
Tag = proc-start-wmi-backdoor-exchange-transport-agent
RiskScore = 100
Annotation = {"mitre_attack": ["T1546.003"]}
Query = (Parent.Path like r"%\\EdgeTransport.exe" and not ((Process.Path like r"C:\\Windows\\System32\\conhost.exe") or (Process.Path like r"C:\\Program Files\\Microsoft\\Exchange Server\\%" and Process.Path like r"%\\Bin\\OleConverter.exe")))
GenericProperty1 = Parent.Path

[ActivityMonitoringRule platform=Windows]
# Detects the execution of different Windows based hacktools via their import hash (imphash) even if the files have been renamed
# Author: Florian Roth (Nextron Systems)
RuleId = 24e3e58a-646b-4b50-adef-02ef935b9fc8
RuleName = Suspicious Hacktool Execution - Imphash
EventType = Process.Start
Tag = proc-start-suspicious-hacktool-execution-imphash
RiskScore = 100
Query = (Process.Hash.IMP in ["bcca3c247b619dcd13c8cdff5f123932", "3a19059bd7688cb88e70005f18efc439", "bf6223a49e45d99094406777eb6004ba", "0c106686a31bfe2ba931ae1cf6e9dbc6", "0d1447d4b3259b3c2a1d4cfb7ece13c3", "1b0369a1e06271833f78ffa70ffb4eaf", "4c1b52a19748428e51b14c278d0f58e3", "4d927a711f77d62cebd4f322cb57ec6f", "66ee036df5fc1004d9ed5e9a94a1086a", "672b13f4a0b6f27d29065123fe882dfc", "6bbd59cea665c4afcc2814c1327ec91f", "725bb81dc24214f6ecacc0cfb36ad30d", "9528a0e91e28fbb88ad433feabca2456", "9da6d5d77be11712527dcab86df449a3", "a6e01bc1ab89f8d91d9eab72032aae88", "b24c5eddaea4fe50c6a96a2a133521e4", "d21bbc50dcc169d7b4d0f01962793154", "fcc251cceae90d22c392215cc9a2d5d6", "23867a89c2b8fc733be6cf5ef902f2d1", "a37ff327f8d48e8a4d2f757e1b6e70bc", "f9a28c458284584a93b14216308d31bd", "6118619783fc175bc7ebecff0769b46e", "959a83047e80ab68b368fdb3f4c6e4ea", "563233bfa169acc7892451f71ad5850a", "87575cb7a0e0700eb37f2e3668671a08", "13f08707f759af6003837a150a371ba1", "1781f06048a7e58b323f0b9259be798b", "233f85f2d4bc9d6521a6caae11a1e7f5", "24af2584cbf4d60bbe5c6d1b31b3be6d", "632969ddf6dbf4e0f53424b75e4b91f2", "713c29b396b907ed71a72482759ed757", "749a7bb1f0b4c4455949c0b2bf7f9e9f", "8628b2608957a6b0c6330ac3de28ce2e", "8b114550386e31895dfab371e741123d", "94cb940a1a6b65bed4d5a8f849ce9793", "9d68781980370e00e0bd939ee5e6c141", "b18a1401ff8f444056d29450fbc0a6ce", "cb567f9498452721d77a451374955f5f", "730073214094cd328547bf1f72289752", "17b461a082950fc6332228572138b80c", "dc25ee78e2ef4d36faa0badf1e7461c9", "819b19d53ca6736448f9325a85736792", "829da329ce140d873b4a8bde2cbfaa7e", "c547f2e66061a8dffb6f5a3ff63c0a74", "0588081ab0e63ba785938467e1b10cca", "0d9ec08bac6c07d9987dfd0f1506587c", "bc129092b71c89b4d4c8cdf8ea590b29", "4da924cf622d039d58bce71cdf05d242", "e7a3a5c377e2d29324093377d7db1c66", "9a9dbec5c62f0380b4fa5fd31deffedf", "af8a3976ad71e5d5fdfb67ddb8dadfce", "0c477898bbf137bbd6f2a54e3b805ff4", "0ca9f02b537bcea20d4ea5eb1a9fe338", "3ab3655e5a14d4eefc547f4781bf7f9e", "e6f9d5152da699934b30daab206471f6", "3ad59991ccf1d67339b319b15a41b35d", "ffdd59e0318b85a3e480874d9796d872", "0cf479628d7cc1ea25ec7998a92f5051", "07a2d4dcbd6cb2c6a45e6b101f0b6d51", "d6d0f80386e1380d05cb78e871bc72b1", "38d9e015591bbfd4929e0d0f47fa0055", "0e2216679ca6e1094d63322e3412d650", "ada161bf41b8e5e9132858cb54cab5fb", "2a1bc4913cd5ecb0434df07cb675b798", "11083e75553baae21dc89ce8f9a195e4", "a23d29c9e566f2fa8ffbb79267f5df80", "4a07f944a83e8a7c2525efa35dd30e2f", "767637c23bb42cd5d7397cf58b0be688", "14c4e4c72ba075e9069ee67f39188ad8", "3c782813d4afce07bbfc5a9772acdbdc", "7d010c6bb6a3726f327f7e239166d127", "89159ba4dd04e4ce5559f132a9964eb3", "6f33f4a5fc42b8cec7314947bd13f30f", "5834ed4291bdeb928270428ebbaf7604", "5a8a8a43f25485e7ee1b201edcbc7a38", "dc7d30b90b2d8abf664fbed2b1b59894", "41923ea1f824fe63ea5beb84db7a3e74", "3de09703c8e79ed2ca3f01074719906b", "a53a02b997935fd8eedcb5f7abab9b9f", "e96a73c7bf33a464c510ede582318bf2", "32089b8851bbf8bc2d014e9f37288c83", "09D278F9DE118EF09163C6140255C690", "03866661686829d806989e2fc5a72606", "e57401fbdadcd4571ff385ab82bd5d6d", "84B763C45C0E4A3E7CA5548C710DB4EE", "19584675d94829987952432e018d5056", "330768a4f172e10acb6287b87289d83b"] or (Process.Hashes like r"%IMPHASH=BCCA3C247B619DCD13C8CDFF5F123932%" or Process.Hashes like r"%IMPHASH=3A19059BD7688CB88E70005F18EFC439%" or Process.Hashes like r"%IMPHASH=bf6223a49e45d99094406777eb6004ba%" or Process.Hashes like r"%IMPHASH=0C106686A31BFE2BA931AE1CF6E9DBC6%" or Process.Hashes like r"%IMPHASH=0D1447D4B3259B3C2A1D4CFB7ECE13C3%" or Process.Hashes like r"%IMPHASH=1B0369A1E06271833F78FFA70FFB4EAF%" or Process.Hashes like r"%IMPHASH=4C1B52A19748428E51B14C278D0F58E3%" or Process.Hashes like r"%IMPHASH=4D927A711F77D62CEBD4F322CB57EC6F%" or Process.Hashes like r"%IMPHASH=66EE036DF5FC1004D9ED5E9A94A1086A%" or Process.Hashes like r"%IMPHASH=672B13F4A0B6F27D29065123FE882DFC%" or Process.Hashes like r"%IMPHASH=6BBD59CEA665C4AFCC2814C1327EC91F%" or Process.Hashes like r"%IMPHASH=725BB81DC24214F6ECACC0CFB36AD30D%" or Process.Hashes like r"%IMPHASH=9528A0E91E28FBB88AD433FEABCA2456%" or Process.Hashes like r"%IMPHASH=9DA6D5D77BE11712527DCAB86DF449A3%" or Process.Hashes like r"%IMPHASH=A6E01BC1AB89F8D91D9EAB72032AAE88%" or Process.Hashes like r"%IMPHASH=B24C5EDDAEA4FE50C6A96A2A133521E4%" or Process.Hashes like r"%IMPHASH=D21BBC50DCC169D7B4D0F01962793154%" or Process.Hashes like r"%IMPHASH=FCC251CCEAE90D22C392215CC9A2D5D6%" or Process.Hashes like r"%IMPHASH=23867A89C2B8FC733BE6CF5EF902F2D1%" or Process.Hashes like r"%IMPHASH=A37FF327F8D48E8A4D2F757E1B6E70BC%" or Process.Hashes like r"%IMPHASH=F9A28C458284584A93B14216308D31BD%" or Process.Hashes like r"%IMPHASH=6118619783FC175BC7EBECFF0769B46E%" or Process.Hashes like r"%IMPHASH=959A83047E80AB68B368FDB3F4C6E4EA%" or Process.Hashes like r"%IMPHASH=563233BFA169ACC7892451F71AD5850A%" or Process.Hashes like r"%IMPHASH=87575CB7A0E0700EB37F2E3668671A08%" or Process.Hashes like r"%IMPHASH=13F08707F759AF6003837A150A371BA1%" or Process.Hashes like r"%IMPHASH=1781F06048A7E58B323F0B9259BE798B%" or Process.Hashes like r"%IMPHASH=233F85F2D4BC9D6521A6CAAE11A1E7F5%" or Process.Hashes like r"%IMPHASH=24AF2584CBF4D60BBE5C6D1B31B3BE6D%" or Process.Hashes like r"%IMPHASH=632969DDF6DBF4E0F53424B75E4B91F2%" or Process.Hashes like r"%IMPHASH=713C29B396B907ED71A72482759ED757%" or Process.Hashes like r"%IMPHASH=749A7BB1F0B4C4455949C0B2BF7F9E9F%" or Process.Hashes like r"%IMPHASH=8628B2608957A6B0C6330AC3DE28CE2E%" or Process.Hashes like r"%IMPHASH=8B114550386E31895DFAB371E741123D%" or Process.Hashes like r"%IMPHASH=94CB940A1A6B65BED4D5A8F849CE9793%" or Process.Hashes like r"%IMPHASH=9D68781980370E00E0BD939EE5E6C141%" or Process.Hashes like r"%IMPHASH=B18A1401FF8F444056D29450FBC0A6CE%" or Process.Hashes like r"%IMPHASH=CB567F9498452721D77A451374955F5F%" or Process.Hashes like r"%IMPHASH=730073214094CD328547BF1F72289752%" or Process.Hashes like r"%IMPHASH=17B461A082950FC6332228572138B80C%" or Process.Hashes like r"%IMPHASH=DC25EE78E2EF4D36FAA0BADF1E7461C9%" or Process.Hashes like r"%IMPHASH=819B19D53CA6736448F9325A85736792%" or Process.Hashes like r"%IMPHASH=829DA329CE140D873B4A8BDE2CBFAA7E%" or Process.Hashes like r"%IMPHASH=C547F2E66061A8DFFB6F5A3FF63C0A74%" or Process.Hashes like r"%IMPHASH=0588081AB0E63BA785938467E1B10CCA%" or Process.Hashes like r"%IMPHASH=0D9EC08BAC6C07D9987DFD0F1506587C%" or Process.Hashes like r"%IMPHASH=BC129092B71C89B4D4C8CDF8EA590B29%" or Process.Hashes like r"%IMPHASH=4DA924CF622D039D58BCE71CDF05D242%" or Process.Hashes like r"%IMPHASH=E7A3A5C377E2D29324093377D7DB1C66%" or Process.Hashes like r"%IMPHASH=9A9DBEC5C62F0380B4FA5FD31DEFFEDF%" or Process.Hashes like r"%IMPHASH=AF8A3976AD71E5D5FDFB67DDB8DADFCE%" or Process.Hashes like r"%IMPHASH=0C477898BBF137BBD6F2A54E3B805FF4%" or Process.Hashes like r"%IMPHASH=0CA9F02B537BCEA20D4EA5EB1A9FE338%" or Process.Hashes like r"%IMPHASH=3AB3655E5A14D4EEFC547F4781BF7F9E%" or Process.Hashes like r"%IMPHASH=E6F9D5152DA699934B30DAAB206471F6%" or Process.Hashes like r"%IMPHASH=3AD59991CCF1D67339B319B15A41B35D%" or Process.Hashes like r"%IMPHASH=FFDD59E0318B85A3E480874D9796D872%" or Process.Hashes like r"%IMPHASH=0CF479628D7CC1EA25EC7998A92F5051%" or Process.Hashes like r"%IMPHASH=07A2D4DCBD6CB2C6A45E6B101F0B6D51%" or Process.Hashes like r"%IMPHASH=D6D0F80386E1380D05CB78E871BC72B1%" or Process.Hashes like r"%IMPHASH=38D9E015591BBFD4929E0D0F47FA0055%" or Process.Hashes like r"%IMPHASH=0E2216679CA6E1094D63322E3412D650%" or Process.Hashes like r"%IMPHASH=ADA161BF41B8E5E9132858CB54CAB5FB%" or Process.Hashes like r"%IMPHASH=2A1BC4913CD5ECB0434DF07CB675B798%" or Process.Hashes like r"%IMPHASH=11083E75553BAAE21DC89CE8F9A195E4%" or Process.Hashes like r"%IMPHASH=A23D29C9E566F2FA8FFBB79267F5DF80%" or Process.Hashes like r"%IMPHASH=4A07F944A83E8A7C2525EFA35DD30E2F%" or Process.Hashes like r"%IMPHASH=767637C23BB42CD5D7397CF58B0BE688%" or Process.Hashes like r"%IMPHASH=14C4E4C72BA075E9069EE67F39188AD8%" or Process.Hashes like r"%IMPHASH=3C782813D4AFCE07BBFC5A9772ACDBDC%" or Process.Hashes like r"%IMPHASH=7D010C6BB6A3726F327F7E239166D127%" or Process.Hashes like r"%IMPHASH=89159BA4DD04E4CE5559F132A9964EB3%" or Process.Hashes like r"%IMPHASH=6F33F4A5FC42B8CEC7314947BD13F30F%" or Process.Hashes like r"%IMPHASH=5834ED4291BDEB928270428EBBAF7604%" or Process.Hashes like r"%IMPHASH=5A8A8A43F25485E7EE1B201EDCBC7A38%" or Process.Hashes like r"%IMPHASH=DC7D30B90B2D8ABF664FBED2B1B59894%" or Process.Hashes like r"%IMPHASH=41923EA1F824FE63EA5BEB84DB7A3E74%" or Process.Hashes like r"%IMPHASH=3DE09703C8E79ED2CA3F01074719906B%" or Process.Hashes like r"%IMPHASH=A53A02B997935FD8EEDCB5F7ABAB9B9F%" or Process.Hashes like r"%IMPHASH=E96A73C7BF33A464C510EDE582318BF2%" or Process.Hashes like r"%IMPHASH=32089B8851BBF8BC2D014E9F37288C83%" or Process.Hashes like r"%IMPHASH=09D278F9DE118EF09163C6140255C690%" or Process.Hashes like r"%IMPHASH=03866661686829d806989e2fc5a72606%" or Process.Hashes like r"%IMPHASH=e57401fbdadcd4571ff385ab82bd5d6d%" or Process.Hashes like r"%IMPHASH=84B763C45C0E4A3E7CA5548C710DB4EE%" or Process.Hashes like r"%IMPHASH=19584675D94829987952432E018D5056%" or Process.Hashes like r"%IMPHASH=330768A4F172E10ACB6287B87289D83B%"))
GenericProperty1 = Process.Hash.IMP
GenericProperty2 = Process.Hashes

[ActivityMonitoringRule platform=Windows]
# Detects the execution of the PurpleSharp adversary simulation tool
# Author: Florian Roth (Nextron Systems)
RuleId = ff23ffbc-3378-435e-992f-0624dcf93ab4
RuleName = HackTool - PurpleSharp Execution
EventType = Process.Start
Tag = proc-start-hacktool-purplesharp-execution
RiskScore = 100
Annotation = {"mitre_attack": ["T1587"]}
Query = (Process.Path like r"%\\purplesharp%" or Process.Name == "PurpleSharp.exe" or (Process.CommandLine like r"%xyz123456.exe%" or Process.CommandLine like r"%PurpleSharp%"))

[ActivityMonitoringRule platform=Windows]
# Detects the execution of whoami that has been renamed to a different name to avoid detection
# Author: Florian Roth (Nextron Systems)
RuleId = f1086bf7-a0c4-4a37-9102-01e573caf4a0
RuleName = Renamed Whoami Execution
EventType = Process.Start
Tag = proc-start-renamed-whoami-execution
RiskScore = 100
Annotation = {"mitre_attack": ["T1033"]}
Query = (Process.Name == "whoami.exe" and not (Process.Path like r"%\\whoami.exe"))

[ActivityMonitoringRule platform=Windows]
# Detects the execution of SecurityXploded Tools
# Author: Florian Roth (Nextron Systems)
RuleId = 7679d464-4f74-45e2-9e01-ac66c5eb041a
RuleName = HackTool - SecurityXploded Execution
EventType = Process.Start
Tag = proc-start-hacktool-securityxploded-execution
RiskScore = 100
Annotation = {"mitre_attack": ["T1555"]}
Query = (Process.Company == "SecurityXploded" or Process.Path like r"%PasswordDump.exe" or Process.Name like r"%PasswordDump.exe")
GenericProperty1 = Process.Company

[ActivityMonitoringRule platform=Windows]
# Detects some Empire PowerShell UAC bypass methods
# Author: Ecco
RuleId = 3268b746-88d8-4cd3-bffc-30077d02c787
RuleName = HackTool - Empire PowerShell UAC Bypass
EventType = Process.Start
Tag = proc-start-hacktool-empire-powershell-uac-bypass
RiskScore = 100
Annotation = {"mitre_attack": ["T1548.002"]}
Query = (Process.CommandLine like r"% -NoP -NonI -w Hidden -c $x=$((gp HKCU:Software\\Microsoft\\Windows Update).Update)%" or Process.CommandLine like r"% -NoP -NonI -c $x=$((gp HKCU:Software\\Microsoft\\Windows Update).Update);%")

[ActivityMonitoringRule platform=Windows]
# F-Secure C3 produces DLLs with a default exported StartNodeRelay function.
# Author: Alfie Champion (ajpc500)
RuleId = b18c9d4c-fac9-4708-bd06-dd5bfacf200f
RuleName = HackTool - F-Secure C3 Load by Rundll32
EventType = Process.Start
Tag = proc-start-hacktool-f-secure-c3-load-by-rundll32
RiskScore = 100
Annotation = {"mitre_attack": ["T1218.011"]}
Query = (Process.CommandLine like r"%rundll32.exe%" and Process.CommandLine like r"%.dll%" and Process.CommandLine like r"%StartNodeRelay%")

[ActivityMonitoringRule platform=Windows]
# Detects the use of Windows Credential Editor (WCE)
# Author: Florian Roth (Nextron Systems)
RuleId = 7aa7009a-28b9-4344-8c1f-159489a390df
RuleName = HackTool - Windows Credential Editor (WCE) Execution
EventType = Process.Start
Tag = proc-start-hacktool-windows-credential-editor-(wce)-execution
RiskScore = 100
Annotation = {"mitre_attack": ["T1003.001"]}
Query = (((Process.Hash.IMP in ["a53a02b997935fd8eedcb5f7abab9b9f", "e96a73c7bf33a464c510ede582318bf2"] or (Process.Hashes like r"%IMPHASH=a53a02b997935fd8eedcb5f7abab9b9f%" or Process.Hashes like r"%IMPHASH=e96a73c7bf33a464c510ede582318bf2%")) or (Process.CommandLine like r"%.exe -S" and Parent.Path like r"%\\services.exe")) and not (Process.Path like r"%\\clussvc.exe"))
GenericProperty1 = Process.Hash.IMP
GenericProperty2 = Process.Hashes
GenericProperty3 = Parent.Path

