#
# This uberAgent configuration file contains Threat Detection rules.
# It can only used if uberAgent ESA is enabled.
#

########################################################################################
#
# Reusable expressions
#
########################################################################################

[AddActivityMonitoringExpression platform=Windows name=ParentIsMsOffice]
Query = istartswith(Parent.Company, "Microsoft") and Parent.Name in ["excel.exe", "msaccess.exe", "onenote.exe", "outlook.exe", "powerpnt.exe", "winword.exe"]

[AddActivityMonitoringExpression name=ProcessIsBrowserWindows]
Query = Process.Name in ["chrome.exe", "iexplore.exe", "firefox.exe", "msedge.exe", "msedgewebview2.exe", "opera.exe"]

[AddActivityMonitoringExpression name=ProcessIsBrowserMacOS]
Query = Process.Name == "Google Chrome" or (Parent.Name == "Google Chrome" and Process.Name like "%Google Chrome%") or Process.Name == "Firefox" or (Parent.Name == "Firefox" and Process.Name like "%Firefox%") or Process.Name == "Microsoft Edge" or (Parent.Name == "Microsoft Edge" and Process.Name like "%Microsoft Edge%") or Process.Name == "Opera" or (Parent.Name == "Opera" and Process.Name like "%Opera%") or Process.Name == "Safari" or (Parent.Name == "Safari" and Process.Name like "%Safari%")

[AddActivityMonitoringExpression name=ProcessIsBrowser]
Query = ProcessIsBrowserWindows or ProcessIsBrowserMacOS

[AddActivityMonitoringExpression name=ProcessIsPowerShell]
Query = Process.Name in ["powershell.exe", "pwsh.exe", "pwsh"]

[AddActivityMonitoringExpression name=TargetIsPrivateNetworkIP]
Query = istartswith(Net.Target.Ip, "127.") or istartswith(Net.Target.Ip, "192.") or istartswith(Net.Target.Ip, "172.") or istartswith(Net.Target.Ip, "10.") or istartswith(Net.Target.Ip, "fe80") or istartswith(Net.Target.Ip, "fc00") or istartswith(Net.Target.Ip, "fd00")

[AddActivityMonitoringExpression platform=Windows name=ProcessIsKnownRDPSoftware]
Query = Process.Name in ["mstsc.exe", "RTSApp.exe", "RTSApp2.exe", "RDCMan.exe", "ws_tunnelservice.exe", "RSSensor.exe", "RemoteDesktopManagerFree.exe", "RemoteDesktopManager.exe", "RemoteDesktopManager64.exe", "mRemoteNG.exe", "mRemote.exe", "Terminals.exe", "spiceworks-finder.exe", "FSDiscovery.exe", "FSAssessment.exe", "MobaRTE.exe", "chrome.exe", "thor.exe", "thor64.exe", "RoyalTS.exe"]

[AddActivityMonitoringExpression platform=Windows name=ProcessPathIsSystem32]
Query = Process.Path iregex_envvars r"^%SystemRoot%\\System32\\.*$"

[AddActivityMonitoringExpression platform=Windows name=ProcessPathIsSysWOW64]
Query = Process.Path iregex_envvars r"^%SystemRoot%\\SysWOW64\\.*$"

[AddActivityMonitoringExpression platform=Windows name=ProcessPathIsSystemDirectory]
Query = ProcessPathIsSystem32 or ProcessPathIsSysWOW64

[AddActivityMonitoringExpression platform=Windows name=RegistryValueOfficeMacroSettings]
Query = Reg.Key.Path like r"%\\Security" and Reg.Value.Name == "VBAWarnings"

[AddActivityMonitoringExpression name=ProcessPathIsWindowsDefender]
Query = Process.Path iregex_envvars r"^%ProgramData%\\Microsoft\\Windows Defender\\Platform\\[^\\]*\\(MsMpEng|MpDefenderCoreService)\.exe"

[AddActivityMonitoringExpression platform=Windows name=ProcessPathIsKnownWindows]
Query = Process.Path iregex_envvars r"^(%ProgramFiles%|%ProgramFiles(x86)%)\\Citrix\\online plugin\\ica client\\Receiver\\FeatureFlag\\CWAFeatureFlagUpdater\.exe$" or Process.Path iregex_envvars r"^(%ProgramFiles%|%ProgramFiles(x86)%)\\Citrix\\ConfigSync\\ConfigSyncRun\.exe$" or Process.Path iregex_envvars r"^(%ProgramFiles%|%ProgramFiles(x86)%)\\Google\\Update\\GoogleUpdate\.exe$" or Process.Path iregex_envvars r"^%WinDir%\\system32\\svchost\.exe" or Process.Path iregex_envvars r"^%WinDir%\\system32\\smartscreen\.exe" or Process.Path iregex_envvars r"^%WinDir%\\system32\\CompatTelRunner\.exe" or Process.Path iregex_envvars r"^%WinDir%\\system32\\taskhostw\.exe" or ProcessPathIsWindowsDefender

[AddActivityMonitoringExpression name=NetworkTargetIsKnown]
Query = Net.Target.Name == "download.apps.cloud.com" or Net.Target.Ip in [ /* Cloudflare */ "1.1.1.1", "1.0.0.1", /* Google */ "8.8.4.4", "8.8.8.8", /* Quad9 */ "208.67.222.222", "208.67.220.220"]

########################################################################################
#
# Threat Detection rule extensions
#
########################################################################################

# Image loads
[ThreatDetectionRuleExtension RuleId=bdc64095-d59a-42a2-8588-71fd9c9d9abc]
Name = Exclude Splunk in rule bdc64095-d59a-42a2-8588-71fd9c9d9abc
Query = Rule.Result and not Parent.Path iregex_envvars r"^(%ProgramFiles%|%ProgramFiles(x86)%)\\Splunk\\bin\\splunkd\.exe$"

[ThreatDetectionRuleExtension RuleId=37774c23-25a1-4adb-bb6d-8bb9fd59c0f8]
Name = Exclude valid system processes in rule 37774c23-25a1-4adb-bb6d-8bb9fd59c0f8
Query = Rule.Result and Process.Path != "C:\\windows\\servicing\\TrustedInstaller.exe"

[ThreatDetectionRuleExtension RuleId=48bfd177-7cf2-412b-ad77-baf923489e82]
Name = Exclude valid system processes in rule 48bfd177-7cf2-412b-ad77-baf923489e82
Query = Rule.Result and Process.Path != "C:\\windows\\servicing\\TrustedInstaller.exe"


# Process starts
[ThreatDetectionRuleExtension RuleId=71158e3f-df67-472b-930e-7d287acaa3e1]
Name = Exclude valid system processes in rule 71158e3f-df67-472b-930e-7d287acaa3e1
Query = Rule.Result and not (Parent.Name == "System" and Process.Name in  ["Secure System", "Memory Compression"])

[ThreatDetectionRuleExtension RuleId=c09dad97-1c78-4f71-b127-7edb2b8e491a]
Name = Exclude valid system processes in rule c09dad97-1c78-4f71-b127-7edb2b8e491a
Query = Rule.Result and not (Parent.Name == "System" and Process.Name in  ["Secure System", "Memory Compression"])

[ThreatDetectionRuleExtension RuleId=e4b6d2a7-d8a4-4f19-acbd-943c16d90647]
Name = Exclude valid scripts by uberAgent in rule e4b6d2a7-d8a4-4f19-acbd-943c16d90647
Query = Rule.Result and not icontains(Parent.CommandLine, "\\WindowsConfiguration\\WindowsConfiguration-User.ps1\" uberAgent-SCI")

[ThreatDetectionRuleExtension]
Name = Exclude uberAgent activity
Query = Rule.Result and (Process.Id != uberAgent.Pid and Parent.Id != uberAgent.Pid)
Altitude = 100


########################################################################################
#
# Process starts from insecure directories
#
########################################################################################

[ActivityMonitoringRule platform=Windows]
RuleId = 84fae5e2-fae0-427e-b9e4-1c6a371b9913
RuleName = Detect process starts from directories with a low mandatory integrity label
EventType = Process.Start
# MIC label format in the SDDL string: (ML;OICIID;;;;LW)
Tag = proc-start-dir-low-integrity
Annotation = {"mitre_attack": ["T1548"], "author": "vast limits"}
Query = Process.DirectorySdSddl iregex r"\(ML;.*?;.*?;.*?;.*?;LW;?.*?\)"

[ActivityMonitoringRule platform=Windows]
RuleId = 7a16b05d-7d9d-4b83-8dab-3b294ef39d90
RuleName = Detect processes started from directories that are user-writeable
EventType = Process.Start
Tag = proc-start-dir-user-writeable
Annotation = {"mitre_attack": ["T1548"], "author": "vast limits"}
Query = Process.DirectoryUserWriteable == true

########################################################################################
#
# Microsoft Office
#
########################################################################################

#
# Office child processes
#

[ActivityMonitoringRule platform=Windows]
RuleId = 67c7f3a2-daa6-4606-9954-9d1ca1531747
RuleName = Detect script child processes of Microsoft Office applications
EventType = Process.Start
Tag = proc-start-msoffice-child
RiskScore = 100
Annotation = {"mitre_attack": ["T1204.002"], "author": "vast limits"}
Query = ParentIsMsOffice and (Process.Name in ["cmd.exe", "cscript.exe", "wscript.exe", "ftp.exe"] or ProcessIsPowerShell)

[ActivityMonitoringRule platform=Windows]
RuleId = 32951151-cb3c-435f-bb2d-5043802fc055
RuleName = Detect child processes of Microsoft Office applications
EventType = Process.Start
Tag = proc-start-msoffice-child
Annotation = {"mitre_attack": ["T1204.002"], "author": "vast limits"}
Query = ParentIsMsOffice and not ProcessIsBrowser and Process.Name != "onenotem.exe" and Process.Name != "winword.exe"

#
# Office macro execution
#

[ActivityMonitoringRule platform=Windows]
RuleId = cef6a5fc-2b0d-462b-9ab4-37556546390a
RuleName = Registry change to Office trust records: macro execution allowed (might still be blocked depending on macro settings, e.g. "disable all macros without notification")
EventType = Reg.Value.Write
Hive = HKLM,HKU
Annotation = {"mitre_attack": ["T1204.002"], "author": "vast limits"}
Query = Reg.Key.Path like r"%\\Security\\Trusted Documents\\TrustRecords" and registry_read_binary(Reg.Key.Hive, Reg.Key.Path, Reg.Value.Name) like "%7F"
Tag = reg-value-write-office-macro-execution-allowed
RiskScore = 100
GenericProperty1 = Reg.Key.Path
GenericProperty2 = Reg.Value.Name

#
# Office macro security
#

[ActivityMonitoringRule platform=Windows]
RuleId = 786b309b-b322-4ffa-aa03-12381d30ca4e
RuleName = Registry change to Office macro settings, new value: enable all macros
EventType = Reg.Value.Write
Hive = HKLM,HKU
Annotation = {"mitre_attack": ["T1137"], "author": "vast limits"}
Query = RegistryValueOfficeMacroSettings and registry_read_number(Reg.Key.Hive, Reg.Key.Path, Reg.Value.Name) == 1
Tag = reg-value-write-office-macro-settings-enable-macros
RiskScore = 100
GenericProperty1 = Reg.Key.Path
GenericProperty4 = Reg.Value.Name
GenericProperty6 = Reg.Key.Sddl

[ActivityMonitoringRule platform=Windows]
RuleId = c096c5ef-6869-4d7d-bba0-b1b362e58f19
RuleName = Registry change to Office macro settings, new value: disable all macros with notification
EventType = Reg.Value.Write
Hive = HKLM,HKU
Annotation = {"mitre_attack": ["T1137"], "author": "vast limits"}
Query = RegistryValueOfficeMacroSettings and registry_read_number(Reg.Key.Hive, Reg.Key.Path, Reg.Value.Name) == 2
Tag = reg-value-write-office-macro-settings-disable-notification
RiskScore = 75
GenericProperty1 = Reg.Key.Path
GenericProperty4 = Reg.Value.Name
GenericProperty6 = Reg.Key.Sddl

[ActivityMonitoringRule platform=Windows]
RuleId = 8a09d6fe-3ad9-4c48-bda9-fe13348f3545
RuleName = Registry change to Office macro settings, new value: disable all macros except those digitally signed
EventType = Reg.Value.Write
Hive = HKLM,HKU
Annotation = {"mitre_attack": ["T1137"], "author": "vast limits"}
Query = RegistryValueOfficeMacroSettings and registry_read_number(Reg.Key.Hive, Reg.Key.Path, Reg.Value.Name) == 3
Tag = reg-value-write-office-macro-settings-disable-except-signed
RiskScore = 30
GenericProperty1 = Reg.Key.Path
GenericProperty4 = Reg.Value.Name
GenericProperty6 = Reg.Key.Sddl

[ActivityMonitoringRule platform=Windows]
RuleId = be015cf6-b8ab-4d1c-836b-6ee83d113362
RuleName = Registry change to Office macro settings, new value: disable all macros without notification
EventType = Reg.Value.Write
Hive = HKLM,HKU
Annotation = {"mitre_attack": ["T1137"], "author": "vast limits"}
Query = RegistryValueOfficeMacroSettings and registry_read_number(Reg.Key.Hive, Reg.Key.Path, Reg.Value.Name) == 4
Tag = reg-value-write-office-macro-settings-disable-all
RiskScore = 0
GenericProperty1 = Reg.Key.Path
GenericProperty4 = Reg.Value.Name
GenericProperty6 = Reg.Key.Sddl

[ActivityMonitoringRule platform=Windows]
RuleId = 18c13aea-501b-45ac-b1b1-10eb3a3b794a
RuleName = Registry change to Office macro security
EventType = Reg.Value.Write
Hive = HKLM,HKU
Annotation = {"mitre_attack": ["T1137"], "author": "vast limits"}
Query = Reg.Key.Path like r"%\\Security\\AccessVBOM" or Reg.Key.Path like r"%\\Security\\Trusted Locations\\%"
Tag = reg-value-write-office-macro-settings
RiskScore = 75
GenericProperty1 = Reg.Key.Path
GenericProperty2 = Reg.Key.Name
GenericProperty3 = Reg.Parent.Key.Path
GenericProperty4 = Reg.Value.Name
GenericProperty5 = Reg.File.Name
GenericProperty6 = Reg.Key.Sddl
GenericProperty7 = Reg.Key.Hive
GenericProperty8 = Reg.Key.Target

[ActivityMonitoringRule platform=Windows]
RuleId = 7098a059-4191-4a9e-973c-8976d61cddc0
RuleName = Registry delete to Office macro settings
EventType = Reg.Value.Delete
Hive = HKLM,HKU
Annotation = {"mitre_attack": ["T1137"], "author": "vast limits"}
Query = Reg.Key.Path like r"%\\Security\\Trusted Documents\\TrustRecords" or Reg.Key.Path like r"%\\Security\\AccessVBOM" or Reg.Key.Path like r"%\\Security\\VBAWarnings" or Reg.Key.Path like r"%\\Security\\Trusted Locations\\%"
Tag = reg-value-delete-office-macro-settings
RiskScore = 100
GenericProperty1 = Reg.Key.Path
GenericProperty2 = Reg.Key.Name
GenericProperty3 = Reg.Parent.Key.Path
GenericProperty4 = Reg.Value.Name
GenericProperty5 = Reg.File.Name
GenericProperty6 = Reg.Key.Sddl
GenericProperty7 = Reg.Key.Hive
GenericProperty8 = Reg.Key.Target

#
# Office as LOLBIN
#

[ActivityMonitoringRule platform=Windows]
RuleId = 35b69884-90d6-4000-a017-b3e3be5c1026
RuleName = Detect Microsoft Office download operations (LOLBAS)
EventType = Process.Start
Tag = proc-start-lolbas-download
Annotation = {"mitre_attack": ["T1105"], "author": "vast limits"}
Query = ParentIsMsOffice and Process.CommandLine iregex r"(http|https)"

########################################################################################
#
# WMI
#
########################################################################################

[ActivityMonitoringRule platform=Windows]
RuleId = 0a1bbfbc-e0d9-4c49-953e-e31c3aa3fc91
RuleName = Detect child processes of the WMI service
EventType = Process.Start
Tag = proc-start-wmiservice-child
Annotation = {"mitre_attack": ["T1047"], "author": "vast limits"}
Query = Parent.Name == "wmiprvse.exe" and not Process.Path iregex_envvars r"^(%ProgramFiles%|%ProgramFiles(x86)%)\\Citrix\\HDX\\bin\\CtxSession\.exe$"

########################################################################################
#
# Adobe Acrobat Reader
#
########################################################################################

[ActivityMonitoringRule platform=Windows]
RuleId = 8a16160d-4eac-4ae4-8fe4-7af7320ebf1e
RuleName = Detect child processes of Adobe Acrobat Reader
# Source: https://www.microsoft.com/security/blog/2019/02/22/recommendations-for-deploying-the-latest-attack-surface-reduction-rules-for-maximum-impact/
EventType = Process.Start
Tag = proc-start-adobereader-child
Annotation = {"mitre_attack": ["T1204.002"], "author": "vast limits"}
Query = Parent.Name == "acrord32.exe" and Process.Name not in ["RdrCEF.exe", "acrord32.exe", "AdobeARM.exe"]

########################################################################################
#
# LOLBAS
#
########################################################################################

[ActivityMonitoringRule platform=Windows]
RuleId = 0e85dc3b-6230-4e8c-b09a-183c23bf31a7
RuleName = Detect child processes (LOLBAS)
# Source: https://lolbas-project.github.io/
EventType = Process.Start
Tag = proc-start-lolbas-child
Annotation = {"mitre_attack": ["T1218"], "author": "vast limits"}
Query = Parent.Name in ["bash.exe", "bitsadmin.exe", "diskshadow.exe", "forfiles.exe", "ftp.exe", "hh.exe", "ieexec.exe", "Microsoft.Workflow.Compiler.exe", "msconfig.exe", "pcalua.exe", "pcwrun.exe", "rundll32.exe", "scriptrunner.exe", "wmic.exe", "Appvlp.exe", "cdb.exe", "devtoolslauncher.exe", "dnx.exe", "dxcap.exe", "mftrace.exe", "msdeploy.exe", "Sqlps.exe", "SQLToolsPS.exe", "te.exe", "update.exe", "vsjitdebugger.exe", "wsl.exe", "squirrel.exe"]

[ActivityMonitoringRule platform=Windows]
RuleId = 3b95cda6-6057-42cc-bf6b-9b49d0848ca4
RuleName = Detect starts from non-default locations (LOLBAS)
# Source: https://lolbas-project.github.io/
EventType = Process.Start
Tag = proc-start-lolbas-other-location
Annotation = {"mitre_attack": ["T1218"], "author": "vast limits"}
Query = not ProcessPathIsSystemDirectory and Process.Name in ["ie4uinit.exe", "cscript.exe", "wsscript.exe", "cmd.exe"]

[ActivityMonitoringRule platform=Windows]
RuleId = 25b35200-5154-4154-a2dd-0e4c932b8366
RuleName = Detect compile and execute (LOLBAS)
# Source: https://lolbas-project.github.io/
EventType = Process.Start
Tag = proc-start-lolbas-compile-and-exec
Annotation = {"mitre_attack": ["T1127.001"], "author": "vast limits"}
Query = lower(Process.Name) == "msbuild.exe" and (icontains(Process.CommandLine, ".csproj") or icontains(Process.CommandLine, ".xml"))

[ActivityMonitoringRule platform=Windows]
RuleId = 9220e5d6-5c97-44ac-9dca-2063300d62d1
RuleName = Detect proxy execution (LOLBAS)
# Source: https://lolbas-project.github.io/
EventType = Process.Start
Tag = proc-start-lolbas-proxy-exec
Annotation = {"mitre_attack": ["T1218"], "author": "vast limits"}
Query = Process.Name == "reg.exe" and Process.CommandLine iregex r"import.*\.reg.*&.*winrm.*quickconfig"

[ActivityMonitoringRule platform=Windows]
RuleId = 6b0add9d-8df0-4df3-899c-d36e020329fb
RuleName = Detect jsc compile (LOLBAS)
# Source: https://lolbas-project.github.io/
EventType = Process.Start
Tag = proc-start-lolbas-compile
Annotation = {"mitre_attack": ["T1127"], "author": "vast limits"}
Query = Process.Name == "jsc.exe" and Process.CommandLine like "%.js"

[ActivityMonitoringRule platform=Windows]
RuleId = c9e5bbda-d545-45f9-b0cd-505d25899c1e
RuleName = Detect csc compile (LOLBAS)
# Source: https://lolbas-project.github.io/
EventType = Process.Start
Tag = proc-start-lolbas-compile
Annotation = {"mitre_attack": ["T1127"], "author": "vast limits"}
Query = Process.Name == "csc.exe" and (Process.CommandLine iregex r"[\/|-]out:.*.exe.*.cs" or Process.CommandLine iregex r"[\/|-]target:library.*.cs")

[ActivityMonitoringRule platform=Windows]
RuleId = 5417022a-b435-49e5-8b4a-14c57f25af94
RuleName = Detect execution from alternate data streams (LOLBAS)
# Source: https://lolbas-project.github.io/
EventType = Process.Start
Tag = proc-start-lolbas-alternate-data-streams
Annotation = {"mitre_attack": ["T1564.004"], "author": "vast limits"}
Query = Process.Name in ["Certutil.exe", "Cmd.exe", "Control.exe", "Cscript.exe", "Esentutl.exe", "Expand.exe", "Extract32.exe", "Findstr.exe", "Makecab.exe", "Mavinject.exe", "Mshta.exe", "Print.exe", "Reg.exe", "Regedit.exe", "Sc.exe", "Wmic.exe", "Wscript.exe"] and Process.CommandLine iregex r"\w:\w"

[ActivityMonitoringRule platform=Windows]
RuleId = b95c2154-3299-4653-9b6e-d421a158e6ba
RuleName = Detect encode and decode operations (LOLBAS)
# Source: https://lolbas-project.github.io/
EventType = Process.Start
Tag = proc-start-lolbas-encode-decode
Annotation = {"mitre_attack": ["T1027"], "author": "vast limits"}
Query = Process.Name == "certutil.exe" and (Process.CommandLine iregex r"[\/|-]encode" or Process.CommandLine iregex r"[\/|-]decode")

[ActivityMonitoringRule platform=Windows]
RuleId = dee9e5ed-7d35-4658-a474-26c6ab4b40de
RuleName = Detect findstr.exe download operations (LOLBAS)
# Source: https://lolbas-project.github.io/
EventType = Process.Start
Tag = proc-start-lolbas-download
Annotation = {"mitre_attack": ["T1185"], "author": "vast limits"}
Query = Process.Name == "findstr.exe" and Process.CommandLine iregex r"(?=.*[\/|-]v)(?=.*[\/|-]l)(?=.*>)"

[ActivityMonitoringRule platform=Windows]
RuleId = 5563d38c-c379-4e84-bfe0-51f136a84fdb
RuleName = Detect makecab.exe download operations (LOLBAS)
# Source: https://lolbas-project.github.io/
EventType = Process.Start
Tag = proc-start-lolbas-download
Annotation = {"mitre_attack": ["T1105"], "author": "vast limits"}
Query = Process.Name == "makecab.exe" and Process.CommandLine iregex r"\S+\s+\S+"

[ActivityMonitoringRule platform=Windows]
RuleId = ac0afdf9-9e9e-4439-ba01-841acbacf8ab
RuleName = Detect squirrel.exe download operations (LOLBAS)
# Source: https://lolbas-project.github.io/
EventType = Process.Start
Tag = proc-start-lolbas-download
Annotation = {"mitre_attack": ["T1218"], "author": "vast limits"}
Query = Process.Name == "squirrel.exe" and Process.CommandLine iregex r"--download"

[ActivityMonitoringRule platform=Windows]
RuleId = bc4001fa-a83d-4192-9225-89bb54d6a4b1
RuleName = Detect update.exe download operations (LOLBAS)
# Source: https://lolbas-project.github.io/
EventType = Process.Start
Tag = proc-start-lolbas-download
Annotation = {"mitre_attack": ["T1218"], "author": "vast limits"}
Query = Process.Name == "update.exe" and Process.CommandLine iregex r"--download"

########################################################################################
#
# DNS exfiltration
#
########################################################################################

[ActivityMonitoringRule]
RuleId = bc4001fa-a83d-4192-9225-89bb54d6a4c5
RuleName = Detect DNS exfiltration through nslookup
# This rule may produce many false positives. Non-critical processes must be excluded individually. In the query, "uberAgent.exe" is excluded as an example.
EventType = Process.Start
Tag = proc-start-dns-exfiltration-nslookup
Annotation = {"mitre_attack": ["T1048"], "author": "vast limits"}
Query = Process.Name in ["nslookup.exe","nslookup"] and Parent.Name not in ["uberAgent.exe","uberAgent"]


########################################################################################
#
# PowerShell
#
########################################################################################

[ActivityMonitoringRule platform=Windows]
RuleId = ad0f46d0-9a7a-4233-a93b-e3bbb5ee7dbd
RuleName = PowerShell outbound network connections
EventType = Net.Connect
Tag = net-connect-outbound-powershell-network
Annotation = {"mitre_attack": ["T1105"], "author": "vast limits"}
Query = ProcessIsPowerShell and not TargetIsPrivateNetworkIP and not NetworkTargetIsKnown and Process.User iregex r"^NT AUTHORITY\\SYSTEM$"
GenericProperty1 = Net.Target.Ip
GenericProperty2 = Net.Target.Name
GenericProperty3 = Net.Target.Port
GenericProperty4 = Net.Target.Protocol

[ActivityMonitoringRule platform=Windows]
RuleId = 4940f757-3470-42a7-a709-8724b759696a
RuleName = PowerShell remoting
EventType = Net.Connect
Tag = net-connect-powershell-remoting
Annotation = {"mitre_attack": ["T1059.001"], "author": "vast limits"}
Query = ProcessIsPowerShell and Net.Target.Port in [5985, 5986] and not Process.User iregex r"^NT AUTHORITY\\NETWORK SERVICE$"
GenericProperty1 = Net.Target.Ip
GenericProperty2 = Net.Target.Name
GenericProperty3 = Net.Target.Port
GenericProperty4 = Net.Target.Protocol

########################################################################################
#
# Network connections (misc.)
#
########################################################################################

[ActivityMonitoringRule platform=Windows]
RuleId = 5f5774b2-36f4-4990-be0b-ea5c6717e403
RuleName = Suspicious target names
# Source: https://github.com/Neo23x0/sigma
EventType = Net.Connect
Tag = net-connect-suspicious-target-names
RiskScore = 75
Annotation = {"mitre_attack": ["T1105"], "author": "vast limits"}
Query = Process.Path iregex_envvars r"^%SystemRoot%" and (Net.Target.Name iregex r"dl\.dropboxusercontent\.com" or Net.Target.Name iregex r"\.pastebin\.com" or Net.Target.Name iregex r"\.githubusercontent\.com" or Net.Target.Name iregex r"\.github\.com")
GenericProperty1 = Net.Target.Ip
GenericProperty2 = Net.Target.Name
GenericProperty3 = Net.Target.Port
GenericProperty4 = Net.Target.Protocol

[ActivityMonitoringRule platform=Windows]
RuleId = c9de8260-a99b-401e-b28b-b4530df68ebc
RuleName = Suspicious outbound Kerberos connections
# Source: https://github.com/Neo23x0/sigma
EventType = Net.Connect
Tag = net-connect-outbound-kerberos
RiskScore = 75
Annotation = {"mitre_attack": ["T1558.003"], "author": "vast limits"}
Query = not ProcessIsBrowser and not TargetIsPrivateNetworkIP and not NetworkTargetIsKnown and Net.Target.Port == 88
GenericProperty1 = Net.Target.Ip
GenericProperty2 = Net.Target.Name
GenericProperty3 = Net.Target.Port
GenericProperty4 = Net.Target.Protocol

[ActivityMonitoringRule platform=Windows]
RuleId = 0c204f73-ce45-4708-934a-9d07fd2d7303
RuleName = Detect network connects from suspicious sources
EventType = Net.Connect
Tag = net-connect-suspicious-sources
Annotation = {"mitre_attack": ["T1105"], "author": "vast limits"}
Query = (Process.Path iregex r"^C:\\Users" or Process.Path iregex_envvars r"^%ALLUSERSPROFILE%" or Process.Path iregex_envvars r"^%ProgramData%" or Process.Path iregex_envvars r"^%SystemRoot%\\Temp" or Process.Path iregex r"$Recycle.bin$" or Process.Path iregex_envvars r"^%Systemdrive%:\\Perflogs" or Process.Path iregex r"config\\systemprofile" or Process.Path iregex_envvars r"^%SystemRoot%\\Fonts" or Process.Path iregex_envvars r"^%SystemRoot%\\IME" or Process.Path iregex_envvars r"^%SystemRoot%\\addins") and not ProcessPathIsWindowsDefender and not NetworkTargetIsKnown
GenericProperty1 = Net.Target.Ip
GenericProperty2 = Net.Target.Name
GenericProperty3 = Net.Target.Port
GenericProperty4 = Net.Target.Protocol

[ActivityMonitoringRule platform=Windows]
RuleId = e1c5e054-fe7b-4cee-9ea0-24b8185130ce
RuleName = Detect network connects from Windows processes
EventType = Net.Connect
Annotation = {"mitre_attack": ["T1105"], "author": "vast limits"}
Query = (ProcessIsPowerShell or Process.Name in ["at.exe", "certutil.exe", "cmd.exe", "cmstp.exe", "cscript.exe", "driverquery.exe", "dsquery.exe", "hh.exe", "infDefaultInstall.exe", "mmc.exe", "msbuild.exe", "mshta.exe", "msiexec.exe", "nbtstat.exe", "net.exe", "net1.exe", "notepad.exe", "nslookup.exe", "qprocess.exe", "qwinsta.exe", "qwinsta.exe", "reg.exe", "regsvcs.exe", "regsvr32.exe", "rundll32.exe", "rwinsta.exe", "sc.exe", "schtasks.exe", "taskkill.exe", "tasklist.exe", "wmic.exe", "wscript.exe"]) and not NetworkTargetIsKnown
Tag = net-connect-Windows-processes
GenericProperty1 = Net.Target.Ip
GenericProperty2 = Net.Target.Name
GenericProperty3 = Net.Target.Port
GenericProperty4 = Net.Target.Protocol

[ActivityMonitoringRule platform=Windows]
RuleId = 29094c60-6459-47aa-8620-581a25cad376
RuleName = Detect network connects from third-party tools
EventType = Net.Connect
Tag = net-connect-third-party-processes
Annotation = {"mitre_attack": ["T1105"], "author": "vast limits"}
Query = (Process.Name in ["java.exe", "javaw.exe", "javaws.exe", "nc.exe", "ncat.exe", "psexec.exe", "psexesvc.exe", "tor.exe", "vnc.exe", "vncservice.exe", "vncviewer.exe", "winexesvc.exe", "nmap.exe", "psinfo.exe"]) and not NetworkTargetIsKnown
GenericProperty1 = Net.Target.Ip
GenericProperty2 = Net.Target.Name
GenericProperty3 = Net.Target.Port
GenericProperty4 = Net.Target.Protocol

[ActivityMonitoringRule platform=Windows]
RuleId = 35103d32-ff9a-4a50-b20c-396f185e8a93
RuleName = RDP connects from non-RDP software indicating lateral movement
# Source: https://github.com/Neo23x0/sigma
EventType = Net.Connect
Tag = net-connect-suspicious-RDP-connects
Annotation = {"mitre_attack": ["T1021.001"], "author": "vast limits"}
Query = not ProcessIsKnownRDPSoftware and Net.Target.Port == 3389
GenericProperty1 = Net.Target.Ip
GenericProperty2 = Net.Target.Name
GenericProperty3 = Net.Target.Port
GenericProperty4 = Net.Target.Protocol

[ActivityMonitoringRule]
RuleId = 91ded0fc-2869-45a8-a06d-04f0b3f21532
RuleName = Detect network connects to suspicious ports
EventType = Net.Connect
Tag = net-connect-suspicious-ports
Annotation = {"mitre_attack": ["T1105"], "author": "vast limits"}
Query = Net.Target.Port in [ /* SSH */ 22, /* Telnet */ 23, /* SMTP */ 25, /* IMAP */ 142, /* VNC */ 5800, 5900, /* Socks proxy */ 1080, 3128, 8080, /* Tor */ 1723, 4500, 9001, 9030]
GenericProperty1 = Net.Target.Ip
GenericProperty2 = Net.Target.Name
GenericProperty3 = Net.Target.Port
GenericProperty4 = Net.Target.Protocol

[ActivityMonitoringRule]
RuleId = f8257d1f-a86f-44d8-b583-2b8d9cbe867e
RuleName = Detect network connects to 80 and 443 from non-browser applications
EventType = Net.Connect
Tag = net-connect-80-443-non-browser
RiskScore = 25
Annotation = {"mitre_attack": ["T1105"], "author": "vast limits"}
Query = Net.Target.Port in [80, 443] and not ProcessIsBrowser and not TargetIsPrivateNetworkIP and not NetworkTargetIsKnown and not ProcessPathIsKnownWindows and not Process.Path in /* Known macOS paths */ ["/usr/sbin/mDNSResponder", "/usr/libexec/mobileassetd", "/System/Library/PrivateFrameworks/ApplePushService.framework/apsd", "/System/Library/CoreServices/Software Update.app/Contents/Resources/softwareupdated", "/System/Library/PrivateFrameworks/GeoServices.framework/Versions/A/XPCServices/com.apple.geod.xpc/Contents/MacOS/com.apple.geod", "/System/Library/CoreServices/Software Update.app/Contents/Resources/softwareupdated", "/System/Library/PrivateFrameworks/ApplePushService.framework/apsd", "/usr/libexec/mobileassetd", "/usr/libexec/rtcreportingd", "/usr/sbin/mDNSResponder"]
GenericProperty1 = Net.Target.Ip
GenericProperty2 = Net.Target.Name
GenericProperty3 = Net.Target.Port
GenericProperty4 = Net.Target.Protocol

########################################################################################
#
# Certificates
#
########################################################################################

[ActivityMonitoringRule platform=Windows]
RuleId = 1414388f-fc7b-4916-ad7f-1399ffcff026
RuleName = Detect AuthRoot, CA and Root certificate changes
# Source = https://posts.specterops.io/code-signing-certificate-cloning-attacks-and-defenses-6f98657fc6ec
EventType = Reg.Value.Write
Hive = HKLM,HKU
Annotation = {"mitre_attack": ["T1588.003"], "author": "vast limits"}
Query = Process.Name != "uberAgent.exe" and Reg.Key.Path iregex_envvars r"Software(\\Policies)*\\Microsoft\\(EnterpriseCertificates|SystemCertificates)\\(AuthRoot|CA|Root)\\Certificates\\.+" and Reg.Value.Name == "Blob"
Tag = reg-value-write-cert-change
RiskScore = 100
GenericProperty1 = Reg.Key.Path
GenericProperty2 = Reg.Key.Name
GenericProperty3 = Reg.Parent.Key.Path
GenericProperty4 = Reg.Value.Name
GenericProperty5 = Reg.File.Name
GenericProperty6 = Reg.Key.Sddl
GenericProperty7 = Reg.Key.Hive
GenericProperty8 = Reg.Key.Target

########################################################################################
#
# Services
#
########################################################################################

[ActivityMonitoringRule platform=Windows]
RuleId = a20c2e1f-2984-4622-bd47-bf925c1aaa07
RuleName = Detect service creation via registry
EventType = Reg.Key.Create
Hive = HKLM
Annotation = {"mitre_attack": ["T1543.003"], "author": "vast limits"}
Query = Reg.Parent.Key.Path iregex r"^SYSTEM\\\w*ControlSet\d*\\Services$" and not Process.Path iregex_envvars r"^%SystemRoot%\\(System32|SysWOW64)\\(services\.exe|svchost\.exe)$"
Tag = reg-key-create-service
GenericProperty1 = Reg.Key.Path
GenericProperty2 = Reg.Key.Name
GenericProperty3 = Reg.Parent.Key.Path
GenericProperty4 = Reg.Value.Name
GenericProperty5 = Reg.File.Name
GenericProperty6 = Reg.Key.Sddl
GenericProperty7 = Reg.Key.Hive
GenericProperty8 = Reg.Key.Target

########################################################################################
#
# Event log
#
########################################################################################

[ActivityMonitoringRule platform=Windows]
RuleId = d5b4d0b7-1bfe-4a6b-9664-7b321bfa4094
RuleName = Detect disabling security eventlog on create
EventType = Reg.Key.Create
Hive = HKLM
Annotation = {"mitre_attack": ["T1562.002"], "author": "vast limits"}
Query = Reg.Key.Path iregex r"^SYSTEM\\\w*ControlSet\d*\\Control\\MiniNt$"
Tag = reg-key-create-disable-security-eventlog
RiskScore = 100
GenericProperty1 = Reg.Key.Path
GenericProperty2 = Reg.Key.Name
GenericProperty3 = Reg.Parent.Key.Path
GenericProperty4 = Reg.Value.Name
GenericProperty5 = Reg.File.Name
GenericProperty6 = Reg.Key.Sddl
GenericProperty7 = Reg.Key.Hive
GenericProperty8 = Reg.Key.Target

[ActivityMonitoringRule platform=Windows]
RuleId = 21791409-7892-4122-9441-066955ee01b5
RuleName = Detect disabling security eventlog on rename
EventType = Reg.Key.Rename
Hive = HKLM
Annotation = {"mitre_attack": ["T1562.002"], "author": "vast limits"}
Query = Reg.Key.Path.New iregex r"^SYSTEM\\\w*ControlSet\d*\\Control\\MiniNt$"
Tag = reg-key-rename-disable-security-eventlog
RiskScore = 100
GenericProperty1 = Reg.Key.Path
GenericProperty2 = Reg.Key.Name
GenericProperty3 = Reg.Parent.Key.Path
GenericProperty4 = Reg.Value.Name
GenericProperty5 = Reg.File.Name
GenericProperty6 = Reg.Key.Sddl
GenericProperty7 = Reg.Key.Hive
GenericProperty8 = Reg.Key.Target
