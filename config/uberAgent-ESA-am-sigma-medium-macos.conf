
#
# The rules are generated from the Sigma GitHub repository at https://github.com/SigmaHQ/sigma
# To generate the ruleset, please follow the instructions provided in the repository: https://github.com/vastlimits/pySigma-backend-uberAgent/
#
# The command used to generate the ruleset is:
#    sigma convert -s -f conf -p uberagent-7.1.0 -t uberagent /home/runner/work/uberAgent-config/uberAgent-config/build/sigma-medium-macos >> uberAgent-ESA-am-sigma-medium-macos.conf
#

[ActivityMonitoringRule platform=MacOS]
# Detects additions to the Emond Launch Daemon that adversaries may use to gain persistence and elevate privileges.
# Author: Alejandro Ortuno, oscd.community
RuleId = 23c43900-e732-45a4-8354-63e4a6c187ce
RuleName = MacOS Emond Launch Daemon
EventType = File.Create
Tag = macos-emond-launch-daemon
RiskScore = 50
Annotation = {"mitre_attack": ["T1546.014"]}
Query = File.Path like "%/etc/emond.d/rules/%" and File.Path like "%.plist" or File.Path like "%/private/var/db/emondClients/%"
GenericProperty1 = File.Path


[ActivityMonitoringRule platform=MacOS]
# Detects execution of AppleScript of the macOS scripting language AppleScript.
# Author: Alejandro Ortuno, oscd.community
RuleId = 1bc2e6c5-0885-472b-bed6-be5ea8eace55
RuleName = MacOS Scripting Interpreter AppleScript
EventType = Process.Start
Tag = proc-start-macos-scripting-interpreter-applescript
RiskScore = 50
Annotation = {"mitre_attack": ["T1059.002"]}
Query = Process.Path like "%/osascript" and (Process.CommandLine like "% -e %" or Process.CommandLine like "%.scpt%" or Process.CommandLine like "%.js%")


[ActivityMonitoringRule platform=MacOS]
# Detects when a built-in utility is used to decode and decrypt a payload after a macOS disk image (DMG) is executed. Malware authors may attempt to evade detection and trick users into executing malicious code by encoding and encrypting their payload and placing it in a disk image file. This behavior is consistent with adware or malware families such as Bundlore and Shlayer.
# Author: Tim Rauch (rule), Elastic (idea)
RuleId = 234dc5df-40b5-49d1-bf53-0d44ce778eca
RuleName = Payload Decoded and Decrypted via Built-in Utilities
EventType = Process.Start
Tag = proc-start-payload-decoded-and-decrypted-via-built-in-utilities
RiskScore = 50
Annotation = {"mitre_attack": ["T1059", "T1204", "T1140"]}
Query = Process.Path like "%/openssl" and Process.CommandLine like "%/Volumes/%" and Process.CommandLine like "%enc%" and Process.CommandLine like "%-base64%" and Process.CommandLine like "% -d %"


[ActivityMonitoringRule platform=MacOS]
# Detects passwords dumps from Keychain
# Author: Tim Ismilyaev, oscd.community, Florian Roth (Nextron Systems)
RuleId = b120b587-a4c2-4b94-875d-99c9807d6955
RuleName = Credentials from Password Stores - Keychain
EventType = Process.Start
Tag = proc-start-credentials-from-password-stores-keychain
RiskScore = 50
Annotation = {"mitre_attack": ["T1555.001"]}
Query = Process.Path == "/usr/bin/security" and (Process.CommandLine like "%find-certificate%" or Process.CommandLine like "% export %") or Process.CommandLine like "% dump-keychain %" or Process.CommandLine like "% login-keychain %"


[ActivityMonitoringRule platform=MacOS]
# Detects when a user manipulates with Firmward Password on MacOS. NOTE - this command has been disabled on silicon-based apple computers.
# Author: Austin Songer @austinsonger
RuleId = 7ed2c9f7-c59d-4c82-a7e2-f859aa676099
RuleName = Suspicious MacOS Firmware Activity
EventType = Process.Start
Tag = proc-start-suspicious-macos-firmware-activity
RiskScore = 50
Query = Process.Path == "/usr/sbin/firmwarepasswd" and (Process.CommandLine like "%setpasswd%" or Process.CommandLine like "%full%" or Process.CommandLine like "%delete%" or Process.CommandLine like "%check%")


[ActivityMonitoringRule platform=MacOS]
# Detects commandline operations on shell history files
# Author: Mikhail Larin, oscd.community
RuleId = 508a9374-ad52-4789-b568-fc358def2c65
RuleName = Suspicious History File Operations
EventType = Process.Start
Tag = proc-start-suspicious-history-file-operations
RiskScore = 50
Annotation = {"mitre_attack": ["T1552.003"]}
Query = Process.CommandLine like "%.bash\_history%" or Process.CommandLine like "%.zsh\_history%" or Process.CommandLine like "%.zhistory%" or Process.CommandLine like "%.history%" or Process.CommandLine like "%.sh\_history%" or Process.CommandLine like "%fish\_history%"


[ActivityMonitoringRule platform=MacOS]
# Detects when the macOS Script Editor utility spawns an unusual child process.
# Author: Tim Rauch (rule), Elastic (idea)
RuleId = 6e4dcdd1-e48b-42f7-b2d8-3b413fc58cb4
RuleName = Suspicious Execution via macOS Script Editor
EventType = Process.Start
Tag = proc-start-suspicious-execution-via-macos-script-editor
RiskScore = 50
Annotation = {"mitre_attack": ["T1566", "T1566.002", "T1059", "T1059.002", "T1204", "T1204.001", "T1553"]}
Query = Parent.Path like "%/Script Editor" and (Process.Path like "%/curl" or Process.Path like "%/bash" or Process.Path like "%/sh" or Process.Path like "%/zsh" or Process.Path like "%/dash" or Process.Path like "%/fish" or Process.Path like "%/osascript" or Process.Path like "%/mktemp" or Process.Path like "%/chmod" or Process.Path like "%/php" or Process.Path like "%/nohup" or Process.Path like "%/openssl" or Process.Path like "%/plutil" or Process.Path like "%/PlistBuddy" or Process.Path like "%/xattr" or Process.Path like "%/sqlite" or Process.Path like "%/funzip" or Process.Path like "%/popen" or Process.Path like "%python%" or Process.Path like "%perl%")
GenericProperty1 = Parent.Path


[ActivityMonitoringRule platform=MacOS]
# Detects usage of system utilities (only grep for now) to discover security software discovery
# Author: Daniil Yugoslavskiy, oscd.community
RuleId = 0ed75b9c-c73b-424d-9e7d-496cd565fbe0
RuleName = Security Software Discovery - MacOs
EventType = Process.Start
Tag = proc-start-security-software-discovery-macos
RiskScore = 50
Annotation = {"mitre_attack": ["T1518.001"]}
Query = Process.Path == "/usr/bin/grep" and (Process.CommandLine like "%nessusd%" or Process.CommandLine like "%santad%" or Process.CommandLine like "%CbDefense%" or Process.CommandLine like "%falcond%" or Process.CommandLine like "%td-agent%" or Process.CommandLine like "%packetbeat%" or Process.CommandLine like "%filebeat%" or Process.CommandLine like "%auditbeat%" or Process.CommandLine like "%osqueryd%" or Process.CommandLine like "%BlockBlock%" or Process.CommandLine like "%LuLu%" or Process.CommandLine like "%Little%" and Process.CommandLine like "%Snitch%")


[ActivityMonitoringRule platform=MacOS]
# Detects potential in-memory downloading and compiling of applets using curl and osacompile as seen used by XCSSET malware
# Author: Sohan G (D4rkCiph3r), Red Canary (idea)
RuleId = 13db8d2e-7723-4c2c-93c1-a4d36994f7ef
RuleName = Potential In-Memory Download And Compile Of Payloads
EventType = Process.Start
Tag = proc-start-potential-in-memory-download-and-compile-of-payloads
RiskScore = 50
Annotation = {"mitre_attack": ["T1059.007", "T1105"]}
Query = Process.CommandLine like "%osacompile%" and Process.CommandLine like "%curl%"


[ActivityMonitoringRule platform=MacOS]
# Detects creation of a hidden user account on macOS (UserID < 500) or with IsHidden option
# Author: Daniil Yugoslavskiy, oscd.community
RuleId = b22a5b36-2431-493a-8be1-0bae56c28ef3
RuleName = Hidden User Creation
EventType = Process.Start
Tag = proc-start-hidden-user-creation
RiskScore = 50
Annotation = {"mitre_attack": ["T1564.002"]}
Query = Process.Path like "%/dscl" and Process.CommandLine like "%create%" and Process.CommandLine like "%UniqueID%" and regex_match(Process.CommandLine, "([0-9]|[1-9][0-9]|[1-4][0-9]{2})") or Process.Path like "%/dscl" and Process.CommandLine like "%create%" and Process.CommandLine like "%IsHidden%" and (Process.CommandLine like "%true%" or Process.CommandLine like "%yes%" or Process.CommandLine like "%1%")


[ActivityMonitoringRule platform=MacOS]
# Detects disabling security tools
# Author: Daniil Yugoslavskiy, oscd.community
RuleId = ff39f1a6-84ac-476f-a1af-37fcdf53d7c0
RuleName = Disable Security Tools
EventType = Process.Start
Tag = proc-start-disable-security-tools
RiskScore = 50
Annotation = {"mitre_attack": ["T1562.001"]}
Query = Process.Path == "/bin/launchctl" and Process.CommandLine like "%unload%" and (Process.CommandLine like "%com.objective-see.lulu.plist%" or Process.CommandLine like "%com.objective-see.blockblock.plist%" or Process.CommandLine like "%com.google.santad.plist%" or Process.CommandLine like "%com.carbonblack.defense.daemon.plist%" or Process.CommandLine like "%com.carbonblack.daemon.plist%" or Process.CommandLine like "%at.obdev.littlesnitchd.plist%" or Process.CommandLine like "%com.tenablesecurity.nessusagent.plist%" or Process.CommandLine like "%com.opendns.osx.RoamingClientConfigUpdater.plist%" or Process.CommandLine like "%com.crowdstrike.falcond.plist%" or Process.CommandLine like "%com.crowdstrike.userdaemon.plist%" or Process.CommandLine like "%osquery%" or Process.CommandLine like "%filebeat%" or Process.CommandLine like "%auditbeat%" or Process.CommandLine like "%packetbeat%" or Process.CommandLine like "%td-agent%") or Process.Path == "/usr/sbin/spctl" and Process.CommandLine like "%disable%"


[ActivityMonitoringRule platform=MacOS]
# Detects attempts to create and add an account to the admin group via "dscl"
# Author: Sohan G (D4rkCiph3r)
RuleId = b743623c-2776-40e0-87b1-682b975d0ca5
RuleName = User Added To Admin Group Via Dscl
EventType = Process.Start
Tag = proc-start-user-added-to-admin-group-via-dscl
RiskScore = 50
Annotation = {"mitre_attack": ["T1078.003"]}
Query = Process.Path like "%/dscl" and Process.CommandLine like "% -append %" and Process.CommandLine like "% /Groups/admin %" and Process.CommandLine like "% GroupMembership %"


[ActivityMonitoringRule platform=MacOS]
# Detects usage of "find" binary in a suspicious manner to perform discovery
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = 85de3a19-b675-4a51-bfc6-b11a5186c971
RuleName = Potential Discovery Activity Using Find - MacOS
EventType = Process.Start
Tag = proc-start-potential-discovery-activity-using-find-macos
RiskScore = 50
Annotation = {"mitre_attack": ["T1083"]}
Query = Process.Path like "%/find" and (Process.CommandLine like "%-perm -4000%" or Process.CommandLine like "%-perm -2000%" or Process.CommandLine like "%-perm 0777%" or Process.CommandLine like "%-perm -222%" or Process.CommandLine like "%-perm -o w%" or Process.CommandLine like "%-perm -o x%" or Process.CommandLine like "%-perm -u=s%" or Process.CommandLine like "%-perm -g=s%")


[ActivityMonitoringRule platform=MacOS]
# Detects attempts to create and add an account to the admin group via "sysadminctl"
# Author: Sohan G (D4rkCiph3r)
RuleId = 652c098d-dc11-4ba6-8566-c20e89042f2b
RuleName = User Added To Admin Group Via Sysadminctl
EventType = Process.Start
Tag = proc-start-user-added-to-admin-group-via-sysadminctl
RiskScore = 50
Annotation = {"mitre_attack": ["T1078.003"]}
Query = Process.Path like "%/sysadminctl" and Process.CommandLine like "% -addUser %" and Process.CommandLine like "% -admin %"


[ActivityMonitoringRule platform=MacOS]
# Detects attempts to enable the root account via "dsenableroot"
# Author: Sohan G (D4rkCiph3r)
RuleId = 821bcf4d-46c7-4b87-bc57-9509d3ba7c11
RuleName = Root Account Enable Via Dsenableroot
EventType = Process.Start
Tag = proc-start-root-account-enable-via-dsenableroot
RiskScore = 50
Annotation = {"mitre_attack": ["T1078", "T1078.001", "T1078.003"]}
Query = Process.Path like "%/dsenableroot" and not Process.CommandLine like "% -d %"


[ActivityMonitoringRule platform=MacOS]
# Detect file time attribute change to hide new or changes to existing files
# Author: Igor Fits, Mikhail Larin, oscd.community
RuleId = 88c0f9d8-30a8-4120-bb6b-ebb54abcf2a0
RuleName = File Time Attribute Change
EventType = Process.Start
Tag = proc-start-file-time-attribute-change
RiskScore = 50
Annotation = {"mitre_attack": ["T1070.006"]}
Query = Process.Path like "%/touch" and (Process.CommandLine like "%-t%" or Process.CommandLine like "%-acmr%" or Process.CommandLine like "%-d%" or Process.CommandLine like "%-r%")


[ActivityMonitoringRule platform=MacOS]
# Detects abuse of the cron utility to perform task scheduling for initial or recurring execution of malicious code. Detection will focus on crontab jobs uploaded from the tmp folder.
# Author: Alejandro Ortuno, oscd.community
RuleId = 7c3b43d8-d794-47d2-800a-d277715aa460
RuleName = Scheduled Cron Task/Job - MacOs
EventType = Process.Start
Tag = proc-start-scheduled-cron-task/job-macos
RiskScore = 50
Annotation = {"mitre_attack": ["T1053.003"]}
Query = Process.Path like "%/crontab" and Process.CommandLine like "%/tmp/%"


[ActivityMonitoringRule platform=MacOS]
# Detects suspicious child processes spawned from browsers. This could be a result of a potential web browser exploitation.
# Author: Sohan G (D4rkCiph3r)
RuleId = 0250638a-2b28-4541-86fc-ea4c558fa0c6
RuleName = Suspicious Browser Child Process - MacOS
EventType = Process.Start
Tag = proc-start-suspicious-browser-child-process-macos
RiskScore = 50
Annotation = {"mitre_attack": ["T1189", "T1203", "T1059"]}
Query = (Parent.Path like "%com.apple.WebKit.WebContent%" or Parent.Path like "%firefox%" or Parent.Path like "%Google Chrome Helper%" or Parent.Path like "%Google Chrome%" or Parent.Path like "%Microsoft Edge%" or Parent.Path like "%Opera%" or Parent.Path like "%Safari%" or Parent.Path like "%Tor Browser%") and (Process.Path like "%/bash" or Process.Path like "%/curl" or Process.Path like "%/dash" or Process.Path like "%/ksh" or Process.Path like "%/osascript" or Process.Path like "%/perl" or Process.Path like "%/php" or Process.Path like "%/pwsh" or Process.Path like "%/python" or Process.Path like "%/sh" or Process.Path like "%/tcsh" or Process.Path like "%/wget" or Process.Path like "%/zsh") and not (Process.CommandLine like "%--defaults-torrc%" or Process.CommandLine like "%/Library/Application Support/Microsoft/MAU%/Microsoft AutoUpdate.app/Contents/MacOS/msupdate%" or (Parent.Path like "%Google Chrome Helper%" or Parent.Path like "%Google Chrome%") and (Process.CommandLine like "%/Volumes/Google Chrome/Google Chrome.app/Contents/Frameworks/%/Resources/install.sh%" or Process.CommandLine like "%/Applications/Google Chrome.app/Contents/Frameworks/Google Chrome Framework.framework/%/Resources/keystone\_promote\_preflight.sh%" or Process.CommandLine like "%/Applications/Google Chrome.app/Contents/Frameworks/Google Chrome Framework.framework/%/Resources/keystone\_promote\_postflight.sh%") or Parent.Path like "%Microsoft Edge%" and (Process.CommandLine like "%IOPlatformExpertDevice%" or Process.CommandLine like "%hw.model%") or (Parent.Path like "%Google Chrome Helper%" or Parent.Path like "%Google Chrome%") and Process.CommandLine like "%/Users/%" and Process.CommandLine like "%/Library/Application Support/Google/Chrome/recovery/%" and Process.CommandLine like "%/ChromeRecovery%") and not (isnull(Process.CommandLine) or Process.CommandLine == "")
GenericProperty1 = Parent.Path


[ActivityMonitoringRule platform=MacOS]
# Detects potential suspicious child processes of "jamf". Could be a sign of potential abuse of Jamf as a C2 server as seen by Typhon MythicAgent.
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = 2316929c-01aa-438c-970f-099145ab1ee6
RuleName = JAMF MDM Potential Suspicious Child Process
EventType = Process.Start
Tag = proc-start-jamf-mdm-potential-suspicious-child-process
RiskScore = 50
Query = Parent.Path like "%/jamf" and (Process.Path like "%/bash" or Process.Path like "%/sh")
GenericProperty1 = Parent.Path


[ActivityMonitoringRule platform=MacOS]
# Identifies the execution traces of the XCSSET malware. XCSSET is a macOS trojan that primarily spreads via Xcode projects and maliciously modifies applications. Infected users are also vulnerable to having their credentials, accounts, and other vital data stolen.
# Author: Tim Rauch (rule), Elastic (idea)
RuleId = 47d65ac0-c06f-4ba2-a2e3-d263139d0f51
RuleName = Potential XCSSET Malware Infection
EventType = Process.Start
Tag = proc-start-potential-xcsset-malware-infection
RiskScore = 50
Query = Parent.Path like "%/bash" and Process.Path like "%/curl" and (Process.CommandLine like "%/sys/log.php%" or Process.CommandLine like "%/sys/prepod.php%" or Process.CommandLine like "%/sys/bin/Pods%") and Process.CommandLine like "%https://%" or Parent.Path like "%/bash" and Process.Path like "%/osacompile" and Process.CommandLine like "%/Users/%" and Process.CommandLine like "%/Library/Group Containers/%" or Parent.Path like "%/bash" and Process.Path like "%/plutil" and Process.CommandLine like "%LSUIElement%" and Process.CommandLine like "%/Users/%" and Process.CommandLine like "%/Library/Group Containers/%" or Process.Path like "%/zip" and Process.CommandLine like "%-r%" and Process.CommandLine like "%/Users/%" and Process.CommandLine like "%/Library/Group Containers/%"
GenericProperty1 = Parent.Path


[ActivityMonitoringRule platform=MacOS]
# Detects attempts to create and/or add an account to the admin group, thus granting admin privileges.
# Author: Sohan G (D4rkCiph3r)
RuleId = 5d0fdb62-f225-42fb-8402-3dfe64da468a
RuleName = User Added To Admin Group Via DseditGroup
EventType = Process.Start
Tag = proc-start-user-added-to-admin-group-via-dseditgroup
RiskScore = 50
Annotation = {"mitre_attack": ["T1078.003"]}
Query = Process.Path like "%/dseditgroup" and Process.CommandLine like "% -o edit %" and Process.CommandLine like "% -a %" and Process.CommandLine like "% -t user%" and Process.CommandLine like "%admin%"


[ActivityMonitoringRule platform=MacOS]
# Detects deletion of local audit logs
# Author: remotephone, oscd.community
RuleId = acf61bd8-d814-4272-81f0-a7a269aa69aa
RuleName = Indicator Removal on Host - Clear Mac System Logs
EventType = Process.Start
Tag = proc-start-indicator-removal-on-host-clear-mac-system-logs
RiskScore = 50
Annotation = {"mitre_attack": ["T1070.002"]}
Query = (Process.Path like "%/rm" or Process.Path like "%/unlink" or Process.Path like "%/shred") and (Process.CommandLine like "%/var/log%" or Process.CommandLine like "%/Users/%" and Process.CommandLine like "%/Library/Logs/%")


[ActivityMonitoringRule platform=MacOS]
# Detects the execution of suspicious child processes from macOS installer package parent process. This includes osascript, JXA, curl and wget amongst other interpreters
# Author: Sohan G (D4rkCiph3r)
RuleId = e0cfaecd-602d-41af-988d-f6ccebb2af26
RuleName = Suspicious Installer Package Child Process
EventType = Process.Start
Tag = proc-start-suspicious-installer-package-child-process
RiskScore = 50
Annotation = {"mitre_attack": ["T1059", "T1059.007", "T1071", "T1071.001"]}
Query = (Parent.Path like "%/package\_script\_service" or Parent.Path like "%/installer") and (Process.Path like "%/sh" or Process.Path like "%/bash" or Process.Path like "%/dash" or Process.Path like "%/python" or Process.Path like "%/ruby" or Process.Path like "%/perl" or Process.Path like "%/php" or Process.Path like "%/javascript" or Process.Path like "%/osascript" or Process.Path like "%/tclsh" or Process.Path like "%/curl" or Process.Path like "%/wget") and (Process.CommandLine like "%preinstall%" or Process.CommandLine like "%postinstall%")
GenericProperty1 = Parent.Path


[ActivityMonitoringRule platform=MacOS]
# Detects potential suspicious applet or osascript executing "osacompile".
# Author: Sohan G (D4rkCiph3r), Red Canary (Idea)
RuleId = a753a6af-3126-426d-8bd0-26ebbcb92254
RuleName = Osacompile Execution By Potentially Suspicious Applet/Osascript
EventType = Process.Start
Tag = proc-start-osacompile-execution-by-potentially-suspicious-applet/osascript
RiskScore = 50
Annotation = {"mitre_attack": ["T1059.002"]}
Query = (Parent.Path like "%/applet" or Parent.Path like "%/osascript") and Process.CommandLine like "%osacompile%"
GenericProperty1 = Parent.Path

