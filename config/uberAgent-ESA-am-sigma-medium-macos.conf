
#
# The rules are generated from the Sigma GitHub repository at https://github.com/SigmaHQ/sigma
# To generate the ruleset, please follow the instructions provided in the repository: https://github.com/vastlimits/pySigma-backend-uberAgent/
#
# The command used to generate the ruleset is:
#    sigma convert -s -f conf -p uberagent-7.1.0 -t uberagent /home/runner/work/uberAgent-config/uberAgent-config/build/sigma-medium-macos >> uberAgent-ESA-am-sigma-medium-macos.conf
#

[ActivityMonitoringRule platform=MacOS]
# Detects execution of AppleScript of the macOS scripting language AppleScript.
# Author: Alejandro Ortuno, oscd.community
RuleId = 1bc2e6c5-0885-472b-bed6-be5ea8eace55
RuleName = MacOS Scripting Interpreter AppleScript
EventType = Process.Start
Tag = proc-start-macos-scripting-interpreter-applescript
RiskScore = 50
Annotation = {"mitre_attack": ["T1059.002"]}
Query = iendswith(Process.Path, "/osascript") and (icontains(Process.CommandLine, " -e ") or icontains(Process.CommandLine, ".scpt") or icontains(Process.CommandLine, ".js"))


[ActivityMonitoringRule platform=MacOS]
# Detects creation of a hidden user account on macOS (UserID < 500) or with IsHidden option
# Author: Daniil Yugoslavskiy, oscd.community
RuleId = b22a5b36-2431-493a-8be1-0bae56c28ef3
RuleName = Hidden User Creation
EventType = Process.Start
Tag = proc-start-hidden-user-creation
RiskScore = 50
Annotation = {"mitre_attack": ["T1564.002"]}
Query = iendswith(Process.Path, "/dscl") and icontains(Process.CommandLine, "create") and icontains(Process.CommandLine, "UniqueID") and regex_match(Process.CommandLine, r"([0-9]|[1-9][0-9]|[1-4][0-9]{2})") or iendswith(Process.Path, "/dscl") and icontains(Process.CommandLine, "create") and icontains(Process.CommandLine, "IsHidden") and (icontains(Process.CommandLine, "true") or icontains(Process.CommandLine, "yes") or icontains(Process.CommandLine, "1"))


[ActivityMonitoringRule platform=MacOS]
# Detects when a built-in utility is used to decode and decrypt a payload after a macOS disk image (DMG) is executed. Malware authors may attempt to evade detection and trick users into executing malicious code by encoding and encrypting their payload and placing it in a disk image file. This behavior is consistent with adware or malware families such as Bundlore and Shlayer.
# Author: Tim Rauch (rule), Elastic (idea)
RuleId = 234dc5df-40b5-49d1-bf53-0d44ce778eca
RuleName = Payload Decoded and Decrypted via Built-in Utilities
EventType = Process.Start
Tag = proc-start-payload-decoded-and-decrypted-via-built-in-utilities
RiskScore = 50
Annotation = {"mitre_attack": ["T1059", "T1204", "T1140"]}
Query = iendswith(Process.Path, "/openssl") and icontains(Process.CommandLine, "/Volumes/") and icontains(Process.CommandLine, "enc") and icontains(Process.CommandLine, "-base64") and icontains(Process.CommandLine, " -d ")


[ActivityMonitoringRule platform=MacOS]
# Detects when the macOS Script Editor utility spawns an unusual child process.
# Author: Tim Rauch (rule), Elastic (idea)
RuleId = 6e4dcdd1-e48b-42f7-b2d8-3b413fc58cb4
RuleName = Suspicious Execution via macOS Script Editor
EventType = Process.Start
Tag = proc-start-suspicious-execution-via-macos-script-editor
RiskScore = 50
Annotation = {"mitre_attack": ["T1566", "T1566.002", "T1059", "T1059.002", "T1204", "T1204.001", "T1553"]}
Query = iendswith(Parent.Path, "/Script Editor") and (iendswith(Process.Path, "/curl") or iendswith(Process.Path, "/bash") or iendswith(Process.Path, "/sh") or iendswith(Process.Path, "/zsh") or iendswith(Process.Path, "/dash") or iendswith(Process.Path, "/fish") or iendswith(Process.Path, "/osascript") or iendswith(Process.Path, "/mktemp") or iendswith(Process.Path, "/chmod") or iendswith(Process.Path, "/php") or iendswith(Process.Path, "/nohup") or iendswith(Process.Path, "/openssl") or iendswith(Process.Path, "/plutil") or iendswith(Process.Path, "/PlistBuddy") or iendswith(Process.Path, "/xattr") or iendswith(Process.Path, "/sqlite") or iendswith(Process.Path, "/funzip") or iendswith(Process.Path, "/popen") or icontains(Process.Path, "python") or icontains(Process.Path, "perl"))
GenericProperty1 = Parent.Path


[ActivityMonitoringRule platform=MacOS]
# Detects passwords dumps from Keychain
# Author: Tim Ismilyaev, oscd.community, Florian Roth (Nextron Systems)
RuleId = b120b587-a4c2-4b94-875d-99c9807d6955
RuleName = Credentials from Password Stores - Keychain
EventType = Process.Start
Tag = proc-start-credentials-from-password-stores-keychain
RiskScore = 50
Annotation = {"mitre_attack": ["T1555.001"]}
Query = Process.Path == "/usr/bin/security" and (icontains(Process.CommandLine, "find-certificate") or icontains(Process.CommandLine, " export ")) or icontains(Process.CommandLine, " dump-keychain ") or icontains(Process.CommandLine, " login-keychain ")


[ActivityMonitoringRule platform=MacOS]
# Detects the execution of suspicious child processes from macOS installer package parent process. This includes osascript, JXA, curl and wget amongst other interpreters
# Author: Sohan G (D4rkCiph3r)
RuleId = e0cfaecd-602d-41af-988d-f6ccebb2af26
RuleName = Suspicious Installer Package Child Process
EventType = Process.Start
Tag = proc-start-suspicious-installer-package-child-process
RiskScore = 50
Annotation = {"mitre_attack": ["T1059", "T1059.007", "T1071", "T1071.001"]}
Query = (iendswith(Parent.Path, "/package_script_service") or iendswith(Parent.Path, "/installer")) and (iendswith(Process.Path, "/sh") or iendswith(Process.Path, "/bash") or iendswith(Process.Path, "/dash") or iendswith(Process.Path, "/python") or iendswith(Process.Path, "/ruby") or iendswith(Process.Path, "/perl") or iendswith(Process.Path, "/php") or iendswith(Process.Path, "/javascript") or iendswith(Process.Path, "/osascript") or iendswith(Process.Path, "/tclsh") or iendswith(Process.Path, "/curl") or iendswith(Process.Path, "/wget")) and (icontains(Process.CommandLine, "preinstall") or icontains(Process.CommandLine, "postinstall"))
GenericProperty1 = Parent.Path


[ActivityMonitoringRule platform=MacOS]
# Detects disabling security tools
# Author: Daniil Yugoslavskiy, oscd.community
RuleId = ff39f1a6-84ac-476f-a1af-37fcdf53d7c0
RuleName = Disable Security Tools
EventType = Process.Start
Tag = proc-start-disable-security-tools
RiskScore = 50
Annotation = {"mitre_attack": ["T1562.001"]}
Query = Process.Path == "/bin/launchctl" and icontains(Process.CommandLine, "unload") and (icontains(Process.CommandLine, "com.objective-see.lulu.plist") or icontains(Process.CommandLine, "com.objective-see.blockblock.plist") or icontains(Process.CommandLine, "com.google.santad.plist") or icontains(Process.CommandLine, "com.carbonblack.defense.daemon.plist") or icontains(Process.CommandLine, "com.carbonblack.daemon.plist") or icontains(Process.CommandLine, "at.obdev.littlesnitchd.plist") or icontains(Process.CommandLine, "com.tenablesecurity.nessusagent.plist") or icontains(Process.CommandLine, "com.opendns.osx.RoamingClientConfigUpdater.plist") or icontains(Process.CommandLine, "com.crowdstrike.falcond.plist") or icontains(Process.CommandLine, "com.crowdstrike.userdaemon.plist") or icontains(Process.CommandLine, "osquery") or icontains(Process.CommandLine, "filebeat") or icontains(Process.CommandLine, "auditbeat") or icontains(Process.CommandLine, "packetbeat") or icontains(Process.CommandLine, "td-agent")) or Process.Path == "/usr/sbin/spctl" and icontains(Process.CommandLine, "disable")


[ActivityMonitoringRule platform=MacOS]
# Detects potential in-memory downloading and compiling of applets using curl and osacompile as seen used by XCSSET malware
# Author: Sohan G (D4rkCiph3r), Red Canary (idea)
RuleId = 13db8d2e-7723-4c2c-93c1-a4d36994f7ef
RuleName = Potential In-Memory Download And Compile Of Payloads
EventType = Process.Start
Tag = proc-start-potential-in-memory-download-and-compile-of-payloads
RiskScore = 50
Annotation = {"mitre_attack": ["T1059.007", "T1105"]}
Query = icontains(Process.CommandLine, "osacompile") and icontains(Process.CommandLine, "curl")


[ActivityMonitoringRule platform=MacOS]
# Detects abuse of the cron utility to perform task scheduling for initial or recurring execution of malicious code. Detection will focus on crontab jobs uploaded from the tmp folder.
# Author: Alejandro Ortuno, oscd.community
RuleId = 7c3b43d8-d794-47d2-800a-d277715aa460
RuleName = Scheduled Cron Task/Job - MacOs
EventType = Process.Start
Tag = proc-start-scheduled-cron-task/job-macos
RiskScore = 50
Annotation = {"mitre_attack": ["T1053.003"]}
Query = iendswith(Process.Path, "/crontab") and icontains(Process.CommandLine, "/tmp/")


[ActivityMonitoringRule platform=MacOS]
# Detects attempts to create and add an account to the admin group via "dscl"
# Author: Sohan G (D4rkCiph3r)
RuleId = b743623c-2776-40e0-87b1-682b975d0ca5
RuleName = User Added To Admin Group Via Dscl
EventType = Process.Start
Tag = proc-start-user-added-to-admin-group-via-dscl
RiskScore = 50
Annotation = {"mitre_attack": ["T1078.003"]}
Query = iendswith(Process.Path, "/dscl") and icontains(Process.CommandLine, " -append ") and icontains(Process.CommandLine, " /Groups/admin ") and icontains(Process.CommandLine, " GroupMembership ")


[ActivityMonitoringRule platform=MacOS]
# Identifies the execution traces of the XCSSET malware. XCSSET is a macOS trojan that primarily spreads via Xcode projects and maliciously modifies applications. Infected users are also vulnerable to having their credentials, accounts, and other vital data stolen.
# Author: Tim Rauch (rule), Elastic (idea)
RuleId = 47d65ac0-c06f-4ba2-a2e3-d263139d0f51
RuleName = Potential XCSSET Malware Infection
EventType = Process.Start
Tag = proc-start-potential-xcsset-malware-infection
RiskScore = 50
Query = iendswith(Parent.Path, "/bash") and iendswith(Process.Path, "/curl") and (icontains(Process.CommandLine, "/sys/log.php") or icontains(Process.CommandLine, "/sys/prepod.php") or icontains(Process.CommandLine, "/sys/bin/Pods")) and icontains(Process.CommandLine, "https://") or iendswith(Parent.Path, "/bash") and iendswith(Process.Path, "/osacompile") and icontains(Process.CommandLine, "/Users/") and icontains(Process.CommandLine, "/Library/Group Containers/") or iendswith(Parent.Path, "/bash") and iendswith(Process.Path, "/plutil") and icontains(Process.CommandLine, "LSUIElement") and icontains(Process.CommandLine, "/Users/") and icontains(Process.CommandLine, "/Library/Group Containers/") or iendswith(Process.Path, "/zip") and icontains(Process.CommandLine, "-r") and icontains(Process.CommandLine, "/Users/") and icontains(Process.CommandLine, "/Library/Group Containers/")
GenericProperty1 = Parent.Path


[ActivityMonitoringRule platform=MacOS]
# Detects potential suspicious child processes of "jamf". Could be a sign of potential abuse of Jamf as a C2 server as seen by Typhon MythicAgent.
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = 2316929c-01aa-438c-970f-099145ab1ee6
RuleName = JAMF MDM Potential Suspicious Child Process
EventType = Process.Start
Tag = proc-start-jamf-mdm-potential-suspicious-child-process
RiskScore = 50
Query = iendswith(Parent.Path, "/jamf") and (iendswith(Process.Path, "/bash") or iendswith(Process.Path, "/sh"))
GenericProperty1 = Parent.Path


[ActivityMonitoringRule platform=MacOS]
# Detects when a user manipulates with Firmward Password on MacOS. NOTE - this command has been disabled on silicon-based apple computers.
# Author: Austin Songer @austinsonger
RuleId = 7ed2c9f7-c59d-4c82-a7e2-f859aa676099
RuleName = Suspicious MacOS Firmware Activity
EventType = Process.Start
Tag = proc-start-suspicious-macos-firmware-activity
RiskScore = 50
Query = Process.Path == "/usr/sbin/firmwarepasswd" and (icontains(Process.CommandLine, "setpasswd") or icontains(Process.CommandLine, "full") or icontains(Process.CommandLine, "delete") or icontains(Process.CommandLine, "check"))


[ActivityMonitoringRule platform=MacOS]
# Detect file time attribute change to hide new or changes to existing files
# Author: Igor Fits, Mikhail Larin, oscd.community
RuleId = 88c0f9d8-30a8-4120-bb6b-ebb54abcf2a0
RuleName = File Time Attribute Change
EventType = Process.Start
Tag = proc-start-file-time-attribute-change
RiskScore = 50
Annotation = {"mitre_attack": ["T1070.006"]}
Query = iendswith(Process.Path, "/touch") and (icontains(Process.CommandLine, "-t") or icontains(Process.CommandLine, "-acmr") or icontains(Process.CommandLine, "-d") or icontains(Process.CommandLine, "-r"))


[ActivityMonitoringRule platform=MacOS]
# Detects attempts to create and add an account to the admin group via "sysadminctl"
# Author: Sohan G (D4rkCiph3r)
RuleId = 652c098d-dc11-4ba6-8566-c20e89042f2b
RuleName = User Added To Admin Group Via Sysadminctl
EventType = Process.Start
Tag = proc-start-user-added-to-admin-group-via-sysadminctl
RiskScore = 50
Annotation = {"mitre_attack": ["T1078.003"]}
Query = iendswith(Process.Path, "/sysadminctl") and icontains(Process.CommandLine, " -addUser ") and icontains(Process.CommandLine, " -admin ")


[ActivityMonitoringRule platform=MacOS]
# Detects potential suspicious applet or osascript executing "osacompile".
# Author: Sohan G (D4rkCiph3r), Red Canary (Idea)
RuleId = a753a6af-3126-426d-8bd0-26ebbcb92254
RuleName = Osacompile Execution By Potentially Suspicious Applet/Osascript
EventType = Process.Start
Tag = proc-start-osacompile-execution-by-potentially-suspicious-applet/osascript
RiskScore = 50
Annotation = {"mitre_attack": ["T1059.002"]}
Query = (iendswith(Parent.Path, "/applet") or iendswith(Parent.Path, "/osascript")) and icontains(Process.CommandLine, "osacompile")
GenericProperty1 = Parent.Path


[ActivityMonitoringRule platform=MacOS]
# Detects attempts to create and/or add an account to the admin group, thus granting admin privileges.
# Author: Sohan G (D4rkCiph3r)
RuleId = 5d0fdb62-f225-42fb-8402-3dfe64da468a
RuleName = User Added To Admin Group Via DseditGroup
EventType = Process.Start
Tag = proc-start-user-added-to-admin-group-via-dseditgroup
RiskScore = 50
Annotation = {"mitre_attack": ["T1078.003"]}
Query = iendswith(Process.Path, "/dseditgroup") and icontains(Process.CommandLine, " -o edit ") and icontains(Process.CommandLine, " -a ") and icontains(Process.CommandLine, " -t user") and icontains(Process.CommandLine, "admin")


[ActivityMonitoringRule platform=MacOS]
# Detects deletion of local audit logs
# Author: remotephone, oscd.community
RuleId = acf61bd8-d814-4272-81f0-a7a269aa69aa
RuleName = Indicator Removal on Host - Clear Mac System Logs
EventType = Process.Start
Tag = proc-start-indicator-removal-on-host-clear-mac-system-logs
RiskScore = 50
Annotation = {"mitre_attack": ["T1070.002"]}
Query = (iendswith(Process.Path, "/rm") or iendswith(Process.Path, "/unlink") or iendswith(Process.Path, "/shred")) and (icontains(Process.CommandLine, "/var/log") or icontains(Process.CommandLine, "/Users/") and icontains(Process.CommandLine, "/Library/Logs/"))


[ActivityMonitoringRule platform=MacOS]
# Detects commandline operations on shell history files
# Author: Mikhail Larin, oscd.community
RuleId = 508a9374-ad52-4789-b568-fc358def2c65
RuleName = Suspicious History File Operations
EventType = Process.Start
Tag = proc-start-suspicious-history-file-operations
RiskScore = 50
Annotation = {"mitre_attack": ["T1552.003"]}
Query = icontains(Process.CommandLine, ".bash_history") or icontains(Process.CommandLine, ".zsh_history") or icontains(Process.CommandLine, ".zhistory") or icontains(Process.CommandLine, ".history") or icontains(Process.CommandLine, ".sh_history") or icontains(Process.CommandLine, "fish_history")


[ActivityMonitoringRule platform=MacOS]
# Detects usage of "find" binary in a suspicious manner to perform discovery
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = 85de3a19-b675-4a51-bfc6-b11a5186c971
RuleName = Potential Discovery Activity Using Find - MacOS
EventType = Process.Start
Tag = proc-start-potential-discovery-activity-using-find-macos
RiskScore = 50
Annotation = {"mitre_attack": ["T1083"]}
Query = iendswith(Process.Path, "/find") and (icontains(Process.CommandLine, "-perm -4000") or icontains(Process.CommandLine, "-perm -2000") or icontains(Process.CommandLine, "-perm 0777") or icontains(Process.CommandLine, "-perm -222") or icontains(Process.CommandLine, "-perm -o w") or icontains(Process.CommandLine, "-perm -o x") or icontains(Process.CommandLine, "-perm -u=s") or icontains(Process.CommandLine, "-perm -g=s"))


[ActivityMonitoringRule platform=MacOS]
# Detects additions to the Emond Launch Daemon that adversaries may use to gain persistence and elevate privileges.
# Author: Alejandro Ortuno, oscd.community
RuleId = 23c43900-e732-45a4-8354-63e4a6c187ce
RuleName = MacOS Emond Launch Daemon
EventType = File.Create
Tag = macos-emond-launch-daemon
RiskScore = 50
Annotation = {"mitre_attack": ["T1546.014"]}
Query = icontains(File.Path, "/etc/emond.d/rules/") and iendswith(File.Path, ".plist") or icontains(File.Path, "/private/var/db/emondClients/")
GenericProperty1 = File.Path


[ActivityMonitoringRule platform=MacOS]
# Detects suspicious child processes spawned from browsers. This could be a result of a potential web browser exploitation.
# Author: Sohan G (D4rkCiph3r)
RuleId = 0250638a-2b28-4541-86fc-ea4c558fa0c6
RuleName = Suspicious Browser Child Process - MacOS
EventType = Process.Start
Tag = proc-start-suspicious-browser-child-process-macos
RiskScore = 50
Annotation = {"mitre_attack": ["T1189", "T1203", "T1059"]}
Query = (icontains(Parent.Path, "com.apple.WebKit.WebContent") or icontains(Parent.Path, "firefox") or icontains(Parent.Path, "Google Chrome Helper") or icontains(Parent.Path, "Google Chrome") or icontains(Parent.Path, "Microsoft Edge") or icontains(Parent.Path, "Opera") or icontains(Parent.Path, "Safari") or icontains(Parent.Path, "Tor Browser")) and (iendswith(Process.Path, "/bash") or iendswith(Process.Path, "/curl") or iendswith(Process.Path, "/dash") or iendswith(Process.Path, "/ksh") or iendswith(Process.Path, "/osascript") or iendswith(Process.Path, "/perl") or iendswith(Process.Path, "/php") or iendswith(Process.Path, "/pwsh") or iendswith(Process.Path, "/python") or iendswith(Process.Path, "/sh") or iendswith(Process.Path, "/tcsh") or iendswith(Process.Path, "/wget") or iendswith(Process.Path, "/zsh")) and not (icontains(Process.CommandLine, "--defaults-torrc") or Process.CommandLine like "*/Library/Application Support/Microsoft/MAU*/Microsoft AutoUpdate.app/Contents/MacOS/msupdate*" or (icontains(Parent.Path, "Google Chrome Helper") or icontains(Parent.Path, "Google Chrome")) and (Process.CommandLine like "*/Volumes/Google Chrome/Google Chrome.app/Contents/Frameworks/*/Resources/install.sh*" or Process.CommandLine like "*/Applications/Google Chrome.app/Contents/Frameworks/Google Chrome Framework.framework/*/Resources/keystone_promote_preflight.sh*" or Process.CommandLine like "*/Applications/Google Chrome.app/Contents/Frameworks/Google Chrome Framework.framework/*/Resources/keystone_promote_postflight.sh*") or icontains(Parent.Path, "Microsoft Edge") and (icontains(Process.CommandLine, "IOPlatformExpertDevice") or icontains(Process.CommandLine, "hw.model")) or (icontains(Parent.Path, "Google Chrome Helper") or icontains(Parent.Path, "Google Chrome")) and icontains(Process.CommandLine, "/Users/") and icontains(Process.CommandLine, "/Library/Application Support/Google/Chrome/recovery/") and icontains(Process.CommandLine, "/ChromeRecovery")) and not (isnull(Process.CommandLine) or Process.CommandLine == "")
GenericProperty1 = Parent.Path


[ActivityMonitoringRule platform=MacOS]
# Detects usage of system utilities (only grep for now) to discover security software discovery
# Author: Daniil Yugoslavskiy, oscd.community
RuleId = 0ed75b9c-c73b-424d-9e7d-496cd565fbe0
RuleName = Security Software Discovery - MacOs
EventType = Process.Start
Tag = proc-start-security-software-discovery-macos
RiskScore = 50
Annotation = {"mitre_attack": ["T1518.001"]}
Query = Process.Path == "/usr/bin/grep" and (icontains(Process.CommandLine, "nessusd") or icontains(Process.CommandLine, "santad") or icontains(Process.CommandLine, "CbDefense") or icontains(Process.CommandLine, "falcond") or icontains(Process.CommandLine, "td-agent") or icontains(Process.CommandLine, "packetbeat") or icontains(Process.CommandLine, "filebeat") or icontains(Process.CommandLine, "auditbeat") or icontains(Process.CommandLine, "osqueryd") or icontains(Process.CommandLine, "BlockBlock") or icontains(Process.CommandLine, "LuLu") or icontains(Process.CommandLine, "Little") and icontains(Process.CommandLine, "Snitch"))


[ActivityMonitoringRule platform=MacOS]
# Detects attempts to enable the root account via "dsenableroot"
# Author: Sohan G (D4rkCiph3r)
RuleId = 821bcf4d-46c7-4b87-bc57-9509d3ba7c11
RuleName = Root Account Enable Via Dsenableroot
EventType = Process.Start
Tag = proc-start-root-account-enable-via-dsenableroot
RiskScore = 50
Annotation = {"mitre_attack": ["T1078", "T1078.001", "T1078.003"]}
Query = iendswith(Process.Path, "/dsenableroot") and not icontains(Process.CommandLine, " -d ")

