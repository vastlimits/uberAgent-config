
#
# The rules are generated from the Sigma GitHub repository at https://github.com/SigmaHQ/sigma
# To generate the ruleset, please follow the instructions provided in the repository: https://github.com/vastlimits/pySigma-backend-uberAgent/
#
# The command used to generate the ruleset is:
#    sigma convert -s -f conf -p uberagent-7.3.0 -O backend_version=7.3.0 -t uberagent /home/runner/work/uberAgent-config/uberAgent-config/build/sigma-medium-macos >> uberAgent-ESA-am-sigma-medium-macos.conf
#

[ThreatDetectionRule platform=MacOS]
# Detects potential suspicious applet or osascript executing "osacompile".
# Author: Sohan G (D4rkCiph3r), Red Canary (Idea)
RuleId = a753a6af-3126-426d-8bd0-26ebbcb92254
RuleName = Osacompile Execution By Potentially Suspicious Applet/Osascript
EventType = Process.Start
Tag = proc-start-osacompile-execution-by-potentially-suspicious-applet/osascript
RiskScore = 50
Annotation = {"mitre_attack": ["T1059.002"], "author": "Sohan G (D4rkCiph3r), Red Canary (Idea)"}
Query = (Parent.Path like r"%/applet" or Parent.Path like r"%/osascript") and Process.CommandLine like r"%osacompile%"
GenericProperty1 = Parent.Path


[ThreatDetectionRule platform=MacOS]
# Detects deletion of local audit logs
# Author: remotephone, oscd.community
RuleId = acf61bd8-d814-4272-81f0-a7a269aa69aa
RuleName = Indicator Removal on Host - Clear Mac System Logs
EventType = Process.Start
Tag = proc-start-indicator-removal-on-host-clear-mac-system-logs
RiskScore = 50
Annotation = {"mitre_attack": ["T1070.002"], "author": "remotephone, oscd.community"}
Query = (Process.Path like r"%/rm" or Process.Path like r"%/unlink" or Process.Path like r"%/shred") and (Process.CommandLine like r"%/var/log%" or Process.CommandLine like r"%/Users/%" and Process.CommandLine like r"%/Library/Logs/%")


[ThreatDetectionRule platform=MacOS]
# Detects the use of "ioreg" which will show I/O Kit registry information.
# This process is used for system information discovery.
# It has been observed in-the-wild by calling this process directly or using bash and grep to look for specific strings.
# Author: Joseliyo Sanchez, @Joseliyo_Jstnk
RuleId = 2d5e7a8b-f484-4a24-945d-7f0efd52eab0
RuleName = System Information Discovery Using Ioreg
EventType = Process.Start
Tag = proc-start-system-information-discovery-using-ioreg
RiskScore = 50
Annotation = {"mitre_attack": ["T1082"], "author": "Joseliyo Sanchez, @Joseliyo_Jstnk"}
Query = (Process.Path like r"%/ioreg" or Process.CommandLine like r"%ioreg%") and (Process.CommandLine like r"%-l%" or Process.CommandLine like r"%-c%") and (Process.CommandLine like r"%AppleAHCIDiskDriver%" or Process.CommandLine like r"%IOPlatformExpertDevice%" or Process.CommandLine like r"%Oracle%" or Process.CommandLine like r"%Parallels%" or Process.CommandLine like r"%USB Vendor Name%" or Process.CommandLine like r"%VirtualBox%" or Process.CommandLine like r"%VMware%")


[ThreatDetectionRule platform=MacOS]
# Detects when a built-in utility is used to decode and decrypt a payload after a macOS disk image (DMG) is executed. Malware authors may attempt to evade detection and trick users into executing malicious code by encoding and encrypting their payload and placing it in a disk image file. This behavior is consistent with adware or malware families such as Bundlore and Shlayer.
# Author: Tim Rauch (rule), Elastic (idea)
RuleId = 234dc5df-40b5-49d1-bf53-0d44ce778eca
RuleName = Payload Decoded and Decrypted via Built-in Utilities
EventType = Process.Start
Tag = proc-start-payload-decoded-and-decrypted-via-built-in-utilities
RiskScore = 50
Annotation = {"mitre_attack": ["T1059", "T1204", "T1140"], "author": "Tim Rauch (rule), Elastic (idea)"}
Query = Process.Path like r"%/openssl" and Process.CommandLine like r"%/Volumes/%" and Process.CommandLine like r"%enc%" and Process.CommandLine like r"%-base64%" and Process.CommandLine like r"% -d %"


[ThreatDetectionRule platform=MacOS]
# Detect file time attribute change to hide new or changes to existing files
# Author: Igor Fits, Mikhail Larin, oscd.community
RuleId = 88c0f9d8-30a8-4120-bb6b-ebb54abcf2a0
RuleName = File Time Attribute Change
EventType = Process.Start
Tag = proc-start-file-time-attribute-change
RiskScore = 50
Annotation = {"mitre_attack": ["T1070.006"], "author": "Igor Fits, Mikhail Larin, oscd.community"}
Query = Process.Path like r"%/touch" and (Process.CommandLine like r"%-t%" or Process.CommandLine like r"%-acmr%" or Process.CommandLine like r"%-d%" or Process.CommandLine like r"%-r%")


[ThreatDetectionRule platform=MacOS]
# Detects the execution of the nscurl utility in order to download files.
# Author: Daniel Cortez
RuleId = 6d8a7cf1-8085-423b-b87d-7e880faabbdf
RuleName = File Download Via Nscurl - MacOS
EventType = Process.Start
Tag = proc-start-file-download-via-nscurl-macos
RiskScore = 50
Annotation = {"mitre_attack": ["T1105"], "author": "Daniel Cortez"}
Query = Process.Path like r"%/nscurl" and (Process.CommandLine like r"%--download %" or Process.CommandLine like r"%--download-directory %" or Process.CommandLine like r"%--output %" or Process.CommandLine like r"%-dir %" or Process.CommandLine like r"%-dl %" or Process.CommandLine like r"%-ld%" or Process.CommandLine like r"%-o %")


[ThreatDetectionRule platform=MacOS]
# Detects disabling of Time Machine (Apple's automated backup utility software) via the native macOS backup utility "tmutil".
# An attacker can use this to prevent backups from occurring.
# Author: Pratinav Chandra
RuleId = 2c95fa8a-8b8d-4787-afce-7117ceb8e3da
RuleName = Time Machine Backup Disabled Via Tmutil - MacOS
EventType = Process.Start
Tag = proc-start-time-machine-backup-disabled-via-tmutil-macos
RiskScore = 50
Annotation = {"mitre_attack": ["T1490"], "author": "Pratinav Chandra"}
Query = (Process.Path like r"%/tmutil" or Process.CommandLine like r"%tmutil%") and Process.CommandLine like r"%disable%"


[ThreatDetectionRule platform=MacOS]
# Detects abuse of the cron utility to perform task scheduling for initial or recurring execution of malicious code. Detection will focus on crontab jobs uploaded from the tmp folder.
# Author: Alejandro Ortuno, oscd.community
RuleId = 7c3b43d8-d794-47d2-800a-d277715aa460
RuleName = Scheduled Cron Task/Job - MacOs
EventType = Process.Start
Tag = proc-start-scheduled-cron-task/job-macos
RiskScore = 50
Annotation = {"mitre_attack": ["T1053.003"], "author": "Alejandro Ortuno, oscd.community"}
Query = Process.Path like r"%/crontab" and Process.CommandLine like r"%/tmp/%"


[ThreatDetectionRule platform=MacOS]
# Detects the execution of "system_profiler" with specific "Data Types" that have been seen being used by threat actors and malware. It provides system hardware and software configuration information.
# This process is primarily used for system information discovery. However, "system_profiler" can also be used to determine if virtualization software is being run for defense evasion purposes.
# Author: Stephen Lincoln `@slincoln_aiq` (AttackIQ)
RuleId = 4809c683-059b-4935-879d-36835986f8cf
RuleName = System Information Discovery Using System_Profiler
EventType = Process.Start
Tag = proc-start-system-information-discovery-using-system_profiler
RiskScore = 50
Annotation = {"mitre_attack": ["T1082", "T1497.001"], "author": "Stephen Lincoln `@slincoln_aiq` (AttackIQ)"}
Query = (Process.Path like r"%/system\_profiler" or Process.CommandLine like r"%system\_profiler%") and (Process.CommandLine like r"%SPApplicationsDataType%" or Process.CommandLine like r"%SPHardwareDataType%" or Process.CommandLine like r"%SPNetworkDataType%" or Process.CommandLine like r"%SPUSBDataType%")


[ThreatDetectionRule platform=MacOS]
# Detects commandline operations on shell history files
# Author: Mikhail Larin, oscd.community
RuleId = 508a9374-ad52-4789-b568-fc358def2c65
RuleName = Suspicious History File Operations
EventType = Process.Start
Tag = proc-start-suspicious-history-file-operations
RiskScore = 50
Annotation = {"mitre_attack": ["T1552.003"], "author": "Mikhail Larin, oscd.community"}
Query = Process.CommandLine like r"%.bash\_history%" or Process.CommandLine like r"%.zsh\_history%" or Process.CommandLine like r"%.zhistory%" or Process.CommandLine like r"%.history%" or Process.CommandLine like r"%.sh\_history%" or Process.CommandLine like r"%fish\_history%"


[ThreatDetectionRule platform=MacOS]
# Detects the use of "sw_vers" for system information discovery
# Author: Joseliyo Sanchez, @Joseliyo_Jstnk
RuleId = 5de06a6f-673a-4fc0-8d48-bcfe3837b033
RuleName = System Information Discovery Using sw_vers
EventType = Process.Start
Tag = proc-start-system-information-discovery-using-sw_vers
RiskScore = 50
Annotation = {"mitre_attack": ["T1082"], "author": "Joseliyo Sanchez, @Joseliyo_Jstnk"}
Query = Process.Path like r"%/sw\_vers" and (Process.CommandLine like r"%-buildVersion%" or Process.CommandLine like r"%-productName%" or Process.CommandLine like r"%-productVersion%")


[ThreatDetectionRule platform=MacOS]
# Detects the addition of a new file or path exclusion to MacOS Time Machine via the "tmutil" utility.
# An adversary could exclude a path from Time Machine backups to prevent certain files from being backed up.
# Author: Pratinav Chandra
RuleId = 9acf45ed-3a26-4062-bf08-56857613eb52
RuleName = New File Exclusion Added To Time Machine Via Tmutil - MacOS
EventType = Process.Start
Tag = proc-start-new-file-exclusion-added-to-time-machine-via-tmutil-macos
RiskScore = 50
Annotation = {"mitre_attack": ["T1490"], "author": "Pratinav Chandra"}
Query = (Process.Path like r"%/tmutil" or Process.CommandLine like r"%tmutil%") and Process.CommandLine like r"%addexclusion%"


[ThreatDetectionRule platform=MacOS]
# Detects execution of AppleScript of the macOS scripting language AppleScript.
# Author: Alejandro Ortuno, oscd.community
RuleId = 1bc2e6c5-0885-472b-bed6-be5ea8eace55
RuleName = MacOS Scripting Interpreter AppleScript
EventType = Process.Start
Tag = proc-start-macos-scripting-interpreter-applescript
RiskScore = 50
Annotation = {"mitre_attack": ["T1059.002"], "author": "Alejandro Ortuno, oscd.community"}
Query = Process.Path like r"%/osascript" and (Process.CommandLine like r"% -e %" or Process.CommandLine like r"%.scpt%" or Process.CommandLine like r"%.js%")


[ThreatDetectionRule platform=MacOS]
# Detects when the macOS Script Editor utility spawns an unusual child process.
# Author: Tim Rauch (rule), Elastic (idea)
RuleId = 6e4dcdd1-e48b-42f7-b2d8-3b413fc58cb4
RuleName = Suspicious Execution via macOS Script Editor
EventType = Process.Start
Tag = proc-start-suspicious-execution-via-macos-script-editor
RiskScore = 50
Annotation = {"mitre_attack": ["T1566", "T1566.002", "T1059", "T1059.002", "T1204", "T1204.001", "T1553"], "author": "Tim Rauch (rule), Elastic (idea)"}
Query = Parent.Path like r"%/Script Editor" and (Process.Path like r"%/curl" or Process.Path like r"%/bash" or Process.Path like r"%/sh" or Process.Path like r"%/zsh" or Process.Path like r"%/dash" or Process.Path like r"%/fish" or Process.Path like r"%/osascript" or Process.Path like r"%/mktemp" or Process.Path like r"%/chmod" or Process.Path like r"%/php" or Process.Path like r"%/nohup" or Process.Path like r"%/openssl" or Process.Path like r"%/plutil" or Process.Path like r"%/PlistBuddy" or Process.Path like r"%/xattr" or Process.Path like r"%/sqlite" or Process.Path like r"%/funzip" or Process.Path like r"%/popen" or Process.Path like r"%python%" or Process.Path like r"%perl%")
GenericProperty1 = Parent.Path


[ThreatDetectionRule platform=MacOS]
# Detects creation of a hidden user account on macOS (UserID < 500) or with IsHidden option
# Author: Daniil Yugoslavskiy, oscd.community
RuleId = b22a5b36-2431-493a-8be1-0bae56c28ef3
RuleName = Hidden User Creation
EventType = Process.Start
Tag = proc-start-hidden-user-creation
RiskScore = 50
Annotation = {"mitre_attack": ["T1564.002"], "author": "Daniil Yugoslavskiy, oscd.community"}
Query = Process.Path like r"%/dscl" and Process.CommandLine like r"%create%" and Process.CommandLine like r"%UniqueID%" and Process.CommandLine regex "([0-9]|[1-9][0-9]|[1-4][0-9]{2})" or Process.Path like r"%/dscl" and Process.CommandLine like r"%create%" and Process.CommandLine like r"%IsHidden%" and (Process.CommandLine like r"%true%" or Process.CommandLine like r"%yes%" or Process.CommandLine like r"%1%")


[ThreatDetectionRule platform=MacOS]
# Identifies the execution traces of the XCSSET malware. XCSSET is a macOS trojan that primarily spreads via Xcode projects and maliciously modifies applications. Infected users are also vulnerable to having their credentials, accounts, and other vital data stolen.
# Author: Tim Rauch (rule), Elastic (idea)
RuleId = 47d65ac0-c06f-4ba2-a2e3-d263139d0f51
RuleName = Potential XCSSET Malware Infection
EventType = Process.Start
Tag = proc-start-potential-xcsset-malware-infection
RiskScore = 50
Annotation = {"author": "Tim Rauch (rule), Elastic (idea)"}
Query = Parent.Path like r"%/bash" and Process.Path like r"%/curl" and (Process.CommandLine like r"%/sys/log.php%" or Process.CommandLine like r"%/sys/prepod.php%" or Process.CommandLine like r"%/sys/bin/Pods%") and Process.CommandLine like r"%https://%" or Parent.Path like r"%/bash" and Process.Path like r"%/osacompile" and Process.CommandLine like r"%/Users/%" and Process.CommandLine like r"%/Library/Group Containers/%" or Parent.Path like r"%/bash" and Process.Path like r"%/plutil" and Process.CommandLine like r"%LSUIElement%" and Process.CommandLine like r"%/Users/%" and Process.CommandLine like r"%/Library/Group Containers/%" or Process.Path like r"%/zip" and Process.CommandLine like r"%-r%" and Process.CommandLine like r"%/Users/%" and Process.CommandLine like r"%/Library/Group Containers/%"
GenericProperty1 = Parent.Path


[ThreatDetectionRule platform=MacOS]
# Detects the execution of "sysctl" with specific arguments that have been used by threat actors and malware. It provides system hardware information.
# This process is primarily used to detect and avoid virtualization and analysis environments.
# Author: Pratinav Chandra
RuleId = 6ff08e55-ea53-4f27-94a1-eff92e6d9d5c
RuleName = System Information Discovery Via Sysctl - MacOS
EventType = Process.Start
Tag = proc-start-system-information-discovery-via-sysctl-macos
RiskScore = 50
Annotation = {"mitre_attack": ["T1497.001", "T1082"], "author": "Pratinav Chandra"}
Query = (Process.Path like r"%/sysctl" or Process.CommandLine like r"%sysctl%") and (Process.CommandLine like r"%hw.%" or Process.CommandLine like r"%kern.%" or Process.CommandLine like r"%machdep.%")


[ThreatDetectionRule platform=MacOS]
# Detects usage of system utilities (only grep for now) to discover security software discovery
# Author: Daniil Yugoslavskiy, oscd.community
RuleId = 0ed75b9c-c73b-424d-9e7d-496cd565fbe0
RuleName = Security Software Discovery - MacOs
EventType = Process.Start
Tag = proc-start-security-software-discovery-macos
RiskScore = 50
Annotation = {"mitre_attack": ["T1518.001"], "author": "Daniil Yugoslavskiy, oscd.community"}
Query = Process.Path == "/usr/bin/grep" and (Process.CommandLine like r"%nessusd%" or Process.CommandLine like r"%santad%" or Process.CommandLine like r"%CbDefense%" or Process.CommandLine like r"%falcond%" or Process.CommandLine like r"%td-agent%" or Process.CommandLine like r"%packetbeat%" or Process.CommandLine like r"%filebeat%" or Process.CommandLine like r"%auditbeat%" or Process.CommandLine like r"%osqueryd%" or Process.CommandLine like r"%BlockBlock%" or Process.CommandLine like r"%LuLu%" or Process.CommandLine like r"%Little%" and Process.CommandLine like r"%Snitch%")


[ThreatDetectionRule platform=MacOS]
# Detects the execution of the hdiutil utility in order to mount disk images.
# Author: Omar Khaled (@beacon_exe)
RuleId = bf241472-f014-4f01-a869-96f99330ca8c
RuleName = Disk Image Mounting Via Hdiutil - MacOS
EventType = Process.Start
Tag = proc-start-disk-image-mounting-via-hdiutil-macos
RiskScore = 50
Annotation = {"mitre_attack": ["T1566.001", "T1560.001"], "author": "Omar Khaled (@beacon_exe)"}
Query = Process.Path like r"%/hdiutil" and (Process.CommandLine like r"%attach %" or Process.CommandLine like r"%mount %")


[ThreatDetectionRule platform=MacOS]
# Detects the execution of programs as Launch Agents or Launch Daemons using launchctl on macOS.
# Author: Pratinav Chandra
RuleId = ae9d710f-dcd1-4f75-a0a5-93a73b5dda0e
RuleName = Launch Agent/Daemon Execution Via Launchctl
EventType = Process.Start
Tag = proc-start-launch-agent/daemon-execution-via-launchctl
RiskScore = 50
Annotation = {"mitre_attack": ["T1569.001", "T1543.001", "T1543.004"], "author": "Pratinav Chandra"}
Query = Process.Path like r"%/launchctl" and (Process.CommandLine like r"%submit%" or Process.CommandLine like r"%load%" or Process.CommandLine like r"%start%")


[ThreatDetectionRule platform=MacOS]
# Detects attempts to create and add an account to the admin group via "dscl"
# Author: Sohan G (D4rkCiph3r)
RuleId = b743623c-2776-40e0-87b1-682b975d0ca5
RuleName = User Added To Admin Group Via Dscl
EventType = Process.Start
Tag = proc-start-user-added-to-admin-group-via-dscl
RiskScore = 50
Annotation = {"mitre_attack": ["T1078.003"], "author": "Sohan G (D4rkCiph3r)"}
Query = Process.Path like r"%/dscl" and Process.CommandLine like r"% -append %" and Process.CommandLine like r"% /Groups/admin %" and Process.CommandLine like r"% GroupMembership %"


[ThreatDetectionRule platform=MacOS]
# Detects deletion attempts of MacOS Time Machine backups via the native backup utility "tmutil".
# An adversary may perform this action before launching a ransonware attack to prevent the victim from restoring their files.
# Author: Pratinav Chandra
RuleId = 452df256-da78-427a-866f-49fa04417d74
RuleName = Time Machine Backup Deletion Attempt Via Tmutil - MacOS
EventType = Process.Start
Tag = proc-start-time-machine-backup-deletion-attempt-via-tmutil-macos
RiskScore = 50
Annotation = {"mitre_attack": ["T1490"], "author": "Pratinav Chandra"}
Query = (Process.Path like r"%/tmutil" or Process.CommandLine like r"%tmutil%") and Process.CommandLine like r"%delete%"


[ThreatDetectionRule platform=MacOS]
# Detects additions to the Emond Launch Daemon that adversaries may use to gain persistence and elevate privileges.
# Author: Alejandro Ortuno, oscd.community
RuleId = 23c43900-e732-45a4-8354-63e4a6c187ce
RuleName = MacOS Emond Launch Daemon
EventType = File.Create
Tag = macos-emond-launch-daemon
RiskScore = 50
Annotation = {"mitre_attack": ["T1546.014"], "author": "Alejandro Ortuno, oscd.community"}
Query = File.Path like r"%/etc/emond.d/rules/%" and File.Path like r"%.plist" or File.Path like r"%/private/var/db/emondClients/%"
GenericProperty1 = File.Path


[ThreatDetectionRule platform=MacOS]
# Detects the execution of the hdiutil utility in order to create a disk image.
# Author: Omar Khaled (@beacon_exe)
RuleId = 1cf98dc2-fcb0-47c9-8aea-654c9284d1ae
RuleName = Disk Image Creation Via Hdiutil - MacOS
EventType = Process.Start
Tag = proc-start-disk-image-creation-via-hdiutil-macos
RiskScore = 50
Annotation = {"author": "Omar Khaled (@beacon_exe)"}
Query = Process.Path like r"%/hdiutil" and Process.CommandLine like r"%create%"


[ThreatDetectionRule platform=MacOS]
# Detects disabling security tools
# Author: Daniil Yugoslavskiy, oscd.community
RuleId = ff39f1a6-84ac-476f-a1af-37fcdf53d7c0
RuleName = Disable Security Tools
EventType = Process.Start
Tag = proc-start-disable-security-tools
RiskScore = 50
Annotation = {"mitre_attack": ["T1562.001"], "author": "Daniil Yugoslavskiy, oscd.community"}
Query = Process.Path == "/bin/launchctl" and Process.CommandLine like r"%unload%" and (Process.CommandLine like r"%com.objective-see.lulu.plist%" or Process.CommandLine like r"%com.objective-see.blockblock.plist%" or Process.CommandLine like r"%com.google.santad.plist%" or Process.CommandLine like r"%com.carbonblack.defense.daemon.plist%" or Process.CommandLine like r"%com.carbonblack.daemon.plist%" or Process.CommandLine like r"%at.obdev.littlesnitchd.plist%" or Process.CommandLine like r"%com.tenablesecurity.nessusagent.plist%" or Process.CommandLine like r"%com.opendns.osx.RoamingClientConfigUpdater.plist%" or Process.CommandLine like r"%com.crowdstrike.falcond.plist%" or Process.CommandLine like r"%com.crowdstrike.userdaemon.plist%" or Process.CommandLine like r"%osquery%" or Process.CommandLine like r"%filebeat%" or Process.CommandLine like r"%auditbeat%" or Process.CommandLine like r"%packetbeat%" or Process.CommandLine like r"%td-agent%") or Process.Path == "/usr/sbin/spctl" and Process.CommandLine like r"%disable%"


[ThreatDetectionRule platform=MacOS]
# Detects usage of "find" binary in a suspicious manner to perform discovery
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = 85de3a19-b675-4a51-bfc6-b11a5186c971
RuleName = Potential Discovery Activity Using Find - MacOS
EventType = Process.Start
Tag = proc-start-potential-discovery-activity-using-find-macos
RiskScore = 50
Annotation = {"mitre_attack": ["T1083"], "author": "Nasreddine Bencherchali (Nextron Systems)"}
Query = Process.Path like r"%/find" and (Process.CommandLine like r"%-perm -4000%" or Process.CommandLine like r"%-perm -2000%" or Process.CommandLine like r"%-perm 0777%" or Process.CommandLine like r"%-perm -222%" or Process.CommandLine like r"%-perm -o w%" or Process.CommandLine like r"%-perm -o x%" or Process.CommandLine like r"%-perm -u=s%" or Process.CommandLine like r"%-perm -g=s%")


[ThreatDetectionRule platform=MacOS]
# Detects the execution of the "chflags" utility with the "hidden" flag, in order to hide files on MacOS.
# When a file or directory has this hidden flag set, it becomes invisible to the default file listing commands and in graphical file browsers.
# Author: Omar Khaled (@beacon_exe)
RuleId = 3b2c1059-ae5f-40b6-b5d4-6106d3ac20fe
RuleName = Hidden Flag Set On File/Directory Via Chflags - MacOS
EventType = Process.Start
Tag = proc-start-hidden-flag-set-on-file/directory-via-chflags-macos
RiskScore = 50
Annotation = {"mitre_attack": ["T1218", "T1564.004", "T1552.001", "T1105"], "author": "Omar Khaled (@beacon_exe)"}
Query = Process.Path like r"%/chflags" and Process.CommandLine like r"%hidden %"


[ThreatDetectionRule platform=MacOS]
# Detects passwords dumps from Keychain
# Author: Tim Ismilyaev, oscd.community, Florian Roth (Nextron Systems)
RuleId = b120b587-a4c2-4b94-875d-99c9807d6955
RuleName = Credentials from Password Stores - Keychain
EventType = Process.Start
Tag = proc-start-credentials-from-password-stores-keychain
RiskScore = 50
Annotation = {"mitre_attack": ["T1555.001"], "author": "Tim Ismilyaev, oscd.community, Florian Roth (Nextron Systems)"}
Query = Process.Path == "/usr/bin/security" and (Process.CommandLine like r"%find-certificate%" or Process.CommandLine like r"% export %") or Process.CommandLine like r"% dump-keychain %" or Process.CommandLine like r"% login-keychain %"


[ThreatDetectionRule platform=MacOS]
# Detects the execution of suspicious child processes from macOS installer package parent process. This includes osascript, JXA, curl and wget amongst other interpreters
# Author: Sohan G (D4rkCiph3r)
RuleId = e0cfaecd-602d-41af-988d-f6ccebb2af26
RuleName = Suspicious Installer Package Child Process
EventType = Process.Start
Tag = proc-start-suspicious-installer-package-child-process
RiskScore = 50
Annotation = {"mitre_attack": ["T1059", "T1059.007", "T1071", "T1071.001"], "author": "Sohan G (D4rkCiph3r)"}
Query = (Parent.Path like r"%/package\_script\_service" or Parent.Path like r"%/installer") and (Process.Path like r"%/sh" or Process.Path like r"%/bash" or Process.Path like r"%/dash" or Process.Path like r"%/python" or Process.Path like r"%/ruby" or Process.Path like r"%/perl" or Process.Path like r"%/php" or Process.Path like r"%/javascript" or Process.Path like r"%/osascript" or Process.Path like r"%/tclsh" or Process.Path like r"%/curl" or Process.Path like r"%/wget") and (Process.CommandLine like r"%preinstall%" or Process.CommandLine like r"%postinstall%")
GenericProperty1 = Parent.Path


[ThreatDetectionRule platform=MacOS]
# Detects potential in-memory downloading and compiling of applets using curl and osacompile as seen used by XCSSET malware
# Author: Sohan G (D4rkCiph3r), Red Canary (idea)
RuleId = 13db8d2e-7723-4c2c-93c1-a4d36994f7ef
RuleName = Potential In-Memory Download And Compile Of Payloads
EventType = Process.Start
Tag = proc-start-potential-in-memory-download-and-compile-of-payloads
RiskScore = 50
Annotation = {"mitre_attack": ["T1059.007", "T1105"], "author": "Sohan G (D4rkCiph3r), Red Canary (idea)"}
Query = Process.CommandLine like r"%osacompile%" and Process.CommandLine like r"%curl%"


[ThreatDetectionRule platform=MacOS]
# Detects suspicious child processes spawned from browsers. This could be a result of a potential web browser exploitation.
# Author: Sohan G (D4rkCiph3r)
RuleId = 0250638a-2b28-4541-86fc-ea4c558fa0c6
RuleName = Suspicious Browser Child Process - MacOS
EventType = Process.Start
Tag = proc-start-suspicious-browser-child-process-macos
RiskScore = 50
Annotation = {"mitre_attack": ["T1189", "T1203", "T1059"], "author": "Sohan G (D4rkCiph3r)"}
Query = (Parent.Path like r"%com.apple.WebKit.WebContent%" or Parent.Path like r"%firefox%" or Parent.Path like r"%Google Chrome Helper%" or Parent.Path like r"%Google Chrome%" or Parent.Path like r"%Microsoft Edge%" or Parent.Path like r"%Opera%" or Parent.Path like r"%Safari%" or Parent.Path like r"%Tor Browser%") and (Process.Path like r"%/bash" or Process.Path like r"%/curl" or Process.Path like r"%/dash" or Process.Path like r"%/ksh" or Process.Path like r"%/osascript" or Process.Path like r"%/perl" or Process.Path like r"%/php" or Process.Path like r"%/pwsh" or Process.Path like r"%/python" or Process.Path like r"%/sh" or Process.Path like r"%/tcsh" or Process.Path like r"%/wget" or Process.Path like r"%/zsh") and not (Process.CommandLine like r"%--defaults-torrc%" or Process.CommandLine like r"%/Library/Application Support/Microsoft/MAU%/Microsoft AutoUpdate.app/Contents/MacOS/msupdate%" or (Parent.Path like r"%Google Chrome Helper%" or Parent.Path like r"%Google Chrome%") and (Process.CommandLine like r"%/Volumes/Google Chrome/Google Chrome.app/Contents/Frameworks/%/Resources/install.sh%" or Process.CommandLine like r"%/Applications/Google Chrome.app/Contents/Frameworks/Google Chrome Framework.framework/%/Resources/keystone\_promote\_preflight.sh%" or Process.CommandLine like r"%/Applications/Google Chrome.app/Contents/Frameworks/Google Chrome Framework.framework/%/Resources/keystone\_promote\_postflight.sh%") or Parent.Path like r"%Microsoft Edge%" and (Process.CommandLine like r"%IOPlatformExpertDevice%" or Process.CommandLine like r"%hw.model%") or (Parent.Path like r"%Google Chrome Helper%" or Parent.Path like r"%Google Chrome%") and Process.CommandLine like r"%/Users/%" and Process.CommandLine like r"%/Library/Application Support/Google/Chrome/recovery/%" and Process.CommandLine like r"%/ChromeRecovery%") and not (isnull(Process.CommandLine) or Process.CommandLine == "")
GenericProperty1 = Parent.Path


[ThreatDetectionRule platform=MacOS]
# Detects attempts to create and add an account to the admin group via "sysadminctl"
# Author: Sohan G (D4rkCiph3r)
RuleId = 652c098d-dc11-4ba6-8566-c20e89042f2b
RuleName = User Added To Admin Group Via Sysadminctl
EventType = Process.Start
Tag = proc-start-user-added-to-admin-group-via-sysadminctl
RiskScore = 50
Annotation = {"mitre_attack": ["T1078.003"], "author": "Sohan G (D4rkCiph3r)"}
Query = Process.Path like r"%/sysadminctl" and Process.CommandLine like r"% -addUser %" and Process.CommandLine like r"% -admin %"


[ThreatDetectionRule platform=MacOS]
# Detects attempts to enable the root account via "dsenableroot"
# Author: Sohan G (D4rkCiph3r)
RuleId = 821bcf4d-46c7-4b87-bc57-9509d3ba7c11
RuleName = Root Account Enable Via Dsenableroot
EventType = Process.Start
Tag = proc-start-root-account-enable-via-dsenableroot
RiskScore = 50
Annotation = {"mitre_attack": ["T1078", "T1078.001", "T1078.003"], "author": "Sohan G (D4rkCiph3r)"}
Query = Process.Path like r"%/dsenableroot" and not Process.CommandLine like r"% -d %"


[ThreatDetectionRule platform=MacOS]
# Detects potential suspicious child processes of "jamf". Could be a sign of potential abuse of Jamf as a C2 server as seen by Typhon MythicAgent.
# Author: Nasreddine Bencherchali (Nextron Systems)
RuleId = 2316929c-01aa-438c-970f-099145ab1ee6
RuleName = JAMF MDM Potential Suspicious Child Process
EventType = Process.Start
Tag = proc-start-jamf-mdm-potential-suspicious-child-process
RiskScore = 50
Annotation = {"author": "Nasreddine Bencherchali (Nextron Systems)"}
Query = Parent.Path like r"%/jamf" and (Process.Path like r"%/bash" or Process.Path like r"%/sh")
GenericProperty1 = Parent.Path


[ThreatDetectionRule platform=MacOS]
# Detects the use of csrutil to disable the Configure System Integrity Protection (SIP). This technique is used in post-exploit scenarios.
# Author: Joseliyo Sanchez, @Joseliyo_Jstnk
RuleId = 3603f18a-ec15-43a1-9af2-d196c8a7fec6
RuleName = System Integrity Protection (SIP) Disabled
EventType = Process.Start
Tag = proc-start-system-integrity-protection-(sip)-disabled
RiskScore = 50
Annotation = {"mitre_attack": ["T1518.001"], "author": "Joseliyo Sanchez, @Joseliyo_Jstnk"}
Query = Process.Path like r"%/csrutil" and Process.CommandLine like r"%disable%"


[ThreatDetectionRule platform=MacOS]
# Detects attempts to create and/or add an account to the admin group, thus granting admin privileges.
# Author: Sohan G (D4rkCiph3r)
RuleId = 5d0fdb62-f225-42fb-8402-3dfe64da468a
RuleName = User Added To Admin Group Via DseditGroup
EventType = Process.Start
Tag = proc-start-user-added-to-admin-group-via-dseditgroup
RiskScore = 50
Annotation = {"mitre_attack": ["T1078.003"], "author": "Sohan G (D4rkCiph3r)"}
Query = Process.Path like r"%/dseditgroup" and Process.CommandLine like r"% -o edit %" and Process.CommandLine like r"% -a %" and Process.CommandLine like r"% -t user%" and Process.CommandLine like r"%admin%"


[ThreatDetectionRule platform=MacOS]
# Detects when a user manipulates with Firmward Password on MacOS. NOTE - this command has been disabled on silicon-based apple computers.
# Author: Austin Songer @austinsonger
RuleId = 7ed2c9f7-c59d-4c82-a7e2-f859aa676099
RuleName = Suspicious MacOS Firmware Activity
EventType = Process.Start
Tag = proc-start-suspicious-macos-firmware-activity
RiskScore = 50
Annotation = {"author": "Austin Songer @austinsonger"}
Query = Process.Path == "/usr/sbin/firmwarepasswd" and (Process.CommandLine like r"%setpasswd%" or Process.CommandLine like r"%full%" or Process.CommandLine like r"%delete%" or Process.CommandLine like r"%check%")

